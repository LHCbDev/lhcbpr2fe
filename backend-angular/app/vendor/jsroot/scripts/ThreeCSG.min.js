(function(a){if(typeof define==="function"&&define.amd){define(["threejs"],a)}else{if(typeof THREE=="undefined"){throw new Error("THREE is not defined","ThreeCSG.js")}ThreeBSP={};a(THREE,ThreeBSP)}}(function(e,g){var b=0.00001,d=0,c=1,f=2,a=3;if(!g){g={}}g.Geometry=function(r,l,h){var o,u,q,p,t,s=[],v;if(r instanceof e.Geometry){this.matrix=null}else{if(r instanceof e.Mesh){r.updateMatrix();l=this.matrix=r.matrix.clone();r=r.geometry}else{if(r instanceof g.Node){this.tree=r;this.matrix=null;return this}else{if(r instanceof e.BufferGeometry){var j=r.getAttribute("position").array,m=r.getAttribute("normal").array;for(var o=0;o<j.length;o+=9){t=new g.Polygon;p=new g.Vertex(j[o],j[o+1],j[o+2],m[o],m[o+1],m[o+2]);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=new g.Vertex(j[o+3],j[o+4],j[o+5],m[o+3],m[o+4],m[o+5]);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=new g.Vertex(j[o+6],j[o+7],j[o+8],m[o+6],m[o+7],m[o+8]);if(l){p.applyMatrix4(l)}t.vertices.push(p);t.calculateProperties();s.push(t)}this.tree=new g.Node(s,h);if(h!==undefined){this.maxid=this.tree.maxnodeid}return this}else{if(r.polygons&&(r.polygons[0] instanceof g.Polygon)){s=r.polygons;for(var o=0;o<s.length;++o){var t=s[o];if(l){for(var k=0;k<t.vertices.length;++k){t.vertices[k].applyMatrix4(l)}}t.calculateProperties()}this.tree=new g.Node(s,h);if(h!==undefined){this.maxid=this.tree.maxnodeid}return this}else{throw"ThreeBSP: Given geometry is unsupported"}}}}}for(o=0,u=r.faces.length;o<u;++o){q=r.faces[o];t=new g.Polygon;if(q instanceof e.Face3){p=r.vertices[q.a];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[0].x,q.vertexNormals[0].y,q.vertexNormals[0].z);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=r.vertices[q.b];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[1].x,q.vertexNormals[1].y,q.vertexNormals[1].z);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=r.vertices[q.c];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[2].x,q.vertexNormals[2].y,q.vertexNormals[2].z);if(l){p.applyMatrix4(l)}t.vertices.push(p)}else{if(typeof e.Face4){p=r.vertices[q.a];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[0].x,q.vertexNormals[0].y,q.vertexNormals[0].z);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=r.vertices[q.b];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[1].x,q.vertexNormals[1].y,q.vertexNormals[1].z);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=r.vertices[q.c];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[2].x,q.vertexNormals[2].y,q.vertexNormals[2].z);if(l){p.applyMatrix4(l)}t.vertices.push(p);p=r.vertices[q.d];p=new g.Vertex(p.x,p.y,p.z,q.vertexNormals[3].x,q.vertexNormals[3].y,q.vertexNormals[3].z);if(l){p.applyMatrix4(l)}t.vertices.push(p)}else{throw"Invalid face type at index "+o}}t.calculateProperties();s.push(t)}this.tree=new g.Node(s,h);if(h!==undefined){this.maxid=this.tree.maxnodeid}};g.Geometry.prototype.subtract=function(i){var j=this.tree.clone(),h=i.tree.clone();j.invert();j.clipTo(h);h.clipTo(j);h.invert();h.clipTo(j);h.invert();j.build(h.allPolygons());j.invert();j=new g.Geometry(j);j.matrix=this.matrix;return j};g.Geometry.prototype.union=function(i){var j=this.tree.clone(),h=i.tree.clone();j.clipTo(h);h.clipTo(j);h.invert();h.clipTo(j);h.invert();j.build(h.allPolygons());j=new g.Geometry(j);j.matrix=this.matrix;return j};g.Geometry.prototype.intersect=function(i){var j=this.tree.clone(),h=i.tree.clone();j.invert();h.clipTo(j);h.invert();j.clipTo(h);h.clipTo(j);j.build(h.allPolygons());j.invert();j=new g.Geometry(j);j.matrix=this.matrix;return j};g.Geometry.prototype.tryToCompress=function(s){if(this.maxid===undefined){return}var o=[],m,j,q=0,i,r=s.length,h,u,t,l,k;for(i=0;i<r;++i){h=s[i];if(h.id===undefined){continue}if(o[h.id]===undefined){o[h.id]=[]}o[h.id].push(h)}for(i=0;i<o.length;++i){m=o[i];if(m===undefined){continue}r=m.length;j=(r>1);while(j){j=false;for(l=0;l<r-1;++l){u=m[l];if(!u||!u.parent){continue}for(k=l+1;k<r;++k){t=m[k];if(t&&(u.parent===t.parent)&&(u.nsign===t.nsign)){if(u.nsign!==u.parent.nsign){u.parent.flip()}q++;m[l]=u.parent;m[k]=null;if(u.parent.vertices.length<3){console.log("something wrong with parent")}j=true;break}}}}}if(q>0){s.splice(0,s.length);for(i=0;i<o.length;++i){m=o[i];if(m!==undefined){for(l=0,r=m.length;l<r;++l){if(m[l]){s.push(m[l])}}}}}};g.Geometry.prototype.direct_subtract=function(i){var j=this.tree,h=i.tree;j.invert();j.clipTo(h);h.clipTo(j);h.invert();h.clipTo(j);h.invert();j.build(h.collectPolygons([]));j.invert();return this};g.Geometry.prototype.direct_union=function(i){var j=this.tree,h=i.tree;j.clipTo(h);h.clipTo(j);h.invert();h.clipTo(j);h.invert();j.build(h.collectPolygons([]));return this};g.Geometry.prototype.direct_intersect=function(i){var j=this.tree,h=i.tree;j.invert();h.clipTo(j);h.invert();j.clipTo(h);h.clipTo(j);j.build(h.collectPolygons([]));j.invert();return this};g.Geometry.prototype.toGeometry=function(){var m,l,u=this.matrix?new e.Matrix4().getInverse(this.matrix):null,r=new e.Geometry(),v=this.tree.collectPolygons([]),k=v.length,t,h,w={},s,q,p,n,o;for(m=0;m<k;++m){t=v[m];h=t.vertices.length;for(l=2;l<h;++l){n=t.vertices[0];n=new e.Vector3(n.x,n.y,n.z);if(u){n.applyMatrix4(u)}if(typeof w[n.x+","+n.y+","+n.z]!=="undefined"){s=w[n.x+","+n.y+","+n.z]}else{r.vertices.push(n);s=w[n.x+","+n.y+","+n.z]=r.vertices.length-1}n=t.vertices[l-1];n=new e.Vector3(n.x,n.y,n.z);if(u){n.applyMatrix4(u)}if(typeof w[n.x+","+n.y+","+n.z]!=="undefined"){q=w[n.x+","+n.y+","+n.z]}else{r.vertices.push(n);q=w[n.x+","+n.y+","+n.z]=r.vertices.length-1}n=t.vertices[l];n=new e.Vector3(n.x,n.y,n.z);if(u){n.applyMatrix4(u)}if(typeof w[n.x+","+n.y+","+n.z]!=="undefined"){p=w[n.x+","+n.y+","+n.z]}else{r.vertices.push(n);p=w[n.x+","+n.y+","+n.z]=r.vertices.length-1}o=new e.Face3(s,q,p,new e.Vector3(t.normal.x,t.normal.y,t.normal.z));r.faces.push(o)}}return r};g.Geometry.prototype.toPolygons=function(){var h=this.tree.collectPolygons([]);this.tryToCompress(h);for(var j=0;j<h.length;++j){delete h[j].id;delete h[j].parent}return h};g.Geometry.prototype.toBufferGeometry=function(){var l,k,s=this.toPolygons(),h=s.length,t=0;for(l=0;l<h;++l){t+=(s[l].vertices.length-2)*9}var m=new Float32Array(t),n=new Float32Array(t),p=0,r;function q(i){m[p]=i.x;m[p+1]=i.y;m[p+2]=i.z;n[p]=r.nsign*i.nx;n[p+1]=r.nsign*i.ny;n[p+2]=r.nsign*i.nz;p+=3}for(l=0;l<h;++l){r=s[l];for(k=2;k<r.vertices.length;++k){q(r.vertices[0]);q(r.vertices[k-1]);q(r.vertices[k])}}var o=new e.BufferGeometry();o.addAttribute("position",new e.BufferAttribute(m,3));o.addAttribute("normal",new e.BufferAttribute(n,3));return o};g.Geometry.prototype.toMesh=function(h){var i=this.toGeometry(),j=new e.Mesh(i,h);if(this.matrix){j.position.setFromMatrixPosition(this.matrix);j.rotation.setFromRotationMatrix(this.matrix)}return j};g.Polygon=function(i,j,h){if(!(i instanceof Array)){i=[]}this.vertices=i;this.nsign=1;if(i.length>0){this.calculateProperties()}else{this.normal=this.w=undefined}};g.Polygon.prototype.copyProperties=function(i,h){this.normal=i.normal;this.w=i.w;this.nsign=i.nsign;if(h&&(i.id!==undefined)){this.id=i.id;this.parent=i}return this};g.Polygon.prototype.calculateProperties=function(){if(this.normal){return}var i=this.vertices[0],h=this.vertices[1],j=this.vertices[2];this.nsign=1;this.normal=h.clone().subtract(i).cross(j.clone().subtract(i)).normalize();this.w=this.normal.clone().dot(i);return this};g.Polygon.prototype.clone=function(){var k,h,j=new g.Polygon;for(k=0,h=this.vertices.length;k<h;++k){j.vertices.push(this.vertices[k].clone())}return j.copyProperties(this)};g.Polygon.prototype.flip=function(){this.nsign*=-1;this.vertices.reverse();return this};g.Polygon.prototype.classifyVertex=function(h){var i=this.nsign*(this.normal.dot(h)-this.w);if(i<-b){return f}else{if(i>b){return c}else{return d}}};g.Polygon.prototype.classifySide=function(l){var k,m,n=0,j=0,h=l.vertices.length;for(k=0;k<h;++k){m=this.classifyVertex(l.vertices[k]);if(m===c){++n}else{if(m===f){++j}}}if(n>0&&j===0){return c}else{if(n===0&&j>0){return f}else{if(n===0&&j===0){return d}else{return a}}}};g.Polygon.prototype.splitPolygon=function(p,A,n,m,r){var h=this.classifySide(p);if(h===d){((this.nsign*p.nsign*this.normal.dot(p.normal)>0)?A:n).push(p)}else{if(h===c){m.push(p)}else{if(h===f){r.push(p)}else{var E=p.vertices.length,w=this.normal.x,u=this.normal.y,s=this.normal.z,y,x,l,k,D,C,q,o,z=[],B=[];for(y=0;y<E;++y){x=(y+1)%E;D=p.vertices[y];C=p.vertices[x];l=this.classifyVertex(D);k=this.classifyVertex(C);if(l!=f){z.push(D)}if(l!=c){B.push(D)}if((l|k)===a){q=(this.w-(w*D.x+u*D.y+s*D.z))/(w*(C.x-D.x)+u*(C.y-D.y)+s*(C.z-D.z));o=D.interpolate(C,q);z.push(o);B.push(o)}}if(z.length>=3){m.push(new g.Polygon(z).copyProperties(p,true))}if(B.length>=3){r.push(new g.Polygon(B).copyProperties(p,true))}}}}};g.Vertex=function(i,m,k,h,l,j){this.x=i;this.y=m;this.z=k;this.nx=h;this.ny=l;this.nz=j};g.Vertex.prototype.setnormal=function(h,j,i){this.nx=h;this.ny=j;this.nz=i};g.Vertex.prototype.clone=function(){return new g.Vertex(this.x,this.y,this.z,this.nx,this.ny,this.nz)};g.Vertex.prototype.add=function(h){this.x+=h.x;this.y+=h.y;this.z+=h.z;return this};g.Vertex.prototype.subtract=function(h){this.x-=h.x;this.y-=h.y;this.z-=h.z;return this};g.Vertex.prototype.multiplyScalar=function(h){this.x*=h;this.y*=h;this.z*=h;return this};g.Vertex.prototype.cross=function(i){var h=this.x,k=this.y,j=this.z;this.x=k*i.z-j*i.y;this.y=j*i.x-h*i.z;this.z=h*i.y-k*i.x;return this};g.Vertex.prototype.normalize=function(){var h=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);this.x/=h;this.y/=h;this.z/=h;return this};g.Vertex.prototype.dot=function(h){return this.x*h.x+this.y*h.y+this.z*h.z};g.Vertex.prototype.diff=function(l){var k=(this.x-l.x),i=(this.y-l.y),h=(this.z-l.z),j=this.x*this.x+this.y*this.y+this.z*this.z;return(k*k+i*i+h*h)/(j>0?j:1e-10)};g.Vertex.prototype.interpolate=function(h,i){var j=1-i;return new g.Vertex(this.x*j+h.x*i,this.y*j+h.y*i,this.z*j+h.z*i,this.nx*j+h.nx*i,this.ny*j+h.ny*i,this.nz*j+h.nz*i)};g.Vertex.prototype.applyMatrix4=function(i){var h=this.x,l=this.y,k=this.z,j=i.elements;this.x=j[0]*h+j[4]*l+j[8]*k+j[12];this.y=j[1]*h+j[5]*l+j[9]*k+j[13];this.z=j[2]*h+j[6]*l+j[10]*k+j[14];h=this.nx;l=this.ny;k=this.nz;this.nx=j[0]*h+j[4]*l+j[8]*k;this.ny=j[1]*h+j[5]*l+j[9]*k;this.nz=j[2]*h+j[6]*l+j[10]*k;return this};g.Node=function(h,m){var k,n,l=[],j=[];this.polygons=[];this.front=this.back=undefined;if(!(h instanceof Array)||h.length===0){return}this.divider=h[0].clone();for(k=0,n=h.length;k<n;++k){if(m!==undefined){h[k].id=m++;delete h[k].parent}this.divider.splitPolygon(h[k],this.polygons,this.polygons,l,j)}if(m!==undefined){this.maxnodeid=m}if(l.length>0){this.front=new g.Node(l)}if(j.length>0){this.back=new g.Node(j)}};g.Node.isConvex=function(k){var m,l,h=k.length;for(m=0;m<h;++m){for(l=0;l<h;++l){if(m!==l&&k[m].classifySide(k[l])!==f){return false}}}return true};g.Node.prototype.build=function(h){var k,m,l=[],j=[];if(!this.divider){this.divider=h[0].clone()}for(k=0,m=h.length;k<m;++k){this.divider.splitPolygon(h[k],this.polygons,this.polygons,l,j)}if(l.length>0){if(!this.front){this.front=new g.Node()}this.front.build(l)}if(j.length>0){if(!this.back){this.back=new g.Node()}this.back.build(j)}};g.Node.prototype.collectPolygons=function(j){var k,h=this.polygons.length;for(k=0;k<h;++k){j.push(this.polygons[k])}if(this.front){this.front.collectPolygons(j)}if(this.back){this.back.collectPolygons(j)}return j};g.Node.prototype.allPolygons=function(){var h=this.polygons.slice();if(this.front){h=h.concat(this.front.allPolygons())}if(this.back){h=h.concat(this.back.allPolygons())}return h};g.Node.prototype.numPolygons=function(){var h=this.polygons.length;if(this.front){h+=this.front.numPolygons()}if(this.back){h+=this.back.numPolygons()}return h};g.Node.prototype.clone=function(){var h=new g.Node();h.divider=this.divider.clone();h.polygons=this.polygons.map(function(i){return i.clone()});h.front=this.front&&this.front.clone();h.back=this.back&&this.back.clone();return h};g.Node.prototype.invert=function(){var j,k,h;for(j=0,k=this.polygons.length;j<k;++j){this.polygons[j].flip()}this.divider.flip();if(this.front){this.front.invert()}if(this.back){this.back.invert()}h=this.front;this.front=this.back;this.back=h;return this};g.Node.prototype.clipPolygons=function(h){var k,m,l,j;if(!this.divider){return h.slice()}l=[],j=[];for(k=0,m=h.length;k<m;++k){this.divider.splitPolygon(h[k],l,j,l,j)}if(this.front){l=this.front.clipPolygons(l)}if(this.back){j=this.back.clipPolygons(j)}else{j=[]}return l.concat(j)};g.Node.prototype.clipTo=function(h){this.polygons=h.clipPolygons(this.polygons);if(this.front){this.front.clipTo(h)}if(this.back){this.back.clipTo(h)}};return g}));