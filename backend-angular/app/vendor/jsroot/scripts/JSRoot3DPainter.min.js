(function(a){if(typeof define==="function"&&define.amd){define(["d3","JSRootPainter","threejs","threejs_all"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRoot3DPainter.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.v3.js","JSRoot3DPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRoot3DPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(d3,JSROOT,THREE)}}(function(b,a,c){a.Painter.TestWebGL=function(){if(a.gStyle.NoWebGL){return false}if("_Detect_WebGL" in this){return this._Detect_WebGL}try{var d=document.createElement("canvas");this._Detect_WebGL=!!(window.WebGLRenderingContext&&(d.getContext("webgl")||d.getContext("experimental-webgl")))}catch(f){return false}return this._Detect_WebGL};a.Painter.TooltipFor3D=function(e,d){this.tt=null;this.cont=null;this.lastlbl="";this.parent=e?e:document.body;this.canvas=d;this.abspos=!e;this.pos=function(n){if(this.tt===null){return}var k,h;if(this.abspos){h=a.browser.isIE?(n.clientX+document.documentElement.scrollLeft):n.pageX;k=a.browser.isIE?(n.clientY+document.documentElement.scrollTop):n.pageY}else{h=n.offsetX;k=n.offsetY;var i=this.parent.getBoundingClientRect(),g=this.canvas.getBoundingClientRect();if((i.left!==undefined)&&(g.left!==undefined)){h+=(g.left-i.left)}if((i.top!==undefined)&&(g.top!==undefined)){k+=g.top-i.top}if(h+this.tt.offsetWidth+3>=this.parent.offsetWidth){h=this.parent.offsetWidth-this.tt.offsetWidth-3}if(k+this.tt.offsetHeight+15>=this.parent.offsetHeight){k=this.parent.offsetHeight-this.tt.offsetHeight-15}var f=this.parent;while(f){var m=getComputedStyle(f);if(!m||(m.position!=="static")){break}if(!f.parentNode||(f.parentNode.nodeType!=1)){break}f=f.parentNode}if(f&&(f!==this.parent)){var j=f.getBoundingClientRect();h+=(i.left-j.left);k+=(i.top-j.top)}}this.tt.style.top=(k+15)+"px";this.tt.style.left=(h+3)+"px"};this.show=function(g){if(a.gStyle.Tooltip<=0){return}if(!g||(g==="")){return this.hide()}if(typeof g!="string"&&g.length){var i=g[0];for(var j=1;j<g.length;++j){i+="<br/>"+g[j]}g=i}if(this.tt===null){this.tt=document.createElement("div");this.tt.setAttribute("class","jsroot");var h=document.createElement("div");h.setAttribute("class","tt3d_border");this.cont=document.createElement("div");this.cont.setAttribute("class","tt3d_cont");var f=document.createElement("div");f.setAttribute("class","tt3d_border");this.tt.appendChild(h);this.tt.appendChild(this.cont);this.tt.appendChild(f);this.tt.style.opacity=1;this.tt.style.filter="alpha(opacity=1)";this.tt.style.position="absolute";this.tt.style.display="block";this.tt.style.overflow="hidden";this.parent.appendChild(this.tt)}if(this.lastlbl!==g){this.cont.innerHTML=g;this.lastlbl=g;this.tt.style.width="auto";if(a.browser.isIE){this.tt.style.width=this.tt.offsetWidth}}};this.hide=function(){if(this.tt!==null){this.parent.removeChild(this.tt)}this.tt=null;this.lastlbl=""};return this};a.Painter.CreateOrbitControl=function(k,i,g,j,l){if(a.gStyle.Zooming&&a.gStyle.ZoomWheel){j.domElement.addEventListener("wheel",e)}if(a.gStyle.Zooming&&a.gStyle.ZoomMouse){j.domElement.addEventListener("mousedown",d);j.domElement.addEventListener("mouseup",h)}var f=new c.OrbitControls(i,j.domElement);f.enableDamping=false;f.dampingFactor=1;f.enableZoom=true;if(l){f.target.copy(l);f.target0.copy(l);f.update()}f.tooltip=new a.Painter.TooltipFor3D(k.select_main().node(),j.domElement);f.painter=k;f.camera=i;f.scene=g;f.renderer=j;f.raycaster=new c.Raycaster();f.mouse_zoom_mesh=null;f.block_ctxt=false;f.block_mousemove=false;f.cursor_changed=false;f.control_changed=false;f.control_active=false;f.mouse_ctxt={x:0,y:0,on:false};f.Cleanup=function(){if(a.gStyle.Zooming&&a.gStyle.ZoomWheel){this.domElement.removeEventListener("wheel",e)}if(a.gStyle.Zooming&&a.gStyle.ZoomMouse){this.domElement.removeEventListener("mousedown",d);this.domElement.removeEventListener("mouseup",h)}this.domElement.removeEventListener("dblclick",this.lstn_dblclick);this.domElement.removeEventListener("contextmenu",this.lstn_contextmenu);this.domElement.removeEventListener("mousemove",this.lstn_mousemove);this.domElement.removeEventListener("mouseleave",this.lstn_mouseleave);this.dispose();this.tooltip.hide();delete this.tooltip;delete this.painter;delete this.camera;delete this.scene;delete this.renderer;delete this.raycaster;delete this.mouse_zoom_mesh};f.HideTooltip=function(){this.tooltip.hide()};f.GetMousePos=function(n,m){m.x=("offsetX" in n)?n.offsetX:n.layerX;m.y=("offsetY" in n)?n.offsetY:n.layerY;m.clientX=n.clientX;m.clientY=n.clientY;return m};f.GetIntersects=function(m){var p=(this.renderer instanceof c.WebGLRenderer)?this.renderer.getSize():this.renderer.domElement;var o={x:m.x/p.width*2-1,y:-m.y/p.height*2+1};this.camera.updateMatrix();this.camera.updateMatrixWorld();this.raycaster.setFromCamera(o,this.camera);var n=this.raycaster.intersectObjects(this.scene.children,true);if(typeof this.painter.FilterIntersects=="function"){n=this.painter.FilterIntersects(n)}return n};f.DetectZoomMesh=function(q){var m=this.GetMousePos(q,{});var o=this.GetIntersects(m);if(o){for(var p=0;p<o.length;++p){if(o[p].object.zoom){return o[p]}}}return null};f.ProcessDblClick=function(n){var m=this.DetectZoomMesh(n);if(m&&this.painter){this.painter.Unzoom(m.object.use_y_for_z?"y":m.object.zoom)}else{this.reset()}};f.ChangeEvent=function(){this.mouse_ctxt.on=false;this.painter.Render3D(0);this.control_changed=true};f.StartEvent=function(){this.control_active=true;this.block_ctxt=false;this.mouse_ctxt.on=false;this.tooltip.hide()};f.EndEvent=function(){this.control_active=false;if(this.mouse_ctxt.on){this.mouse_ctxt.on=false;this.ContextMenu(this.mouse_ctxt,this.GetIntersects(this.mouse_ctxt))}else{if(this.control_changed){}}this.control_changed=false};f.MainProcessContextMenu=function(m){m.preventDefault();this.GetMousePos(m,this.mouse_ctxt);if(this.control_active){this.mouse_ctxt.on=true}else{if(this.block_ctxt){this.block_ctxt=false}else{this.ContextMenu(this.mouse_ctxt,this.GetIntersects(this.mouse_ctxt))}}};f.ContextMenu=function(n,m){};f.SwitchTooltip=function(m){this.block_mousemove=!m;if(m===false){this.tooltip.hide();this.RemoveZoomMesh()}};f.RemoveZoomMesh=function(){if(this.mouse_zoom_mesh&&this.mouse_zoom_mesh.object.ShowSelection()){this.painter.Render3D()}this.mouse_zoom_mesh=null};f.MainProcessMouseMove=function(t){if(this.control_active&&t.buttons&&(t.buttons&2)){this.block_ctxt=true}if(this.control_active||this.block_mousemove||!this.ProcessMouseMove){return}if(this.mouse_zoom_mesh){var m=this.DetectZoomMesh(t),s=null;if(m&&(m.object===this.mouse_zoom_mesh.object)){s=m.point}else{s=this.mouse_zoom_mesh.object.GlobalIntersect(this.raycaster)}if(s){this.mouse_zoom_mesh.point2=s}if(s&&this.painter.enable_hightlight){if(this.mouse_zoom_mesh.object.ShowSelection(this.mouse_zoom_mesh.point,s)){this.painter.Render3D(0)}}this.tooltip.hide();return}var o=this.GetMousePos(t,{});t.preventDefault();var p=this.GetIntersects(o);var q=this.ProcessMouseMove(p);this.cursor_changed=false;if(q&&(q.length>0)){this.tooltip.show(q,200);this.tooltip.pos(t)}else{this.tooltip.hide();if(p){for(var r=0;r<p.length;++r){if(p[r].object.zoom){this.cursor_changed=true}}}}document.body.style.cursor=this.cursor_changed?"pointer":"auto"};f.MainProcessMouseLeave=function(){this.tooltip.hide();if(typeof this.ProcessMouseLeave==="function"){this.ProcessMouseLeave()}if(this.cursor_changed){document.body.style.cursor="auto";this.cursor_changed=false}};function e(q){if(a.Painter.IsRender3DFired(f.painter)||f.mouse_zoom_mesh){q.preventDefault();q.stopPropagation();q.stopImmediatePropagation();return}var n=f.DetectZoomMesh(q);if(!n){return}q.preventDefault();q.stopPropagation();q.stopImmediatePropagation();if(f.painter&&(f.painter.AnalyzeMouseWheelEvent!==undefined)){var o=n.object.zoom,m=n.point[o],p={name:o,ignore:false};if(o!=="z"){m=(m+f.painter.size_xy3d)/2/f.painter.size_xy3d}else{m=m/2/f.painter.size_z3d}f.painter.AnalyzeMouseWheelEvent(q,p,m,false);if((o==="z")&&n.object.use_y_for_z){o="y"}f.painter.Zoom(o,p.min,p.max)}}function d(m){if(f.mouse_zoom_mesh){m.stopImmediatePropagation();m.stopPropagation();return}if((m.button!==undefined)&&(m.button!==0)){return}if((m.buttons!==undefined)&&(m.buttons!==1)){return}f.mouse_zoom_mesh=f.DetectZoomMesh(m);if(!f.mouse_zoom_mesh){return}m.stopImmediatePropagation();m.stopPropagation()}function h(s){if(f.mouse_zoom_mesh&&f.mouse_zoom_mesh.point2){var r=f.mouse_zoom_mesh.object.zoom,q=f.mouse_zoom_mesh.point[r],p=f.mouse_zoom_mesh.point2[r];if(r==="z"){q=q/2/f.painter.size_z3d;p=p/2/f.painter.size_z3d}else{q=(q+f.painter.size_xy3d)/2/f.painter.size_xy3d;p=(p+f.painter.size_xy3d)/2/f.painter.size_xy3d}if(q>p){var n=q;q=p;p=n}var o=f.painter["scale_"+r+"min"],m=f.painter["scale_"+r+"max"];if(f.painter["log"+r]){q=Math.exp(Math.log(o)+q*(Math.log(m)-Math.log(o)));p=Math.exp(Math.log(o)+p*(Math.log(m)-Math.log(o)))}else{q=o+q*(m-o);p=o+p*(m-o)}if((r==="z")&&f.mouse_zoom_mesh.object.use_y_for_z){r="y"}if(q<p){if(f.painter.Zoom(r,q,p)){f.mouse_zoom_mesh=null}}}f.RemoveZoomMesh()}f.MainProcessDblClick=function(m){this.ProcessDblClick(m)};f.addEventListener("change",f.ChangeEvent.bind(f));f.addEventListener("start",f.StartEvent.bind(f));f.addEventListener("end",f.EndEvent.bind(f));f.lstn_contextmenu=f.MainProcessContextMenu.bind(f);f.lstn_dblclick=f.MainProcessDblClick.bind(f);f.lstn_mousemove=f.MainProcessMouseMove.bind(f);f.lstn_mouseleave=f.MainProcessMouseLeave.bind(f);j.domElement.addEventListener("dblclick",f.lstn_dblclick);j.domElement.addEventListener("contextmenu",f.lstn_contextmenu);j.domElement.addEventListener("mousemove",f.lstn_mousemove);j.domElement.addEventListener("mouseleave",f.lstn_mouseleave);return f};a.Painter.DisposeThreejsObject=function(e){if(!e){return}if(e.children){for(var d=0;d<e.children.length;d++){a.Painter.DisposeThreejsObject(e.children[d])}e.children=undefined}if(e.geometry){e.geometry.dispose();e.geometry=undefined}if(e.material){if(e.material.map){e.material.map.dispose();e.material.map=undefined}e.material.dispose();e.material=undefined}delete e.painter;delete e.bins_index;delete e.tooltip;delete e.stack;e=undefined};a.Painter.HPainter_Create3DScene=function(d){if((d!==undefined)&&(d<0)){if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(null,this.toplevel)}this.clear_3d_canvas();a.Painter.DisposeThreejsObject(this.scene);if(this.control){this.control.Cleanup()}if(this.renderer){if(this.renderer.dispose){this.renderer.dispose()}if(this.renderer.context){delete this.renderer.context}}delete this.size_xy3d;delete this.size_z3d;delete this.scene;delete this.toplevel;delete this.tooltip_mesh;delete this.camera;delete this.pointLight;delete this.renderer;delete this.control;if("render_tmout" in this){clearTimeout(this.render_tmout);delete this.render_tmout}return}if("toplevel" in this){this.scene.remove(this.toplevel);a.Painter.DisposeThreejsObject(this.toplevel);delete this.toplevel;delete this.tooltip_mesh;if(this.control){this.control.HideTooltip()}var g=new c.Object3D();this.scene.add(g);this.toplevel=g;this.Resize3D();return}var i=this.size_for_3d();this.size_z3d=100;this.size_xy3d=(i.height>10)&&(i.width>10)?Math.round(i.width/i.height*this.size_z3d):this.size_z3d;this.scene=new c.Scene();this.toplevel=new c.Object3D();this.scene.add(this.toplevel);this.scene_width=i.width;this.scene_height=i.height;this.camera=new c.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);var f=Math.max(0.75*this.size_xy3d,this.size_z3d);this.camera.position.set(-1.6*f,-3.5*f,1.4*this.size_z3d);this.pointLight=new c.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);var h=new c.Vector3(0,0,0.8*this.size_z3d);this.camera.up=new c.Vector3(0,0,1);this.camera.lookAt(h);this.scene.add(this.camera);this.webgl=a.Painter.TestWebGL();this.renderer=this.webgl?new c.WebGLRenderer({antialias:true,alpha:true}):new c.CanvasRenderer({antialias:true,alpha:true});this.renderer.setSize(this.scene_width,this.scene_height);this.add_3d_canvas(i,this.renderer.domElement);this.DrawXYZ=a.Painter.HPainter_DrawXYZ;this.Render3D=a.Painter.Render3D;this.Resize3D=a.Painter.Resize3D;this.BinHighlight3D=a.Painter.BinHighlight3D;this.first_render_tm=0;this.enable_hightlight=false;this.enable_tooltip=true;this.control=a.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,h);var e=this;this.control.ProcessMouseMove=function(k){var l=null,o=null;for(var j=0;j<k.length;++j){if(k[j].object.tooltip){l=k[j].object.tooltip(k[j]);if(l){o=k[j].object;break}}}if(l&&!l.use_itself){var n=0.0001*e.size_xy3d,m=0.0001*e.size_z3d;if((l.x1>l.x2)||(l.y1>l.y2)||(l.z1>l.z2)){console.warn("check 3D hints coordinates")}l.x1-=n;l.x2+=n;l.y1-=n;l.y2+=n;l.z1-=m;l.z2+=m}e.BinHighlight3D(l,o);return(e.enable_tooltip&&l&&l.info)?l.info:""};this.control.ProcessMouseLeave=function(){e.BinHighlight3D(null)};this.control.ContextMenu=function(q,k){var j="hist",l=e;if(k){for(var o=0;o<k.length;++o){var m=k[o].object;if(m.zoom){j=m.zoom;break}if(m.painter&&typeof m.painter.ShowContextMenu==="function"){l=m.painter;break}}}l.ShowContextMenu(j,q)}};a.Painter.HPainter_TestAxisVisibility=function(i,o,f,k){var m;for(var e=0;e<o.children.length;++e){m=o.children[e];if(m.axis_draw){break}m=undefined}if(!m){return}if(!i){o.remove(m);delete this.TestAxisVisibility;return}f=f?true:false;k=k?true:false;var j=1,l=i.position;if((l.x<0)&&(l.y>=0)){j=2}if((l.x>=0)&&(l.y>=0)){j=3}if((l.x>=0)&&(l.y<0)){j=4}function g(q,n){if(q<=j){q+=4}return(q>j)&&(q<j+n)}for(var e=0;e<m.children.length;++e){var p=m.children[e];if(p.grid){p.visible=k&&g(p.grid,3)}else{if(p.zid){p.visible=g(p.zid,2)}else{if(p.xyid){p.visible=g(p.xyid,3)}else{if(p.xyboxid){var h=5,d=0;if(k&&!f){h=3;d=-2}else{if(f&&!k){h=3}else{if(!f&&!k){h=(p.bottom?3:0)}}}p.visible=g(p.xyboxid+d,h);if(!p.visible&&p.bottom&&k){p.visible=g(p.xyboxid,3)}}else{if(p.zboxid){var h=2,d=0;if(f&&k){h=5}else{if(k&&!f){h=4}else{if(!k&&f){d=-2;h=4}}}p.visible=g(p.zboxid+d,h)}}}}}}};a.Painter.HPainter_DrawXYZ=function(y,J){if(!J){J={}}var E=-this.size_xy3d,h=this.size_xy3d,D=-this.size_xy3d,g=this.size_xy3d,B=0,e=2*this.size_z3d,W=Math.round(this.size_z3d*0.05),z=this.root_pad(),x=this.histo,p=this.xmin,Z=this.xmax,T=this.ymin,j=this.ymax,f=this.zmin,K=this.zmax,q=false,v=false;if(!this.size_z3d){E=this.xmin;h=this.xmax;D=this.ymin;g=this.ymax;B=this.zmin;e=this.zmax;W=(e-B)*0.05}if(("zoom_xmin" in this)&&("zoom_xmax" in this)&&(this.zoom_xmin!==this.zoom_xmax)){p=this.zoom_xmin;Z=this.zoom_xmax}if(("zoom_ymin" in this)&&("zoom_ymax" in this)&&(this.zoom_ymin!==this.zoom_ymax)){T=this.zoom_ymin;j=this.zoom_ymax;q=true}if(("zoom_zmin" in this)&&("zoom_zmax" in this)&&(this.zoom_zmin!==this.zoom_zmax)){f=this.zoom_zmin;K=this.zoom_zmax;v=true}if(J.use_y_for_z){this.zmin=this.ymin;this.zmax=this.ymax;f=T;K=j;v=q;T=0;j=1}this.lego_zmin=f;this.lego_zmax=K;if((J.zmult!==undefined)&&!v){K*=J.zmult}this.TestAxisVisibility=a.Painter.HPainter_TestAxisVisibility;if(z&&z.fLogx){if(Z<=0){Z=1}if((p<=0)&&(this.nbinsx>0)){for(var ah=0;ah<this.nbinsx;++ah){p=Math.max(p,this.GetBinX(ah));if(p>0){break}}}if(p<=0){p=0.0001*Z}this.grx=b.scaleLog();this.x_kind="log"}else{this.grx=b.scaleLinear();if(x&&x.fXaxis.fLabels){this.x_kind="labels"}else{this.x_kind="lin"}}this.logx=(this.x_kind==="log");this.grx.domain([p,Z]).range([E,h]);this.x_handle=new a.TAxisPainter(x?x.fXaxis:null);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,p,Z);this.x_handle.CreateFormatFuncs();this.scale_xmin=p;this.scale_xmax=Z;if(z&&z.fLogy&&!J.use_y_for_z){if(j<=0){j=1}if((T<=0)&&(this.nbinsy>0)){for(var ah=0;ah<this.nbinsy;++ah){T=Math.max(T,this.GetBinY(ah));if(T>0){break}}}if(T<=0){T=0.0001*j}this.gry=b.scaleLog();this.y_kind="log"}else{this.gry=b.scaleLinear();if(x&&x.fYaxis.fLabels){this.y_kind="labels"}else{this.y_kind="lin"}}this.logy=(this.y_kind==="log");this.gry.domain([T,j]).range([D,g]);this.y_handle=new a.TAxisPainter(x?x.fYaxis:null);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,T,j);this.y_handle.CreateFormatFuncs();this.scale_ymin=T;this.scale_ymax=j;if(z&&z.fLogz){if(K<=0){K=1}if(f<=0){f=0.0001*K}this.grz=b.scaleLog();this.z_kind="log"}else{this.grz=b.scaleLinear();this.z_kind="lin"}this.logz=(this.z_kind==="log");this.grz.domain([f,K]).range([B,e]);this.z_handle=new a.TAxisPainter(x?x.fZaxis:null);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,f,K);this.z_handle.CreateFormatFuncs();this.scale_zmin=f;this.scale_zmax=K;var w=new c.MeshBasicMaterial({color:0}),r=new c.LineBasicMaterial({color:0}),X=W*0.5,L,d,I=[],F=1,V=this.x_handle.CreateTicks(),l=this.y_handle.CreateTicks(),Y=this.z_handle.CreateTicks();var k=new c.Object3D();k.axis_draw=true;y.add(k);var ab=[],aj=0;while(V.next()){var S=V.grpos;var af=(V.kind===1);var C=this.x_handle.format(V.tick,true,true);if(V.last_major()){C="x"}else{if(C===null){af=false;C=""}}if(af&&C&&(C.length>0)){var A=new c.TextGeometry(C,{font:a.threejs_font_helvetiker_regular,size:W,height:0,curveSegments:5});A.computeBoundingBox();var t=A.boundingBox.max.x-A.boundingBox.min.x,s=A.boundingBox.max.y-A.boundingBox.min.y;A.translate(-t/2,0,0);aj=Math.max(aj,s);A.grx=S;I.push(A);if(!V.last_major()){var ai=(V.next_major_grpos()-S);if(t>0){F=Math.min(F,0.9*ai/t)}if(this.x_handle.IsCenterLabels()){A.grx+=ai/2}}}ab.push(S,0,0,S,(af?-X:-X*0.6),0)}var ae=new c.BufferGeometry();ae.addAttribute("position",new c.BufferAttribute(new Float32Array(ab),3));function aa(al,am,ao){var i=new c.Geometry();if(al==="z"){i.vertices.push(new c.Vector3(0,0,0),new c.Vector3(X*4,0,0),new c.Vector3(X*4,0,2*am),new c.Vector3(0,0,2*am))}else{i.vertices.push(new c.Vector3(-am,0,0),new c.Vector3(am,0,0),new c.Vector3(am,-X*4,0),new c.Vector3(-am,-X*4,0))}i.faces.push(new c.Face3(0,2,1));i.faces.push(new c.Face3(0,3,2));i.computeFaceNormals();var n=new c.MeshBasicMaterial({transparent:true,vertexColors:c.NoColors,side:c.DoubleSide,opacity:0});var an=new c.Mesh(i,n);an.zoom=al;an.size_3d=am;an.use_y_for_z=ao;if(al=="y"){an.rotateZ(Math.PI/2).rotateX(Math.PI)}an.GlobalIntersect=function(ar){var aq=new c.Plane(),au=this.geometry;aq.setFromCoplanarPoints(au.vertices[0],au.vertices[1],au.vertices[2]);aq.applyMatrix4(this.matrixWorld);var ax=ar.ray.origin.clone(),aw=ax.clone().addScaledVector(ar.ray.direction,10000000000);var av=aq.intersectLine(new c.Line3(ax,aw));if(!av){return undefined}var at=-this.size_3d,ap=this.size_3d;if(this.zoom==="z"){at=0;ap=2*this.size_3d}if(av[this.zoom]<at){av[this.zoom]=at}else{if(av[this.zoom]>ap){av[this.zoom]=ap}}return av};an.ShowSelection=function(ap,au){var at=this.children[0],aq,ar=this.zoom;if(!ap||!au){if(at){this.remove(at);a.Painter.DisposeThreejsObject(at)}return at}if(!at){aq=this.geometry.clone();if(ar==="z"){aq.vertices[1].x=aq.vertices[2].x=X}else{aq.vertices[2].y=aq.vertices[3].y=-X}at=new c.Mesh(aq,new c.MeshBasicMaterial({color:65280,side:c.DoubleSide}));this.add(at)}else{aq=at.geometry}if(ar=="z"){aq.vertices[0].z=aq.vertices[1].z=ap[ar];aq.vertices[2].z=aq.vertices[3].z=au[ar]}else{aq.vertices[0].x=aq.vertices[3].x=ap[ar];aq.vertices[1].x=aq.vertices[2].x=au[ar]}aq.computeFaceNormals();aq.verticesNeedUpdate=true;aq.normalsNeedUpdate=true;return true};return an}var ac=new c.Object3D();ac.position.set(0,D,B);ac.rotation.x=1/4*Math.PI;ac.xyid=2;ac.add(new c.LineSegments(ae,r));I.forEach(function(n){var i=new c.Matrix4();i.set(F,0,0,n.grx,0,F,0,-aj*F-1.5*X,0,0,1,0,0,0,0,1);var al=new c.Mesh(n,w);al.applyMatrix(i);ac.add(al)});if(J.zoom){ac.add(aa("x",this.size_xy3d))}k.add(ac);ac=new c.Object3D();ac.position.set(0,g,B);ac.rotation.x=3/4*Math.PI;ac.add(new c.LineSegments(ae,r));I.forEach(function(n){var i=new c.Matrix4();i.set(-F,0,0,n.grx,0,F,0,-aj*F-1.5*X,0,0,-1,0,0,0,0,1);var al=new c.Mesh(n,w);al.applyMatrix(i);ac.add(al)});ac.xyid=4;if(J.zoom){ac.add(aa("x",this.size_xy3d))}k.add(ac);I=[];F=1;aj=0;ab=[];while(l.next()){var R=l.grpos;var af=(l.kind===1);var C=this.y_handle.format(l.tick,true,true);if(l.last_major()){C="y"}else{if(C===null){af=false;C=""}}if(af){var A=new c.TextGeometry(C,{font:a.threejs_font_helvetiker_regular,size:W,height:0,curveSegments:5});A.computeBoundingBox();var t=A.boundingBox.max.x-A.boundingBox.min.x,s=A.boundingBox.max.y-A.boundingBox.min.y;A.translate(-t/2,0,0);aj=Math.max(aj,s);A.gry=R;I.push(A);if(!l.last_major()){var ai=(l.next_major_grpos()-R);if(t>0){F=Math.min(F,0.9*ai/t)}if(this.y_handle.IsCenterLabels()){A.gry+=ai/2}}}ab.push(0,R,0,(af?-X:-X*0.6),R,0)}var ae=new c.BufferGeometry();ae.addAttribute("position",new c.BufferAttribute(new Float32Array(ab),3));if(!J.use_y_for_z){var M=new c.Object3D();M.position.set(E,0,B);M.rotation.y=-1/4*Math.PI;M.add(new c.LineSegments(ae,r));I.forEach(function(n){var i=new c.Matrix4();i.set(0,F,0,-aj*F-1.5*X,-F,0,0,n.gry,0,0,1,0,0,0,0,1);var al=new c.Mesh(n,w);al.applyMatrix(i);M.add(al)});M.xyid=3;if(J.zoom){M.add(aa("y",this.size_xy3d))}k.add(M);M=new c.Object3D();M.position.set(h,0,B);M.rotation.y=-3/4*Math.PI;M.add(new c.LineSegments(ae,r));I.forEach(function(n){var i=new c.Matrix4();i.set(0,F,0,-aj*F-1.5*X,F,0,0,n.gry,0,0,-1,0,0,0,0,1);var al=new c.Mesh(n,w);al.applyMatrix(i);M.add(al)});M.xyid=1;if(J.zoom){M.add(aa("y",this.size_xy3d))}k.add(M)}I=[];F=1;var ab=[];var H=null,G=null,ak=null;if(this.size_z3d){H=[];G=[]}while(Y.next()){var Q=Y.grpos;var af=Y.kind==1;var C=this.z_handle.format(Y.tick,true,true);if(C===null){af=false;C=""}if(af&&C&&(C.length>0)){var A=new c.TextGeometry(C,{font:a.threejs_font_helvetiker_regular,size:W,height:0,curveSegments:5});A.computeBoundingBox();var t=A.boundingBox.max.x-A.boundingBox.min.x,s=A.boundingBox.max.y-A.boundingBox.min.y;A.translate(-t,-s/2,0);A.grz=Q;I.push(A);if((ak!==null)&&(s>0)){F=Math.min(F,0.9*(Q-ak)/s)}ak=Q}if(H&&af){H.push(E,0,Q,h,0,Q)}if(G&&af){G.push(0,D,Q,0,g,Q)}ab.push(0,0,Q,(af?X:X*0.6),0,Q)}if(H&&(H.length>0)){var ag=new c.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var o=new c.Geometry();for(ah=0;ah<H.length;ah+=3){o.vertices.push(new c.Vector3(H[ah],H[ah+1],H[ah+2]))}o.computeLineDistances();var U=new c.LineSegments(o,ag);U.position.set(0,g,0);U.grid=2;U.visible=false;k.add(U);U=new c.LineSegments(o,ag);U.position.set(0,D,0);U.grid=4;U.visible=false;k.add(U)}if(G&&(G.length>0)){var ag=new c.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var o=new c.Geometry();for(ah=0;ah<G.length;ah+=3){o.vertices.push(new c.Vector3(G[ah],G[ah+1],G[ah+2]))}o.computeLineDistances();var U=new c.LineSegments(o,ag);U.position.set(h,0,0);U.grid=3;U.visible=false;k.add(U);U=new c.LineSegments(o,ag);U.position.set(E,0,0);U.grid=1;U.visible=false;k.add(U)}var ae=new c.BufferGeometry();ae.addAttribute("position",new c.BufferAttribute(new Float32Array(ab),3));var u=[];for(var ad=0;ad<4;++ad){u.push(new c.Object3D());I.forEach(function(n){var i=new c.Matrix4();i.set(-F,0,0,2*X,0,0,1,0,0,F,0,n.grz);var al=new c.Mesh(n,w);al.applyMatrix(i);u[ad].add(al)});u[ad].add(new c.LineSegments(ae,r));if(J.zoom){u[ad].add(aa("z",this.size_z3d,J.use_y_for_z))}u[ad].zid=ad+2;k.add(u[ad])}u[0].position.set(E,g,0);u[0].rotation.z=3/4*Math.PI;u[1].position.set(h,g,0);u[1].rotation.z=1/4*Math.PI;u[2].position.set(h,D,0);u[2].rotation.z=-1/4*Math.PI;u[3].position.set(E,D,0);u[3].rotation.z=-3/4*Math.PI;if(this.size_z3d===0){return}var P=new c.BufferGeometry();P.addAttribute("position",new c.BufferAttribute(new Float32Array([E,0,0,h,0,0]),3));for(var ad=0;ad<2;++ad){var m=new c.LineSegments(P,r);m.position.set(0,D,(ad===0)?B:e);m.xyboxid=2;m.bottom=(ad==0);k.add(m);m=new c.LineSegments(P,r);m.position.set(0,g,(ad===0)?B:e);m.xyboxid=4;m.bottom=(ad==0);k.add(m)}var O=new c.BufferGeometry();O.addAttribute("position",new c.BufferAttribute(new Float32Array([0,D,0,0,g,0]),3));for(var ad=0;ad<2;++ad){var m=new c.LineSegments(O,r);m.position.set(E,0,(ad===0)?B:e);m.xyboxid=3;m.bottom=(ad==0);k.add(m);m=new c.LineSegments(O,r);m.position.set(h,0,(ad===0)?B:e);m.xyboxid=1;m.bottom=(ad==0);k.add(m)}var N=new c.BufferGeometry();N.addAttribute("position",new c.BufferAttribute(new Float32Array([0,0,B,0,0,e]),3));for(var ad=0;ad<4;++ad){var m=new c.LineSegments(N,r);m.zboxid=u[ad].zid;m.position.copy(u[ad].position);k.add(m)}};a.Painter.Box_Vertices=[new c.Vector3(1,1,1),new c.Vector3(1,1,0),new c.Vector3(1,0,1),new c.Vector3(1,0,0),new c.Vector3(0,1,0),new c.Vector3(0,1,1),new c.Vector3(0,0,0),new c.Vector3(0,0,1)];a.Painter.Box_Indexes=[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4];a.Painter.Box_Normals=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1];a.Painter.Box_Segments=[0,2,2,7,7,5,5,0,1,3,3,6,6,4,4,1,1,0,3,2,6,7,4,5];a.Painter.Box_MeshSegments=(function(){var d=new Int32Array(a.Painter.Box_Segments.length);for(var f=0;f<d.length;++f){for(var e=0;e<a.Painter.Box_Indexes.length;++e){if(a.Painter.Box_Segments[f]===a.Painter.Box_Indexes[e]){d[f]=e;break}}}return d})();a.Painter.BinHighlight3D=function(n,f){var l=false,o=null,m=true,q=!n||(n.x1===undefined)||!this.enable_hightlight||!this.enable_tooltip;if(this.tooltip_selfmesh){m=(this.tooltip_selfmesh!==f);this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color;delete this.tooltip_selfmesh;l=true}if(this.tooltip_mesh){o=this.tooltip_mesh;this.toplevel.remove(this.tooltip_mesh);delete this.tooltip_mesh;l=true}if(q){if(l){this.Render3D()}this.ProvideUserTooltip(null);return}if(n.use_itself){f.save_color=f.material.color;f.material.color=new c.Color(n.color);this.tooltip_selfmesh=f;l=m}else{l=true;var d=a.Painter.Box_Indexes,p=a.Painter.Box_Normals,j=a.Painter.Box_Vertices,i,h,s=new c.Color(n.color?n.color:16711680),g=n.opacity||1;if(!o){i=new Float32Array(d.length*3);h=new Float32Array(d.length*3);var r=new c.BufferGeometry();r.addAttribute("position",new c.BufferAttribute(i,3));r.addAttribute("normal",new c.BufferAttribute(h,3));var v=new c.MeshBasicMaterial({color:s,opacity:g,shading:c.SmoothShading});o=new c.Mesh(r,v)}else{i=o.geometry.attributes.position.array;o.geometry.attributes.position.needsUpdate=true;o.material.color=s;o.material.opacity=g}if(n.x1===n.x2){console.warn("same tip X",n.x1,n.x2)}if(n.y1===n.y2){console.warn("same tip Y",n.y1,n.y2)}if(n.z1===n.z2){n.z2=n.z1+0.0001}for(var t=0,e=-3;t<d.length;++t){var u=j[d[t]];i[t*3]=n.x1+u.x*(n.x2-n.x1);i[t*3+1]=n.y1+u.y*(n.y2-n.y1);i[t*3+2]=n.z1+u.z*(n.z2-n.z1);if(h){if(t%6===0){e+=3}h[t*3]=p[e];h[t*3+1]=p[e+1];h[t*3+2]=p[e+2]}}this.tooltip_mesh=o;this.toplevel.add(o)}if(l){this.Render3D()}if(this.IsUserTooltipCallback()&&this.GetObject()){this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:n.bin,cont:n.value,binx:n.ix,biny:n.iy,binz:n.iz,grx:(n.x1+n.x2)/2,gry:(n.y1+n.y2)/2,grz:(n.z1+n.z2)/2})}};a.Painter.HistPainter_DrawTH2Error=function(){var g=this,k=this.main_painter(),B=k.PrepareColorDraw({rounding:false,use3d:true,extra:1}),z=k.grz.domain()[0],D=k.grz.domain()[1],w,v,u,s,m,y,f,x,e,q,p,d=0,l=null,n=null,t=0;function C(){if(g.options.Zero||(z>0)){return false}return !g._show_empty_bins}for(var A=0;A<2;++A){for(w=B.i1;w<B.i2;++w){y=B.grx[w];x=B.grx[w+1];for(v=B.j1;v<B.j2;++v){s=this.histo.getBinContent(w+1,v+1);if((s<z)||(s>D)){continue}if((s===z)&&C()){continue}if(A===0){d+=3;continue}u=this.histo.getBin(w+1,v+1);m=this.histo.getBinError(u);n[t/18]=u;f=B.gry[v];e=B.gry[v+1];q=k.grz((s-m<z)?z:s-m);p=k.grz((s+m>D)?D:s+m);l[t]=y;l[t+3]=x;l[t+1]=l[t+4]=(f+e)/2;l[t+2]=l[t+5]=(q+p)/2;t+=6;l[t]=l[t+3]=(y+x)/2;l[t+1]=f;l[t+4]=e;l[t+2]=l[t+5]=(q+p)/2;t+=6;l[t]=l[t+3]=(y+x)/2;l[t+1]=l[t+4]=(f+e)/2;l[t+2]=q;l[t+5]=p;t+=6}}if(A===0){if(d===0){return}l=new Float32Array(d*6);n=new Int32Array(d/3)}}var h=new c.BufferGeometry();h.addAttribute("position",new c.BufferAttribute(l,3));var E=a.Painter.root_colors[this.GetObject().fLineColor];var r=new c.LineBasicMaterial({color:new c.Color(E)});if(!a.browser.isIE){r.linewidth=this.GetObject().fLineWidth}var o=new c.LineSegments(h,r);o.painter=this;o.intersect_index=n;o.zmin=z;o.zmax=D;o.tip_color=(this.GetObject().fLineColor===3)?16711680:65280;o.tooltip=function(j){var H=Math.floor(j.index/6);if((H<0)||(H>=this.intersect_index.length)){return null}var G=this.painter,i=G.main_painter(),F=G.Get3DToolTip(this.intersect_index[H]);F.x1=Math.max(-i.size_xy3d,i.grx(G.GetBinX(F.ix-1)));F.x2=Math.min(i.size_xy3d,i.grx(G.GetBinX(F.ix)));F.y1=Math.max(-i.size_xy3d,i.gry(G.GetBinY(F.iy-1)));F.y2=Math.min(i.size_xy3d,i.gry(G.GetBinY(F.iy)));F.z1=i.grz(F.value-F.error<this.zmin?this.zmin:F.value-F.error);F.z2=i.grz(F.value+F.error>this.zmax?this.zmax:F.value+F.error);F.color=this.tip_color;return F};this.toplevel.add(o)};a.Painter.HistPainter_DrawLego=function(){if(!this.draw_content){return}if(this.IsTH2Poly()){return a.Painter.HistPainter_DrawPolyLego.call(this)}if(this.options.Contour&&(this.Dimension()==2)){return a.Painter.HistPainter_DrawContour3D.call(this,true)}if(this.options.Surf&&(this.Dimension()==2)){return a.Painter.HistPainter_DrawTH2Surf.call(this)}if(this.options.Error&&(this.Dimension()==2)){return a.Painter.HistPainter_DrawTH2Error.call(this)}var aa=a.Painter.Box_Vertices,L=a.Painter.Box_Indexes,aG=a.Painter.Box_Normals,aA=a.Painter.Box_Segments,E=[0,1,1,2,2,3,3,0],aI=[new c.Vector3(0,0,0),new c.Vector3(0,1,0),new c.Vector3(1,1,0),new c.Vector3(1,0,0)],u=this.main_painter(),aC=u.grz.domain()[0],t=u.grz.domain()[1],af=u.PrepareColorDraw({rounding:false,use3d:true,extra:1}),aj=af.i1,ai=af.i2,Y=af.j1,X=af.j2,P,O,A,z,n,m,ao,an,ae,ak,ay,e=this,o=this.GetObject(),V=o?o["$baseh"]:null,Z=(this.options.Lego===11)||(this.options.Lego===13);if((aj>=ai)||(Y>=X)){return}function at(i,j,v){an=o.getBinContent(i+1,j+1);if(V){ao=V.getBinContent(i+1,j+1)}else{if(e.options.BaseLine!==false){ao=e.options.BaseLine}else{ao=aC}}if(an<ao){var k=ao;ao=an;an=k}if((ao>=J)||(an<s)){return false}ae=(an===s)||(ao>=an);if(!ae||(v>0)){return true}if(o["$baseh"]){return false}if(e.options.Zero||(aC>0)){return true}return e._show_empty_bins}var I=(this.histo.getBin(ai,X)<65535),ad=[aC,t],Q=null,au=0;if((this.options.Lego===12)||(this.options.Lego===14)){ad=this.CreateContour(this.histo.fContour?this.histo.fContour.length:20,this.lego_zmin,this.lego_zmax);Q=this.GetPalette()}for(var aq=0;aq<ad.length-1;++aq){var s=ad[aq],J=ad[aq+1],aD=0,aB=0,am=u.grz(s),aH=u.grz(J),d=0,x=0;for(P=aj;P<ai;++P){for(O=Y;O<X;++O){if(!at(P,O,aq)){continue}ak=!ae&&(aq>0);ay=!ae&&(an>J)&&(aq<ad.length-2);d+=(ae?12:L.length);if(ak){d-=6}if(ay){d-=6}if(Z&&!ae){d-=12;x+=12}}}au+=d+x;var p=new Float32Array(d*3),az=new Float32Array(d*3),ag=I?new Uint16Array(d):new Uint32Array(d),T=null,ah=null,w=null,G=0,ac=0,av,C,N,ab;if(x>0){T=new Float32Array(x*3);ah=new Float32Array(x*3);w=I?new Uint16Array(x):new Uint32Array(x)}for(P=aj;P<ai;++P){A=af.grx[P];z=af.grx[P+1];for(O=Y;O<X;++O){if(!at(P,O,aq)){continue}ak=!ae&&(aq>0);ay=!ae&&(an>J)&&(aq<ad.length-2);n=af.gry[O];m=af.gry[O+1];aD=(ao<=s)?am:u.grz(ao);aB=(an>J)?aH:u.grz(an);ab=0;N=0;if(ae){ab+=12;N+=24}var H=L.length,f=this.histo.getBin(P+1,O+1);if(ak){H-=6}while(N<H){av=aa[L[N]];if(Z&&(N<12)){T[ac]=A+av.x*(z-A);T[ac+1]=n+av.y*(m-n);T[ac+2]=aD+av.z*(aB-aD);ah[ac]=aG[ab];ah[ac+1]=aG[ab+1];ah[ac+2]=aG[ab+2];w[ac/3]=f;ac+=3}else{p[G]=A+av.x*(z-A);p[G+1]=n+av.y*(m-n);p[G+2]=aD+av.z*(aB-aD);az[G]=aG[ab];az[G+1]=aG[ab+1];az[G+2]=aG[ab+2];ag[G/3]=f;G+=3}++N;if(N%6===0){ab+=3;if(ay&&(N===L.length-12)){N+=6;ab+=3}}}}}var al=new c.BufferGeometry();al.addAttribute("position",new c.BufferAttribute(p,3));al.addAttribute("normal",new c.BufferAttribute(az,3));var ap=o.fFillColor,r=a.Painter.root_colors[ap];if(Q){var M=Math.floor((aq+0.99)*Q.length/(ad.length-1));if(M>Q.length-1){M=Q.length-1}r=Q[M]}else{if((this.options.Lego===1)||(ap<2)){ap=1;r="white"}}var aF=new c.MeshBasicMaterial({color:r,shading:c.SmoothShading});var S=new c.Mesh(al,aF);S.bins_index=ag;S.painter=this;S.zmin=aC;S.zmax=t;S.baseline=(this.options.BaseLine===false)?aC:this.options.BaseLine;S.tip_color=(ap===3)?16711680:65280;S.tooltip=function(j){if((j.index<0)||(j.index>=this.bins_index.length)){return null}var aN=this.painter,i=aN.main_painter(),aM=aN.GetObject(),aL=aN.Get3DToolTip(this.bins_index[j.index]);aL.x1=Math.max(-i.size_xy3d,i.grx(aN.GetBinX(aL.ix-1)));aL.x2=Math.min(i.size_xy3d,i.grx(aN.GetBinX(aL.ix)));if(aN.Dimension()===1){aL.y1=i.gry(0);aL.y2=i.gry(1)}else{aL.y1=Math.max(-i.size_xy3d,i.gry(aN.GetBinY(aL.iy-1)));aL.y2=Math.min(i.size_xy3d,i.gry(aN.GetBinY(aL.iy)))}var aK=this.baseline,aJ=aL.value;if(aM["$baseh"]){aK=aM["$baseh"].getBinContent(aL.ix,aL.iy)}if(aJ<aK){var k=aK;aK=aJ;aJ=k}aL.z1=i.grz(Math.max(this.zmin,aK));aL.z2=i.grz(Math.min(this.zmax,aJ));aL.color=this.tip_color;return aL};u.toplevel.add(S);if(x>0){var ar=new c.BufferGeometry();ar.addAttribute("position",new c.BufferAttribute(T,3));ar.addAttribute("normal",new c.BufferAttribute(ah,3));var l=(ap<2)?new c.Color(16711680):new c.Color(b.rgb(r).darker(0.5).toString());var aw=new c.MeshBasicMaterial({color:l,shading:c.SmoothShading});var D=new c.Mesh(ar,aw);D.bins_index=w;D.painter=this;D.tooltip=S.tooltip;D.zmin=S.zmin;D.zmax=S.zmax;D.baseline=S.baseline;D.tip_color=S.tip_color;u.toplevel.add(D)}}if(this.options.Lego>12){return}var aE=0,F=0,W=true,B=0;J=t;s=aC;for(P=aj;P<ai;++P){for(O=Y;O<X;++O){if(!at(P,O,0)){B++;continue}aE+=(ae?aI.length:aa.length);F+=(ae?E.length:aA.length)}}if(aE>65520){W=false}if(!W){aE=F*3}var y=new Float32Array(aE*3),g=W?new Uint16Array(F):null;var aD=0,aB=0,am=u.grz(aC),aH=u.grz(t),ax=0,K=0;for(P=aj;P<ai;++P){A=af.grx[P];z=af.grx[P+1];for(O=Y;O<X;++O){if(!at(P,O,0)){continue}n=af.gry[O];m=af.gry[O+1];aD=(ao<=aC)?am:u.grz(ao);aB=(an>t)?aH:u.grz(an);var R=ae?E:aA,U=ae?aI:aa;if(W){for(N=0;N<R.length;++N){g[K++]=ax/3+R[N]}for(N=0;N<U.length;++N){av=U[N];y[ax]=A+av.x*(z-A);y[ax+1]=n+av.y*(m-n);y[ax+2]=aD+av.z*(aB-aD);ax+=3}}else{for(N=0;N<R.length;++N){av=U[R[N]];y[ax]=A+av.x*(z-A);y[ax+1]=n+av.y*(m-n);y[ax+2]=aD+av.z*(aB-aD);ax+=3}}}}al=new c.BufferGeometry();al.addAttribute("position",new c.BufferAttribute(y,3));if(W){al.setIndex(new c.BufferAttribute(g,1))}var h=a.Painter.root_colors[o.fLineColor];aF=new c.LineBasicMaterial({color:new c.Color(h)});if(!a.browser.isIE){aF.linewidth=o.fLineWidth}var q=new c.LineSegments(al,aF);u.toplevel.add(q)};a.Painter.HistPainter_DrawContour3D=function(k){var d=this.main_painter(),j=this.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0});this.getContourIndex(0);var h=this.GetObject(),i=this.fContour,g=this.GetPalette(),f=this,e=2*d.size_z3d;this.BuildContour(j,i,g,function(v,n,l,r,p,m){if(p-r<3){return}if(k){e=d.grz(i[m]);if((e<0)||(e>2*d.size_z3d)){return}}var u=new Float32Array((p-r+1)*3),q=0;for(var o=r;o<=p;++o){u[q]=n[o];u[q+1]=l[o];u[q+2]=e;q+=3}var t=new c.BufferGeometry();t.addAttribute("position",new c.BufferAttribute(u,3));var s=new c.LineBasicMaterial({color:new c.Color(a.Painter.root_colors[h.fLineColor])});var w=new c.Line(t,s);d.toplevel.add(w)})};a.Painter.HistPainter_DrawTH2Surf=function(){var w=this.GetObject(),m=this.main_painter(),H=m.PrepareColorDraw({rounding:false,use3d:true,extra:1,middle:0.5}),ae,ab,z,ak,y,ai,F,D,h,e,E=m.grz.domain()[0],aa=m.grz.domain()[1];var J=!m.logz?m.grz:function(i){return i<E?-0.1:m.grz(i)};if((H.i2-H.i1<2)||(H.j2-H.j1<2)){return}var O=null,G=null,p=true,d=false,aj=false,Q=false;switch(this.options.Surf){case 11:O=this.GetContour();d=true;break;case 12:case 15:case 17:O=this.GetContour();d=true;p=false;break;case 14:p=false;Q=true;break;case 16:O=this.GetContour();aj=true;p=false;break;default:O=m.z_handle.CreateTicks(true);aj=true;break}if(O){G=new Float32Array(O.length);for(var M=0;M<O.length;++M){G[M]=J(O[M])}}else{G=[0,2*m.size_z3d]}var l,g=[],L=[],K=[],o=0,ag=null,af=0,f=0,T=null,v=0,C=null;function ah(k,j,i){if(k<j){return -1}if(k>i){return 1}return 0}function s(n,ao,am,k,an,al){if(!p){return}var j=ah(am,0,2*m.size_z3d),i=ah(al,0,2*m.size_z3d);if((j===i)&&(j!==0)){return}if(!l){return ++o}if(j!==0){var ap=al-am;am=(j<0)?0:2*m.size_z3d;n=k-(k-n)/ap*(al-am);ao=an-(an-ao)/ap*(al-am)}if(i!==0){var ap=am-al;al=(i<0)?0:2*m.size_z3d;k=n-(n-k)/ap*(am-al);an=ao-(ao-an)/ap*(am-al)}ag[af]=n;ag[af+1]=ao;ag[af+2]=am;af+=3;ag[af]=k;ag[af+1]=an;ag[af+2]=al;af+=3}var R=new Float32Array(6*3),Z=0,N=0;var B=new Float32Array(2*3),W=0;function A(am,j,aq,al,i,ap,an,ao){if(Z>=R.length){console.log("more than 6 points???")}var n=(an-aq)/(ap-aq),k=3;if((N!==0)&&(Math.abs(n)<Math.abs(N))){R[Z]=R[Z-3];R[Z+1]=R[Z-2];R[Z+2]=R[Z-1];Z-=3;k=6}R[Z]=am+n*(al-am);R[Z+1]=j+n*(i-j);R[Z+2]=an;if(ao&&T){B[W]=R[Z];B[W+1]=R[Z+1];B[W+2]=R[Z+2];W+=3}Z+=k;N=n}function ad(n,j,k){var i=((j-H.i1)*(H.j2-H.j1)+(k-H.j1))*8;if(C[i]>=0){return console.error("More than 8 vertexes for the bin")}var al=i+8+C[i];C[i]--;C[al]=n}function r(am){for(var aq=H.i1;aq<H.i2;++aq){for(var ao=H.j1;ao<H.j2;++ao){var ar=((aq-H.i1)*(H.j2-H.j1)+(ao-H.j1))*8;if(C[ar]===-1){continue}var ap=(C[ar]>=0)?ar:ar+9+C[ar],al=ar+8,n=0,k=0,j=0;for(var i=ap;i<al;++i){var an=C[i];if(an<0){return console.error("FAILURE in NORMALS RECALCULATIONS")}n+=am[an];k+=am[an+1];j+=am[an+2]}n=n/(al-ap);k=k/(al-ap);j=j/(al-ap);for(var i=ap;i<al;++i){var an=C[i];am[an]=n;am[an+1]=k;am[an+2]=j}}}}function S(ay,k,at,ax,j,ar,aw,i,ap,aB){for(var av=1;av<G.length;++av){var am=ah(at,G[av-1],G[av]),al=ah(ar,G[av-1],G[av]),n=ah(ap,G[av-1],G[av]),aq=am+al+n;if(aq===3){continue}if(aq===-3){return}if(!l){var ao=Math.abs(al-am)+Math.abs(n-al)+Math.abs(am-n);if(am===0){++ao}if(al===0){++ao}if(n===0){++ao}if((ao===1)||(ao===2)){console.error("FOND npnts",ao)}if(ao>2){if(g[av]===undefined){g[av]=0}g[av]+=ao-2}if(((am>0)||(al>0)||(n>0))&&((am!==al)||(al!==n)||(n!==am))){++f}continue}W=0;Z=0;if(am===0){R[Z]=ay;R[Z+1]=k;R[Z+2]=at;Z+=3}if(am!==al){N=0;if((am<0)||(al<0)){A(ay,k,at,ax,j,ar,G[av-1])}if((am>0)||(al>0)){A(ay,k,at,ax,j,ar,G[av],true)}}if(al===0){R[Z]=ax;R[Z+1]=j;R[Z+2]=ar;Z+=3}if(al!==n){N=0;if((al<0)||(n<0)){A(ax,j,ar,aw,i,ap,G[av-1])}if((al>0)||(n>0)){A(ax,j,ar,aw,i,ap,G[av],true)}}if(n===0){R[Z]=aw;R[Z+1]=i;R[Z+2]=ap;Z+=3}if(n!==am){N=0;if((n<0)||(am<0)){A(aw,i,ap,ay,k,at,G[av-1])}if((n>0)||(am>0)){A(aw,i,ap,ay,k,at,G[av],true)}}if(Z===0){continue}if(Z<9){console.log("found less than 3 points",Z/3);continue}if(T&&(W===6)){for(var az=0;az<6;++az){T[v+az]=B[az]}v+=6}var aA=L[av],au=K[av];if(Q&&(Z===9)){ad(au,ae,ab);ad(au+3,ae+1,aB?ab+1:ab);ad(au+6,aB?ae:ae+1,ab+1)}for(var an=3;an<Z-3;an+=3){aA[au]=R[0];aA[au+1]=R[1];aA[au+2]=R[2];au+=3;aA[au]=R[an];aA[au+1]=R[an+1];aA[au+2]=R[an+2];au+=3;aA[au]=R[an+3];aA[au+1]=R[an+4];aA[au+2]=R[an+5];au+=3}K[av]=au}}if(Q){C=new Int32Array((H.i2-H.i1)*(H.j2-H.j1)*8);for(var V=0;V<C.length;++V){C[V]=-1}}for(l=0;l<2;++l){if(l){for(var X=1;X<G.length;++X){if(g[X]){L[X]=new Float32Array(g[X]*9);K[X]=0}}if(p&&(o>0)){ag=new Float32Array(o*6)}if(aj&&(f>0)){T=new Float32Array(f*6)}}for(ae=H.i1;ae<H.i2-1;++ae){z=H.grx[ae];y=H.grx[ae+1];for(ab=H.j1;ab<H.j2-1;++ab){ak=H.gry[ab];ai=H.gry[ab+1];F=J(w.getBinContent(ae+1,ab+1));D=J(w.getBinContent(ae+1,ab+2));h=J(w.getBinContent(ae+2,ab+1));e=J(w.getBinContent(ae+2,ab+2));S(z,ak,F,y,ai,e,z,ai,D,true);S(z,ak,F,y,ak,h,y,ai,e,false);s(z,ai,D,z,ak,F);s(z,ak,F,y,ak,h);if(ae===H.i2-2){s(y,ak,h,y,ai,e)}if(ab===H.j2-2){s(z,ai,D,y,ai,e)}}}}for(var X=1;X<G.length;++X){if(L[X]){if(K[X]!==g[X]*9){console.error("SURF faces missmatch lvl",X,"faces",g[X],"index",K[X],"check",g[X]*9-K[X])}var x=new c.BufferGeometry();x.addAttribute("position",new c.BufferAttribute(L[X],3));x.computeVertexNormals();if(Q&&(X===1)){r(x.getAttribute("normal").array)}var q,Y;if(d){q=this.getIndexColor(X)}else{q=w.fFillColor>1?a.Painter.root_colors[w.fFillColor]:"white";if((this.options.Surf===14)&&(w.fFillColor<2)){q=a.Painter.root_colors[48]}}if(this.options.Surf===14){Y=new c.MeshLambertMaterial({color:q,side:c.DoubleSide})}else{Y=new c.MeshBasicMaterial({color:q,side:c.DoubleSide})}var I=new c.Mesh(x,Y);m.toplevel.add(I);I.painter=this}}if(ag){if(o*6!==af){console.error("SURF lines mismmatch nsegm",o," lindx",af,"difference",o*6-af)}var x=new c.BufferGeometry();x.addAttribute("position",new c.BufferAttribute(ag,3));var u=a.Painter.root_colors[w.fLineColor];var Y=new c.LineBasicMaterial({color:new c.Color(u)});if(!a.browser.isIE){Y.linewidth=w.fLineWidth}var t=new c.LineSegments(x,Y);t.painter=this;m.toplevel.add(t)}if(T){if(f*6!==v){console.error("SURF grid draw mismatch ngridsegm",f,"gindx",v,"diff",f*6-v)}var x=new c.BufferGeometry();x.addAttribute("position",new c.BufferAttribute(T,3));var Y;if(this.options.Surf===1){Y=new c.LineDashedMaterial({color:0,dashSize:2,gapSize:2})}else{Y=new c.LineBasicMaterial({color:new c.Color(a.Painter.root_colors[w.fLineColor])})}var t=new c.LineSegments(x,Y);t.painter=this;m.toplevel.add(t)}if(this.options.Surf===17){a.Painter.HistPainter_DrawContour3D.call(this)}if(this.options.Surf===13){H=m.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0});this.getContourIndex(0);var G=this.fContour,ac=this.GetPalette(),U=-1,P=2*m.size_z3d;this.BuildContour(H,G,ac,function(ap,ar,az,aB,aw){if(aw-aB<3){return}var av=[];for(var ay=aB;ay<=aw;++ay){if((ay===aB)||(ar[ay]!==ar[ay-1])||(az[ay]!==az[ay-1])){av.push(new c.Vector2(ar[ay],az[ay]))}}if(av.length<3){return}var k=c.ShapeUtils.triangulateShape(av,[]);if(!k||(k.length===0)){return}if((U<0)||(U!==ap)){U=ap;P+=0.0001*m.size_z3d}var ao=new Float32Array(k.length*9),an=new Float32Array(k.length*9),aC=0;for(var ax=0;ax<k.length;++ax){var aq=k[ax];for(var at=0;at<3;++at){var aA=av[aq[at]];ao[aC]=aA.x;ao[aC+1]=aA.y;ao[aC+2]=P;an[aC]=0;an[aC+1]=0;an[aC+2]=1;aC+=3}}var am=new c.BufferGeometry();am.addAttribute("position",new c.BufferAttribute(ao,3));am.addAttribute("normal",new c.BufferAttribute(an,3));var al=ac[ap];var au=new c.MeshBasicMaterial({color:al,shading:c.SmoothShading,side:c.DoubleSide,opacity:0.5});var j=new c.Mesh(am,au);j.painter=this;m.toplevel.add(j)})}};a.Painter.HistPainter_DrawPolyLego=function(){var v=this.GetObject(),F=this.main_painter(),B=this.grz.domain()[0],W=this.grz.domain()[1],H,p,X,C=v.fBins.arr.length,D=0,h=0,L=this.grz(B),K=L;this.fContour=null;this.fCustomContour=false;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(X=0;X<C;++X){p=v.fBins.arr[X];if(p.fContent<B){continue}H=this.getValueColor(p.fContent,true);if(H===null){continue}if((p.fXmin>F.scale_xmax)||(p.fXmax<F.scale_xmin)||(p.fYmin>F.scale_ymax)||(p.fYmax<F.scale_ymin)){continue}K=this.grz(p.fContent>W?W:p.fContent);var O=[],A=[],Y=1,o=p.fPoly,f=0;if(o._typename=="TMultiGraph"){Y=p.fPoly.fGraphs.arr.length;o=null}for(var G=0;G<Y;++G){if(!o||(G>0)){o=p.fPoly.fGraphs.arr[G]}var j=o.fNpoints,N=o.fX,M=o.fY;while((j>2)&&(N[0]===N[j-1])&&(M[0]===M[j-1])){--j}var l,u;for(var q=0;q<2;++q){var Q,P,t,r,g=F.size_xy3d*F.size_z3d,d=(q>0)?0:g/1000000;l=[];u=null;for(var z=0;z<j;++z){t=F.grx(N[z]);r=F.gry(M[z]);if(z>0){g=(t-Q)*(t-Q)+(r-P)*(r-P)}if(g>d){l.push(new c.Vector2(t,r));Q=t;P=r}}try{if(l.length>2){u=c.ShapeUtils.triangulateShape(l,[])}}catch(Z){u=null}if(u&&(u.length>l.length-3)){break}}if(u&&u.length&&l){O.push(l);A.push(u);f+=u.length*2;if(K>L){f+=l.length*2}}}var J=new Float32Array(f*9),I=0;for(var G=0;G<O.length;++G){var l=O[G],u=A[G];for(var k=0;k<2;++k){for(var R=0;R<u.length;++R){var s=u[R],V=l[s[0]],U=l[s[(k===0)?2:1]],S=l[s[(k===0)?1:2]];J[I]=V.x;J[I+1]=V.y;J[I+2]=k?K:L;I+=3;J[I]=U.x;J[I+1]=U.y;J[I+2]=k?K:L;I+=3;J[I]=S.x;J[I+1]=S.y;J[I+2]=k?K:L;I+=3}}if(K>L){for(var R=0;R<l.length;++R){var V=l[R],U=l[(R>0)?R-1:l.length-1];J[I]=V.x;J[I+1]=V.y;J[I+2]=L;I+=3;J[I]=U.x;J[I+1]=U.y;J[I+2]=L;I+=3;J[I]=U.x;J[I+1]=U.y;J[I+2]=K;I+=3;J[I]=V.x;J[I+1]=V.y;J[I+2]=L;I+=3;J[I]=U.x;J[I+1]=U.y;J[I+2]=K;I+=3;J[I]=V.x;J[I+1]=V.y;J[I+2]=K;I+=3}}}var w=new c.BufferGeometry();w.addAttribute("position",new c.BufferAttribute(J,3));w.computeVertexNormals();var m=this.fPalette[H];var T=new c.MeshBasicMaterial({color:m,shading:c.SmoothShading});var E=new c.Mesh(w,T);F.toplevel.add(E);E.painter=this;E.bins_index=X;E.draw_z0=L;E.draw_z1=K;E.tip_color=65280;E.tooltip=function(n){var y=this.painter,e=y.main_painter(),i=y.GetObject().fBins.arr[this.bins_index];var x={use_itself:true,x1:e.grx(i.fXmin),x2:e.grx(i.fXmax),y1:e.gry(i.fYmin),y2:e.gry(i.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:i.fContent,color:this.tip_color,info:y.ProvidePolyBinHints(this.bins_index)};return x};h+=f;D++}};a.Painter.IsRender3DFired=function(d){if(!d||d.renderer===undefined){return false}return d.render_tmout!==undefined};a.Painter.Render3D=function(f){if(f===undefined){f=5}if(f<=0){if("render_tmout" in this){clearTimeout(this.render_tmout)}if(this.renderer===undefined){return}var e=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this.camera,this.toplevel,this.options.FrontBox,this.options.BackBox)}this.renderer.render(this.scene,this.camera);var d=new Date();delete this.render_tmout;if(this.first_render_tm===0){this.first_render_tm=d.getTime()-e.getTime();this.enable_hightlight=this.first_render_tm<1200;console.log("First render tm = "+this.first_render_tm)}return}if("render_tmout" in this){return}this.render_tmout=setTimeout(this.Render3D.bind(this,0),f)};a.Painter.Resize3D=function(){var d=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(d);if((this.scene_width===d.width)&&(this.scene_height===d.height)){return false}if((d.width<10)||(d.height<10)){return false}this.scene_width=d.width;this.scene_height=d.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return true};a.Painter.TH1Painter_Draw3D=function(f,e){var d=this.main_painter();if(e){if((d===this)&&(this.Resize3D!==undefined)&&this.Resize3D()){this.Render3D()}}else{this.Draw3DBins=a.Painter.HistPainter_DrawLego;this.DeleteAtt();if(d===this){this.Create3DScene();this.DrawXYZ(this.toplevel,{use_y_for_z:true,zmult:1.1,zoom:a.gStyle.Zooming})}this.ScanContent(true);this.Draw3DBins();d.Render3D();this.AddKeysHandler()}if(d===this){this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)));this.DrawTitle()}a.CallBack(f)};a.Painter.TH2Painter_Draw3D=function(g,f){this.mode3d=true;var d=this.main_painter();if(f){if((d===this)&&(this.Resize3D!==undefined)&&this.Resize3D()){this.Render3D()}}else{this.Draw3DBins=a.Painter.HistPainter_DrawLego;var h=this.root_pad();this.zmin=h.fLogz?this.gminposbin*0.3:this.gminbin;this.zmax=this.gmaxbin;var e=1.1;if(this.histo.fMinimum!==-1111){this.zmin=this.histo.fMinimum}if(this.histo.fMaximum!==-1111){this.zmax=this.histo.fMaximum;e=1}if(h.fLogz&&(this.zmin<=0)){this.zmin=this.zmax*0.00001}this.DeleteAtt();if(d===this){this.Create3DScene();this.DrawXYZ(this.toplevel,{zmult:e,zoom:a.gStyle.Zooming})}this.Draw3DBins();d.Render3D();this.AddKeysHandler()}if(d===this){this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)||(this.options.Surf===11)||(this.options.Surf===12)));this.DrawTitle()}a.CallBack(g)};a.Painter.PointsCreator=function(e,d,f){if(d===undefined){d=true}this.webgl=d;this.scale=f||1;if(this.webgl){this.pos=new Float32Array(e*3)}else{this.pos=new Float32Array(a.Painter.Box_Indexes.length*3*e);this.norm=new Float32Array(a.Painter.Box_Indexes.length*3*e)}this.indx=0};a.Painter.PointsCreator.prototype.AddPoint=function(l,i,h){if(this.webgl){this.pos[this.indx]=l;this.pos[this.indx+1]=i;this.pos[this.indx+2]=h;this.indx+=3;return}var d=a.Painter.Box_Indexes,j=a.Painter.Box_Normals,g=a.Painter.Box_Vertices;for(var e=0,m=-3;e<d.length;++e){var f=g[d[e]];this.pos[this.indx]=l+(f.x-0.5)*this.scale;this.pos[this.indx+1]=i+(f.y-0.5)*this.scale;this.pos[this.indx+2]=h+(f.z-0.5)*this.scale;if(e%6===0){m+=3}this.norm[this.indx]=j[m];this.norm[this.indx+1]=j[m+1];this.norm[this.indx+2]=j[m+2];this.indx+=3}};a.Painter.PointsCreator.prototype.CreateMesh=function(f){var d=new c.BufferGeometry();d.addAttribute("position",new c.BufferAttribute(this.pos,3));if(this.norm){d.addAttribute("normal",new c.BufferAttribute(this.norm,3))}var g=null;if(this.webgl){var e=new c.PointsMaterial({size:3*this.scale,color:f});g=new c.Points(d,e);g.nvertex=1}else{var e=new c.MeshBasicMaterial({color:f,shading:c.SmoothShading});g=new c.Mesh(d,e);g.nvertex=a.Painter.Box_Indexes.length}return g};a.Painter.drawGraph2D=function(f,d,e){this.DecodeOptions=function(h){var i=new a.DrawOptions(h);var g={Color:i.check("COL"),Error:i.check("ERR")&&this.MatchObjectType("TGraph2DErrors"),Markers:i.check("P")};if(!g.Markers&&!g.Error){g.Markers=true}if(!g.Markers){g.Color=false}return g};this.CreateHistogram=function(){var A=this.GetObject();var u=A.fX[0],w=u,B=A.fY[0],D=B,F=A.fZ[0],H=F;for(var v=0;v<A.fNpoints;++v){var q=A.fX[v],n=A.fY[v],m=A.fZ[v],l=this.options.Error?A.fEX[v]:0,k=this.options.Error?A.fEY[v]:0,j=this.options.Error?A.fEZ[v]:0;u=Math.min(u,q-l);w=Math.max(w,q+l);B=Math.min(B,n-k);D=Math.max(D,n+k);F=Math.min(F,m-j);H=Math.max(H,m+j)}if(u>=w){w=u+1}if(B>=D){D=B+1}if(F>=H){H=F+1}var s=(w-u)*0.02,r=(D-B)*0.02,o=(H-F)*0.02,C=u-s,E=w+s,G=B-r,I=D+r,g=F-o,i=H+o;if((C<0)&&(u>=0)){C=u*0.98}if((E>0)&&(w<=0)){E=0}if((G<0)&&(B>=0)){G=B*0.98}if((I>0)&&(D<=0)){I=0}if((g<0)&&(F>=0)){g=F*0.98}if((i>0)&&(H<=0)){i=0}var h=this.GetObject();if(h.fMinimum!=-1111){g=h.fMinimum}if(h.fMaximum!=-1111){i=h.fMaximum}var t=a.CreateHistogram("TH2I",10,10);t.fName=h.fName+"_h";t.fTitle=h.fTitle;t.fXaxis.fXmin=C;t.fXaxis.fXmax=E;t.fYaxis.fXmin=G;t.fYaxis.fXmax=I;t.fZaxis.fXmin=g;t.fZaxis.fXmax=i;t.fMinimum=g;t.fMaximum=i;t.fBits=t.fBits|a.TH1StatusBits.kNoStats;return t};this.Graph2DTooltip=function(g){var k=Math.floor(g.index/this.nvertex);if((k<0)||(k>=this.index.length)){return null}k=this.index[k];var m=this.painter,j=m.grx(this.graph.fX[k]),i=m.gry(this.graph.fY[k]),h=m.grz(this.graph.fZ[k]),l={info:this.tip_name+"<br/>pnt: "+k+"<br/>x: "+m.x_handle.format(this.graph.fX[k])+"<br/>y: "+m.y_handle.format(this.graph.fY[k])+"<br/>z: "+m.z_handle.format(this.graph.fZ[k])};l.x1=j-this.scale0;l.x2=j+this.scale0;l.y1=i-this.scale0;l.y2=i+this.scale0;l.z1=h-this.scale0;l.z2=h+this.scale0;l.color=this.tip_color;return l};this.Redraw=function(){var o=this.main_painter(),j=this.GetObject(),p=1;if(!j||!o||!("renderer" in o)){return}function I(x,P){var z=0;for(var y=0;y<j.fNpoints;++y){if((j.fX[y]<o.scale_xmin)||(j.fX[y]>o.scale_xmax)||(j.fY[y]<o.scale_ymin)||(j.fY[y]>o.scale_ymax)||(j.fZ[y]<x)||(j.fZ[y]>=P)){continue}++z}return z}if((a.gStyle.OptimizeDraw>0)&&!o.webgl){var A=I(o.scale_zmin,o.scale_zmax),B=o.webgl?50000:5000;if(A>B){p=Math.floor(A/B);if(p<=2){p=2}}}var E=a.Painter.createAttMarker(j),J=null,q=[o.scale_zmin,o.scale_zmax],O=o.size_xy3d/100*E.size*E.scale;if(this.options.Color){q=o.GetContour();J=o.GetPalette()}for(var F=0;F<q.length-1;++F){var h=Math.max(q[F],o.scale_zmin),k=Math.min(q[F+1],o.scale_zmax);if(h>=k){continue}var D=Math.floor(I(h,k)/p),C=null,G=0,r=new Int32Array(D),s=0,n=null,L=0;if(this.options.Markers){C=new a.Painter.PointsCreator(D,o.webgl,O/3)}if(this.options.Error){n=new Float32Array(D*6*3)}for(var H=0;H<j.fNpoints;++H){if((j.fX[H]<o.scale_xmin)||(j.fX[H]>o.scale_xmax)||(j.fY[H]<o.scale_ymin)||(j.fY[H]>o.scale_ymax)||(j.fZ[H]<h)||(j.fZ[H]>=k)){continue}if(p>1){G=(G+1)%p;if(G!==0){continue}}r[s++]=H;var v=o.grx(j.fX[H]),u=o.gry(j.fY[H]),t=o.grz(j.fZ[H]);if(C){C.AddPoint(v,u,t)}if(n){n[L]=o.grx(j.fX[H]-j.fEX[H]);n[L+1]=u;n[L+2]=t;n[L+3]=o.grx(j.fX[H]+j.fEX[H]);n[L+4]=u;n[L+5]=t;L+=6;n[L]=v;n[L+1]=o.gry(j.fY[H]-j.fEY[H]);n[L+2]=t;n[L+3]=v;n[L+4]=o.gry(j.fY[H]+j.fEY[H]);n[L+5]=t;L+=6;n[L]=v;n[L+1]=u;n[L+2]=o.grz(j.fZ[H]-j.fEZ[H]);n[L+3]=v;n[L+4]=u;n[L+5]=o.grz(j.fZ[H]+j.fEZ[H]);L+=6}}if(n){var m=new c.BufferGeometry();m.addAttribute("position",new c.BufferAttribute(n,3));var M=a.Painter.root_colors[this.GetObject().fLineColor];var w=new c.LineBasicMaterial({color:new c.Color(M)});if(!a.browser.isIE){w.linewidth=this.GetObject().fLineWidth}var K=new c.LineSegments(m,w);o.toplevel.add(K);K.graph=j;K.index=r;K.painter=o;K.scale0=0.7*O;K.tip_name=this.GetTipName();K.tip_color=(j.fMarkerColor===3)?16711680:65280;K.nvertex=6;K.tooltip=this.Graph2DTooltip}if(C){var l=a.Painter.root_colors[j.fMarkerColor];if(J){var N=Math.floor((F+0.99)*J.length/(q.length-1));if(N>=J.length){N=J.length-1}l=J[N]}var g=C.CreateMesh(l);o.toplevel.add(g);g.graph=j;g.index=r;g.painter=o;g.scale0=0.3*O;g.tip_name=this.GetTipName();g.tip_color=(j.fMarkerColor===3)?16711680:65280;g.tooltip=this.Graph2DTooltip}}o.Render3D(100)};this.SetDivId(f,-1);this.options=this.DecodeOptions(e);if(this.main_painter()==null){if(d.fHistogram==null){d.fHistogram=this.CreateHistogram()}a.Painter.drawHistogram2D(f,d.fHistogram,"lego");this.ownhisto=true}this.SetDivId(f);this.Redraw();return this.DrawingReady()};a.TH3Painter=function(d){a.THistPainter.call(this,d);this.Create3DScene=a.Painter.HPainter_Create3DScene;this.mode3d=true};a.TH3Painter.prototype=Object.create(a.THistPainter.prototype);a.TH3Painter.prototype.ScanContent=function(h){if(h&&this.nbinsx&&this.nbinsy&&this.nbinsz){return}var e=this.GetObject();this.nbinsx=e.fXaxis.fNbins;this.nbinsy=e.fYaxis.fNbins;this.nbinsz=e.fZaxis.fNbins;this.xmin=e.fXaxis.fXmin;this.xmax=e.fXaxis.fXmax;this.ymin=e.fYaxis.fXmin;this.ymax=e.fYaxis.fXmax;this.zmin=e.fZaxis.fXmin;this.zmax=e.fZaxis.fXmax;this.gminbin=this.gmaxbin=e.getBinContent(1,1,1);for(var g=0;g<this.nbinsx;++g){for(var f=0;f<this.nbinsy;++f){for(var d=0;d<this.nbinsz;++d){var l=e.getBinContent(g+1,f+1,d+1);if(l<this.gminbin){this.gminbin=l}else{if(l>this.gmaxbin){this.gmaxbin=l}}}}}this.draw_content=this.gmaxbin>0;this.CreateAxisFuncs(true,true)};a.TH3Painter.prototype.CountStat=function(){var r=this.GetObject(),j=0,q=0,x=0,g=0,n=0,v=0,f=0,w=this.GetSelectIndex("x","left"),u=this.GetSelectIndex("x","right"),e=this.GetSelectIndex("y","left"),d=this.GetSelectIndex("y","right"),p=this.GetSelectIndex("z","left"),m=this.GetSelectIndex("z","right"),B={entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},t,A,l,k,i,s,y,z,o,h;for(t=0;t<this.nbinsx+2;++t){k=this.GetBinX(t-0.5);i=(t<w)?0:(t>u?2:1);for(A=0;A<this.nbinsy+2;++A){s=this.GetBinY(A-0.5);y=(A<e)?0:(A>d?2:1);for(l=0;l<this.nbinsz+2;++l){z=this.GetBinZ(l-0.5);o=(l<p)?0:(l>m?2:1);h=r.getBinContent(t,A,l);B.entries+=h;if((i==1)&&(y==1)&&(o==1)){j+=h;q+=k*h;x+=s*h;g+=z*h;n+=k*k*h;v+=s*s*h;f+=z*z*h}}}}if((r.fTsumw>0)&&!this.IsAxisZoomed("x")&&!this.IsAxisZoomed("y")&&!this.IsAxisZoomed("z")){j=r.fTsumw;q=r.fTsumwx;n=r.fTsumwx2;x=r.fTsumwy;v=r.fTsumwy2;g=r.fTsumwz;f=r.fTsumwz2}if(j>0){B.meanx=q/j;B.meany=x/j;B.meanz=g/j;B.rmsx=Math.sqrt(Math.abs(n/j-B.meanx*B.meanx));B.rmsy=Math.sqrt(Math.abs(v/j-B.meany*B.meany));B.rmsz=Math.sqrt(Math.abs(f/j-B.meanz*B.meanz))}B.integral=j;if(r.fEntries>1){B.entries=r.fEntries}return B};a.TH3Painter.prototype.FillStatistic=function(h,j,q){if(this.GetObject()===null){return false}var i=h.GetObject(),g=this.CountStat(),l=j%10,o=Math.floor(j/10)%10,k=Math.floor(j/100)%10,n=Math.floor(j/1000)%10,d=Math.floor(j/10000)%10,e=Math.floor(j/100000)%10,f=Math.floor(j/1000000)%10;if(l>0){i.AddText(this.GetObject().fName)}if(o>0){i.AddText("Entries = "+h.Format(g.entries,"entries"))}if(k>0){i.AddText("Mean x = "+h.Format(g.meanx));i.AddText("Mean y = "+h.Format(g.meany));i.AddText("Mean z = "+h.Format(g.meanz))}if(n>0){i.AddText("Std Dev x = "+h.Format(g.rmsx));i.AddText("Std Dev y = "+h.Format(g.rmsy));i.AddText("Std Dev z = "+h.Format(g.rmsz))}if(f>0){i.AddText("Integral = "+h.Format(g.integral,"entries"))}var m=i.fLines.arr.length,p=m*a.gStyle.StatFontSize;if(p<=0||3==(a.gStyle.StatFont%10)){p=0.25*m*a.gStyle.StatH;i.fY1NDC=0.93-p;i.fY2NDC=0.93}return true};a.TH3Painter.prototype.GetBinTips=function(g,d,i){var f=[],e=this.main_painter();f.push(this.GetTipName());if(e.x_kind=="labels"){f.push("x = "+e.AxisAsText("x",this.GetBinX(g))+"  xbin="+(g+1))}else{f.push("x = ["+e.AxisAsText("x",this.GetBinX(g))+", "+e.AxisAsText("x",this.GetBinX(g+1))+")   xbin="+(g+1))}if(e.y_kind=="labels"){f.push("y = "+e.AxisAsText("y",this.GetBinY(d))+"  ybin="+(d+1))}else{f.push("y = ["+e.AxisAsText("y",this.GetBinY(d))+", "+e.AxisAsText("y",this.GetBinY(d+1))+")  ybin="+(d+1))}if(e.z_kind=="labels"){f.push("z = "+e.AxisAsText("z",this.GetBinZ(i))+"  zbin="+(i+1))}else{f.push("z = ["+e.AxisAsText("z",this.GetBinZ(i))+", "+e.AxisAsText("z",this.GetBinZ(i+1))+")  zbin="+(i+1))}var h=this.GetObject().getBinContent(g+1,d+1,i+1);if(h===Math.round(h)){f.push("entries = "+h)}else{f.push("entries = "+a.FFormat(h,a.gStyle.fStatFormat))}return f};a.TH3Painter.prototype.Draw3DScatter=function(){var r=this.GetObject(),g=this.main_painter(),x=this.GetSelectIndex("x","left",0.5),w=this.GetSelectIndex("x","right",0),f=this.GetSelectIndex("y","left",0.5),d=this.GetSelectIndex("y","right",0),o=this.GetSelectIndex("z","left",0.5),m=this.GetSelectIndex("z","right",0),E=this.GetTipName("<br/>"),A,z,y,C;if((w<=x)||(d<=f)||(m<=o)){return true}var l=(this.gmaxbin>1000)?1000/this.gmaxbin:1,B=0;for(A=x;A<w;++A){for(z=f;z<d;++z){for(y=o;y<m;++y){C=r.getBinContent(A+1,z+1,y+1);if(C<=this.gminbin){continue}B+=Math.round(C*l)}}}if(B>(g.webgl?100000:10000)){return false}var t=new a.Painter.PointsCreator(B,g.webgl,g.size_xy3d/200),v=new Int32Array(B),D=0;for(A=x;A<w;++A){for(z=f;z<d;++z){for(y=o;y<m;++y){C=r.getBinContent(A+1,z+1,y+1);if(C<=this.gminbin){continue}var h=Math.round(C*l);for(var u=0;u<h;++u){var s=this.GetBinX(A+Math.random()),q=this.GetBinY(z+Math.random()),p=this.GetBinZ(y+Math.random());v[D++]=r.getBin(A+1,z+1,y+1);t.AddPoint(g.grx(s),g.gry(q),g.grz(p))}}}}var e=t.CreateMesh(a.Painter.root_colors[r.fMarkerColor]);g.toplevel.add(e);e.bins=v;e.painter=this;e.tip_color=(r.fMarkerColor===3)?16711680:65280;e.tooltip=function(i){var j=Math.floor(i.index/this.nvertex);if((j<0)||(j>=this.bins.length)){return null}var n=this.painter,k=n.Get3DToolTip(this.bins[j]);k.x1=n.grx(n.GetBinX(k.ix-1));k.x2=n.grx(n.GetBinX(k.ix));k.y1=n.gry(n.GetBinY(k.iy-1));k.y2=n.gry(n.GetBinY(k.iy));k.z1=n.grz(n.GetBinZ(k.iz-1));k.z2=n.grz(n.GetBinZ(k.iz));k.color=this.tip_color;k.opacity=0.3;return k};return true};a.TH3Painter.prototype.Draw3DBins=function(){if(!this.draw_content){return}if(!this.options.Box){if(this.Draw3DScatter()){return}}var ag=this.GetObject().fFillColor,r=a.Painter.root_colors[ag],X=null,T=0,s=null,e=0,B,ah;if(this.options.Box===11){X=new c.MeshLambertMaterial({color:r});var q=a.Painter.TestWebGL()?new c.SphereGeometry(0.5,16,12):new c.SphereGeometry(0.5,8,6);q.applyMatrix(new c.Matrix4().makeRotationX(Math.PI/2));T=q.faces.length*9;B=new Float32Array(T);ah=new Float32Array(T);for(var t=0;t<q.faces.length;++t){B[9*t]=q.vertices[q.faces[t].a].x;B[9*t+1]=q.vertices[q.faces[t].a].y;B[9*t+2]=q.vertices[q.faces[t].a].z;B[9*t+3]=q.vertices[q.faces[t].b].x;B[9*t+4]=q.vertices[q.faces[t].b].y;B[9*t+5]=q.vertices[q.faces[t].b].z;B[9*t+6]=q.vertices[q.faces[t].c].x;B[9*t+7]=q.vertices[q.faces[t].c].y;B[9*t+8]=q.vertices[q.faces[t].c].z;ah[9*t]=q.faces[t].vertexNormals[0].x;ah[9*t+1]=q.faces[t].vertexNormals[0].y;ah[9*t+2]=q.faces[t].vertexNormals[0].z;ah[9*t+3]=q.faces[t].vertexNormals[1].x;ah[9*t+4]=q.faces[t].vertexNormals[1].y;ah[9*t+5]=q.faces[t].vertexNormals[1].z;ah[9*t+6]=q.faces[t].vertexNormals[2].x;ah[9*t+7]=q.faces[t].vertexNormals[2].y;ah[9*t+8]=q.faces[t].vertexNormals[2].z}}else{X=new c.MeshBasicMaterial({color:r});var O=a.Painter.Box_Indexes,D=a.Painter.Box_Normals,d=a.Painter.Box_Vertices;T=O.length*3;B=new Float32Array(T);ah=new Float32Array(T);for(var Y=0,ai=-3;Y<O.length;++Y){var x=d[O[Y]];B[Y*3]=x.x-0.5;B[Y*3+1]=x.y-0.5;B[Y*3+2]=x.z-0.5;if(Y%6===0){ai+=3}ah[Y*3]=D[ai];ah[Y*3+1]=D[ai+1];ah[Y*3+2]=D[ai+2]}e=1}var w=this.GetObject(),p=this.GetSelectIndex("x","left",0.5),o=this.GetSelectIndex("x","right",0),ad=this.GetSelectIndex("y","left",0.5),aa=this.GetSelectIndex("y","right",0),I=this.GetSelectIndex("z","left",0.5),H=this.GetSelectIndex("z","right",0),u=this.GetTipName("<br/>");if((o<=p)||(aa<=ad)||(H<=I)){return}var A=(this.grx(this.GetBinX(o))-this.grx(this.GetBinX(p)))/(o-p),z=(this.gry(this.GetBinY(aa))-this.gry(this.GetBinY(ad)))/(aa-ad),y=(this.grz(this.GetBinZ(H))-this.grz(this.GetBinZ(I)))/(H-I);var W=0,ac,Z,Y,h,f;for(ac=p;ac<o;++ac){for(Z=ad;Z<aa;++Z){for(Y=I;Y<H;++Y){f=w.getBinContent(ac+1,Z+1,Y+1);if(f<=this.gminbin){continue}h=Math.pow(Math.abs(f/this.gmaxbin),0.3333);if(h<0.001){continue}W++}}}if((e===1)&&(W*T/3>65520)){e=2}var l=new Float32Array(W*T),P=new Float32Array(W*T),Q=new Int32Array(W),U,S,m;if(e===1){U=a.Painter.Box_MeshSegments;S=new Uint16Array(W*U.length)}if(e===2){U=a.Painter.Box_Segments;m=new Float32Array(W*U.length*3)}var af,M,ae,L,ab,K;W=0;for(ac=p;ac<o;++ac){af=this.GetBinX(ac+0.5);M=this.grx(af);for(Z=ad;Z<aa;++Z){ae=this.GetBinY(Z+0.5);L=this.gry(ae);for(Y=I;Y<H;++Y){f=w.getBinContent(ac+1,Z+1,Y+1);if(f<=this.gminbin){continue}h=Math.pow(Math.abs(f/this.gmaxbin),0.3333);if(h<0.001){continue}ab=this.GetBinZ(Y+0.5);K=this.grz(ab);Q[W]=w.getBin(ac+1,Z+1,Y+1);var J=W*T;for(var C=0;C<T;C+=3,J+=3){l[J]=M+B[C]*A*h;l[J+1]=L+B[C+1]*z*h;l[J+2]=K+B[C+2]*y*h;P[J]=ah[C];P[J+1]=ah[C+1];P[J+2]=ah[C+2]}if(e===1){J=W*U.length;var G=Math.round(W*T/3);for(var V=0;V<U.length;++V){S[J+V]=G+U[V]}}if(e===2){J=W*U.length*3;for(var V=0;V<U.length;++V,J+=3){var x=a.Painter.Box_Vertices[U[V]];m[J]=M+(x.x-0.5)*A*h;m[J+1]=L+(x.y-0.5)*z*h;m[J+2]=K+(x.z-0.5)*y*h}}W++}}}var g=new c.BufferGeometry();g.addAttribute("position",new c.BufferAttribute(l,3));g.addAttribute("normal",new c.BufferAttribute(P,3));var v=new c.Mesh(g,X);v.bins=Q;v.bins_faces=T/3;v.painter=this;var R=(this.options.Box===11)?0.4:0.5;v.scalex=R*A;v.scaley=R*z;v.scalez=R*y;v.tip_color=(ag===3)?16711680:65280;v.tooltip=function(i){var ak=Math.floor(i.index/this.bins_faces);if((ak<0)||(ak>=this.bins.length)){return null}var am=this.painter,al=am.Get3DToolTip(this.bins[ak]),n=am.grx(am.GetBinX(al.ix-0.5)),k=am.gry(am.GetBinY(al.iy-0.5)),j=am.grz(am.GetBinZ(al.iz-0.5)),aj=Math.pow(Math.abs(al.value/am.gmaxbin),0.3333);al.x1=n-this.scalex*aj;al.x2=n+this.scalex*aj;al.y1=k-this.scaley*aj;al.y2=k+this.scaley*aj;al.z1=j-this.scalez*aj;al.z2=j+this.scalez*aj;al.color=this.tip_color;return al};this.toplevel.add(v);if(e>0){var F=new c.BufferGeometry();if(e===1){F.setIndex(new c.BufferAttribute(S,1));F.addAttribute("position",new c.BufferAttribute(l,3))}else{F.addAttribute("position",new c.BufferAttribute(m,3))}var E=new c.LineBasicMaterial({color:0});var N=new c.LineSegments(F,E);this.toplevel.add(N)}};a.TH3Painter.prototype.Redraw=function(d){if(d){if(this.Resize3D()){this.Render3D()}}else{this.Create3DScene();this.DrawXYZ(this.toplevel,{zoom:a.gStyle.Zooming});this.Draw3DBins();this.Render3D();this.AddKeysHandler()}this.DrawTitle()};a.TH3Painter.prototype.FillToolbar=function(){var d=this.pad_painter(true);if(d===null){return}d.AddButton(a.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *");if(this.draw_content){d.AddButton(a.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox")}};a.TH3Painter.prototype.CanZoomIn=function(f,e,d){if((f=="x")&&(this.GetIndexX(d,0.5)-this.GetIndexX(e,0)>1)){return true}if((f=="y")&&(this.GetIndexY(d,0.5)-this.GetIndexY(e,0)>1)){return true}if((f=="z")&&(this.GetIndexZ(d,0.5)-this.GetIndexZ(e,0)>1)){return true}return false};a.TH3Painter.prototype.AutoZoom=function(){var s=this.GetSelectIndex("x","left"),q=this.GetSelectIndex("x","right"),e=this.GetSelectIndex("y","left"),d=this.GetSelectIndex("y","right"),h=this.GetSelectIndex("z","left"),g=this.GetSelectIndex("z","right"),x,v,u,m=this.GetObject();if((s===q)||(e===d)||(h===g)){return}var r=m.getBinContent(s+1,e+1,h+1);for(x=s;x<q;++x){for(v=e;v<d;++v){for(u=h;u<g;++u){r=Math.min(r,m.getBinContent(x+1,v+1,u+1))}}}if(r>0){return}var D=q,w=s,o=d,A=e,f=g,C=h;for(x=s;x<q;++x){for(v=e;v<d;++v){for(u=h;u<g;++u){if(m.getBinContent(x+1,v+1,u+1)>r){if(x<D){D=x}if(x>=w){w=x+1}if(v<o){o=v}if(v>=A){A=v+1}if(u<f){f=u}if(u>=C){C=u+1}}}}}var n,p,t,y,z,B,l=false;if((D===w-1)&&(D>s+1)&&(w<q-1)){D--;w++}if((o===A-1)&&(o>e+1)&&(A<d-1)){o--;A++}if((f===C-1)&&(f>h+1)&&(C<g-1)){f--;C++}if((D>s||w<q)&&(D<w-1)){n=this.GetBinX(D);p=this.GetBinX(w);l=true}if((o>e||A<d)&&(o<A-1)){t=this.GetBinY(o);y=this.GetBinY(A);l=true}if((f>h||C<g)&&(f<C-1)){z=this.GetBinZ(f);B=this.GetBinZ(C);l=true}if(l){this.Zoom(n,p,t,y,z,B)}};a.TH3Painter.prototype.FillHistContextMenu=function(e){var d=a.getDrawSettings("ROOT."+this.GetObject()._typename,"nosame");e.addDrawMenu("Draw with",d.opts,function(f){if(f==="inspect"){return a.draw(this.divid,this.GetObject(),f)}this.options=this.DecodeOptions(f);this.Redraw()})};a.Painter.drawHistogram3D=function(g,d,f){a.extend(this,new a.TH3Painter(d));this.SetDivId(g,4);this.options=this.DecodeOptions(f);this.CheckPadRange();this.ScanContent();this.Redraw();if(a.gStyle.AutoStat&&this.create_canvas){var e=this.CreateStat(d.$custom_stat);if(e){a.draw(this.divid,e,"")}}this.FillToolbar();return this.DrawingReady()};a.Painter.drawPolyMarker3D=function(f,e,d){this.SetDivId(f);this.Redraw=function(){var h=this.main_painter();if(!h||!("renderer" in h)){return}var g=1,m=h.webgl?50000:5000,k=0;for(var l=0;l<e.fP.length;l+=3){if((e.fP[l]<h.scale_xmin)||(e.fP[l]>h.scale_xmax)||(e.fP[l+1]<h.scale_ymin)||(e.fP[l+1]>h.scale_ymax)||(e.fP[l+2]<h.scale_zmin)||(e.fP[l+2]>h.scale_zmax)){continue}++k}if((a.gStyle.OptimizeDraw>0)&&(k>m)){g=Math.floor(k/m);if(g<=2){g=2}}var r=Math.floor(k/g),j=new a.Painter.PointsCreator(r,h.webgl,h.size_xy3d/100),n=new Int32Array(r),o=0,p=0;for(var l=0;l<e.fP.length;l+=3){if((e.fP[l]<h.scale_xmin)||(e.fP[l]>h.scale_xmax)||(e.fP[l+1]<h.scale_ymin)||(e.fP[l+1]>h.scale_ymax)||(e.fP[l+2]<h.scale_zmin)||(e.fP[l+2]>h.scale_zmax)){continue}if(g>1){o=(o+1)%g;if(o!==0){continue}}n[p++]=l;j.AddPoint(h.grx(e.fP[l]),h.gry(e.fP[l+1]),h.grz(e.fP[l+2]))}var q=j.CreateMesh(a.Painter.root_colors[e.fMarkerColor]);h.toplevel.add(q);q.tip_color=(e.fMarkerColor===3)?16711680:65280;q.poly=e;q.painter=h;q.scale0=0.7*j.scale;q.index=n;q.tooltip=function(i){var v=Math.floor(i.index/this.nvertex);if((v<0)||(v>=this.index.length)){return null}v=this.index[v];var x=this.painter;var w={info:"bin: "+v/3+"<br/>x: "+x.x_handle.format(this.poly.fP[v])+"<br/>y: "+x.y_handle.format(this.poly.fP[v+1])+"<br/>z: "+x.z_handle.format(this.poly.fP[v+2])};var u=x.grx(this.poly.fP[v]),t=x.gry(this.poly.fP[v+1]),s=x.grz(this.poly.fP[v+2]);w.x1=u-this.scale0;w.x2=u+this.scale0;w.y1=t-this.scale0;w.y2=t+this.scale0;w.z1=s-this.scale0;w.z2=s+this.scale0;w.color=this.tip_color;return w};h.Render3D(100)};this.Redraw();return this.DrawingReady()};return a.Painter}));