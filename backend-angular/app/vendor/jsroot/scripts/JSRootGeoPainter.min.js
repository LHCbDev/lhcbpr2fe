(function(a){if(typeof define==="function"&&define.amd){define(["d3","JSRootPainter","threejs","JSRoot3DPainter","JSRootGeoBase"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof d3=="undefined"){throw new Error("d3 is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}a(d3,JSROOT,THREE)}}(function(b,a,c){if(typeof define==="function"&&define.amd){a.loadScript("$$$style/JSRootGeoPainter.css")}if(typeof a.GEO!=="object"){console.error("JSROOT.GEO namespace is not defined")}a.TGeoPainter=function(d,e){if(d&&(d._typename.indexOf("TGeoVolume")===0)){d={_typename:"TGeoNode",fVolume:d,fName:d.fName,_geoh:d._geoh,_proxy:true}}a.TObjectPainter.call(this,d);this.no_default_title=true;this.is_geo_manager=e;this.Cleanup(true)};a.TGeoPainter.prototype=Object.create(a.TObjectPainter.prototype);a.TGeoPainter.prototype.CreateToolbar=function(e){if(this._toolbar){return}var d=this;var f=[{name:"toImage",title:"Save as PNG",icon:a.ToolbarIcons.camera,click:function(){d.Render3D(0);var h=d._renderer.domElement.toDataURL("image/png");h.replace("image/png","image/octet-stream");var g=document.createElement("a");if(typeof g.download==="string"){document.body.appendChild(g);g.download="geometry.png";g.href=h;g.click();document.body.removeChild(g)}}}];if(a.hpainter&&a.hpainter.nobrowser){f.push({name:"browser",title:"Show hierarchy browser",icon:a.ToolbarIcons.arrow_right,click:function(){if(a.hpainter){a.hpainter.ToggleFloatBrowser()}}})}if(a.gStyle.ContextMenu){f.push({name:"menu",title:"Show context menu",icon:a.ToolbarIcons.question,click:function(){var g=b.event;b.event.preventDefault();b.event.stopPropagation();a.Painter.createMenu(function(h){h.painter=d;d.FillContextMenu(h);h.show(g)})}})}this._toolbar=new a.Toolbar(this.select_main(),[f])};a.TGeoPainter.prototype.ModifyVisisbility=function(e,d){if(a.GEO.NodeKind(this.GetObject())!==0){return}if(e==""){return a.GEO.SetBit(this.GetObject().fVolume,a.GEO.BITS.kVisThis,(d==="+"))}var g,f=false;if(e.indexOf("*")<0){g=new RegExp("^"+e+"$");f=true}else{g=new RegExp("^"+e.split("*").join(".*")+"$");f=false}this.FindNodeWithVolume(g,function(h){a.GEO.InvisibleAll.call(h.node.fVolume,(d!=="+"));return f?h:null})};a.TGeoPainter.prototype.decodeOptions=function(f){var o={_grid:false,_bound:false,_debug:false,_full:false,_axis:false,_count:false,wireframe:false,scale:new c.Vector3(1,1,1),more:1,maxlimit:100000,maxnodeslimit:3000,use_worker:false,update_browser:true,show_controls:false,highlight:false,select_in_view:false,clipx:false,clipy:false,clipz:false,ssao:false,script_name:"",transparancy:1,autoRotate:false};var m=a.GetUrlOption("_grid");if(m!==null&&m=="true"){o._grid=true}var m=a.GetUrlOption("_debug");if(m!==null&&m=="true"){o._debug=true;o._grid=true}if(m!==null&&m=="bound"){o._debug=true;o._grid=true;o._bound=true}if(m!==null&&m=="full"){o._debug=true;o._grid=true;o._full=true;o._bound=true}var j=f.indexOf("macro:");if(j>=0){var k=f.indexOf(";",j+6);if(k<0){k=f.length}o.script_name=f.substr(j+6,k-j-6);f=f.substr(0,j)+f.substr(k+1);console.log("script",o.script_name,"rest",f)}while(true){var g=f.indexOf("+"),l=f.indexOf("-");if((g<0)&&(l<0)){break}var q=g,h="+";if((q<0)||((l>=0)&&(l<g))){q=l;h="-"}var p=q+1,n=new RegExp("[,; .]");while((p<f.length)&&!n.test(f[p])&&(f[p]!="+")&&(f[p]!="-")){p++}var d=f.substring(q+1,p);f=f.substr(0,q)+f.substr(p);this.ModifyVisisbility(d,h)}f=f.toLowerCase();function e(r){var s=f.indexOf(r);if(s<0){return false}f=f.substr(0,s)+f.substr(s+r.length);return true}function i(s,u){var t=f.indexOf(s);if(t<0){return u}f=f.substr(0,t)+f.substr(t+s.length);var r=t;while((r<f.length)&&(f.charAt(r).match(/[0-9]/))){r++}if(r>t){u=parseInt(f.substr(t,r-t))}f=f.substr(0,t)+f.substr(r);return u}if(e("more3")){o.more=3}if(e("more")){o.more=2}if(e("all")){o.more=100}if(e("invx")||e("invertx")){o.scale.x=-1}if(e("controls")||e("ctrl")){o.show_controls=true}if(e("clipxyz")){o.clipx=o.clipy=o.clipz=true}if(e("clipx")){o.clipx=true}if(e("clipy")){o.clipy=true}if(e("clipz")){o.clipz=true}if(e("clip")){o.clipx=o.clipy=o.clipz=true}if(e("dflt_colors")){this.SetRootDefaultColors()}if(e("ssao")){o.ssao=true}if(e("noworker")){o.use_worker=-1}if(e("worker")){o.use_worker=1}if(e("highlight")){o.highlight=true}if(e("wire")){o.wireframe=true}if(e("rotate")){o.autoRotate=true}if(e("invy")){o.scale.y=-1}if(e("invz")){o.scale.z=-1}if(e("count")){o._count=true}o.transparancy=i("transp",100)/100;if(e("axis")||e("a")){o._axis=true;o._yup=false}if(e("d")){o._debug=true}if(e("g")){o._grid=true}if(e("b")){o._bound=true}if(e("w")){o.wireframe=true}if(e("f")){o._full=true}if(e("y")){o._yup=true}if(e("z")){o._yup=false}return o};a.TGeoPainter.prototype.ActiavteInBrowser=function(e,d){if(typeof e=="string"){e=[e]}if(a.hpainter){if(a.hpainter.nobrowser&&d){a.hpainter.ToggleFloatBrowser(true)}a.hpainter.actiavte(e,d);if(!this.options.update_browser){setTimeout(function(){a.hpainter.actiavte([])},2000)}}};a.TGeoPainter.prototype.TestMatrixes=function(){var f=this,h=0,e=0,i=0;var d={domatrix:true,func:function(l){var q=this.getmatrix();var p=this.CopyStack();var s=f._clones.CreateObject3D(p.stack,f._toplevel,"mesh");if(!s){return true}e++;var r=s.matrixWorld,n,j;if(r.equals(q)){return true}if((r.determinant()>0)&&(q.determinant()<-0.9)){n=c.Vector3(1,1,-1);j=q;q=q.clone().scale(n);if(r.equals(q)){return true}}var o=0;for(var m=0;m<16;++m){o=Math.max(o,Math.abs(r.elements[m]-q.elements[m]))}i=Math.max(o,i);if(o<0.0001){return true}console.log(f._clones.ResolveStack(p.stack).name,"maxdiff",o,"determ",r.determinant(),q.determinant());h++;return false}};tm1=new Date().getTime();var g=this._clones.ScanVisible(d);tm2=new Date().getTime();console.log("Compare matrixes total",e,"errors",h,"takes",tm2-tm1,"maxdiff",i)};a.TGeoPainter.prototype.FillContextMenu=function(d){d.add("header: Draw options");d.addchk(this.options.update_browser,"Browser update",function(){this.options.update_browser=!this.options.update_browser;if(!this.options.update_browser){this.ActiavteInBrowser([])}});d.addchk(this.options.show_controls,"Show Controls",function(){this.options.show_controls=!this.options.show_controls;this.showControlOptions(this.options.show_controls)});d.addchk(this.TestAxisVisibility,"Show axes",function(){this.toggleAxisDraw()});d.addchk(this.options.wireframe,"Wire frame",function(){this.options.wireframe=!this.options.wireframe;this.changeWireFrame(this._scene,this.options.wireframe)});d.addchk(this.options.highlight,"Highlight volumes",function(){this.options.highlight=!this.options.highlight});d.addchk(this.options.wireframe,"Reset camera position",function(){this.focusCamera();this.Render3D()});d.addchk(this.options.autoRotate,"Autorotate",function(){this.options.autoRotate=!this.options.autoRotate;this.autorotate(2.5)});d.addchk(this.options.select_in_view,"Select in view",function(){this.options.select_in_view=!this.options.select_in_view;if(this.options.select_in_view){this.startDrawGeometry()}})};a.TGeoPainter.prototype.changeGlobalTransparancy=function(e,d){this._toplevel.traverse(function(f){if(f instanceof c.Mesh){if(f.material.alwaysTransparent!==undefined){if(!f.material.alwaysTransparent){f.material.transparent=e!==1}f.material.opacity=Math.min(e*e,f.material.inherentOpacity)}}});if(!d){this.Render3D(0)}};a.TGeoPainter.prototype.showControlOptions=function(h){if(this._datgui){if(h){return}this._datgui.destroy();delete this._datgui;return}if(!h){return}var m=this;this._datgui=new dat.GUI({width:Math.min(650,m._renderer.domElement.width/2)});var d=new c.Box3().setFromObject(this._toplevel);d.expandByVector(d.getSize().multiplyScalar(0.01));var f=this._datgui.addFolder("Clipping");var k=f.add(this,"enableX").name("Enable X").listen();k.onChange(function(p){m.enableX=p;m._enableSSAO=p?false:m._enableSSAO;m.updateClipping()});if(this.clipX===0){this.clipX=(d.min.x+d.max.x)/2}var n=f.add(this,"clipX",d.min.x,d.max.x).name("X Position");n.onChange(function(p){m.clipX=p;if(m.enableX){m.updateClipping()}});var j=f.add(this,"enableY").name("Enable Y").listen();j.onChange(function(p){m.enableY=p;m._enableSSAO=p?false:m._enableSSAO;m.updateClipping()});if(this.clipY===0){this.clipY=(d.min.y+d.max.y)/2}var l=f.add(this,"clipY",d.min.y,d.max.y).name("Y Position");l.onChange(function(p){m.clipY=p;if(m.enableY){m.updateClipping()}});var g=f.add(this,"enableZ").name("Enable Z").listen();g.onChange(function(p){m.enableZ=p;m._enableSSAO=p?false:m._enableSSAO;m.updateClipping()});if(this.clipZ===0){this.clipZ=(d.min.z+d.max.z)/2}var i=f.add(this,"clipZ",d.min.z,d.max.z).name("Z Position");i.onChange(function(p){m.clipZ=p;if(m.enableZ){m.updateClipping()}});var e=this._datgui.addFolder("Appearance");if(this._webgl){e.add(this,"_enableSSAO").name("Smooth Lighting (SSAO)").onChange(function(p){m._renderer.antialias=!m._renderer.antialias;m.enableX=p?false:m.enableX;m.enableY=p?false:m.enableY;m.enableZ=p?false:m.enableZ;m.updateClipping()}).listen()}e.add(this.options,"highlight").name("Highlight Selection").onChange(function(p){if(p===false){if(m._selected.mesh!==null){m._selected.mesh.material.color=m._selected.originalColor;m.Render3D(0);m._selected.mesh=null}}});e.add(this.options,"transparancy",0,1).listen().onChange(this.changeGlobalTransparancy.bind(this));e.add(this.options,"wireframe").name("Wireframe").onChange(function(p){m.changeWireFrame(m._scene,m.options.wireframe)});e.add(this,"focusCamera").name("Reset camera position");if(this._webgl){var o=this._datgui.addFolder("Advanced");o.add(this._advceOptions,"aoClamp",0,1).listen().onChange(function(p){m._ssaoPass.uniforms.aoClamp.value=p;m._enableSSAO=true;m.Render3D(0)});o.add(this._advceOptions,"lumInfluence",0,1).listen().onChange(function(p){m._ssaoPass.uniforms.lumInfluence.value=p;m._enableSSAO=true;m.Render3D(0)});o.add(this._advceOptions,"clipIntersection").listen().onChange(function(p){m.clipIntersection=p;m.updateClipping()});o.add(this._advceOptions,"depthTest").onChange(function(p){m._toplevel.traverse(function(q){if(q instanceof c.Mesh){q.material.depthTest=p}});m.Render3D(0)}).listen();o.add(this,"resetAdvanced").name("Reset")}};a.TGeoPainter.prototype.OrbitContext=function(f,e){var d=this;a.Painter.createMenu(function(i){i.painter=d;var r=0,l=0,k=0;if(e){for(var j=0;j<e.length;++j){if(e[j].object.stack){l++}if(e[j].object.geo_name){r++}}}if(l+r===0){d.FillContextMenu(i)}else{var h=(l+r)>1;if(h){i.add("header:"+((r>0)?"Items":"Nodes"))}for(var j=0;j<e.length;++j){var m=e[j].object,g,p,q;if(m.geo_name){p=m.geo_name;g=p.substr(p.lastIndexOf("/")+1);if(!g){g=p}q=g}else{if(m.stack){g=d._clones.ResolveStack(m.stack).name;p=d.GetStackFullName(m.stack);q=d.GetItemName();if(g.indexOf("Nodes/")===0){q=g.substr(6)}else{if(g.length>0){q=g}else{if(!q){q="header"}}}}else{continue}}i.add((h?"sub:":"header:")+q,p,function(n){this.ActiavteInBrowser([n],true)});i.add("Browse",p,function(n){this.ActiavteInBrowser([n],true)});if(m.geo_name){i.add("Hide",j,function(n){var s=e[n].object;s.visible=false;if(s.geo_object){s.geo_object._hidden_via_menu=true}d.Render3D()});if(h){i.add("endsub:")}continue}var o=d.accessObjectWireFrame(m);if(o!==undefined){i.addchk(o,"Wireframe",j,function(s){var n=e[s].object.material;n.wireframe=!n.wireframe;this.Render3D()})}if(++k>1){i.add("Manifest",j,function(s){if(this._last_manifest){this._last_manifest.wireframe=!this._last_manifest.wireframe}if(this._last_hidden){this._last_hidden.forEach(function(t){t.visible=true})}this._last_hidden=[];for(var n=0;n<s;++n){this._last_hidden.push(e[n].object)}this._last_hidden.forEach(function(t){t.visible=false});this._last_manifest=e[s].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()})}i.add("Focus",j,function(n){this.focusCamera(e[n].object)});i.add("Hide",j,function(n){var s=d._clones.ResolveStack(e[n].object.stack);if(s.obj&&(s.node.kind===0)&&s.obj.fVolume){a.GEO.SetBit(s.obj.fVolume,a.GEO.BITS.kVisThis,false);a.GEO.updateBrowserIcons(s.obj.fVolume,a.hpainter)}else{if(s.obj&&(s.node.kind===1)){s.obj.fRnrSelf=false;a.GEO.updateBrowserIcons(s.obj,a.hpainter)}}this.testGeomChanges()});if(h){i.add("endsub:")}}}i.show(f)})};a.TGeoPainter.prototype.FilterIntersects=function(l){for(var d=l.length-1;d>=0;--d){var h=l[d].object;var f=(h.stack!==undefined)||(h.geo_name!==undefined);for(var e=0;(e<d)&&f;++e){if(l[e].object===h){f=false}}if(!f){l.splice(d,1)}}if(this.enableX||this.enableY||this.enableZ){var o=[];for(var j=0;j<l.length;++j){var g=false;var m=l[j].point;if(this.enableX&&this._clipPlanes[0].normal.dot(m)>this._clipPlanes[0].constant){g=true}if(this.enableY&&this._clipPlanes[1].normal.dot(m)>this._clipPlanes[1].constant){g=true}if(this.enableZ&&this._clipPlanes[2].normal.dot(m)>this._clipPlanes[2].constant){g=true}if(g){o.push(l[j])}}l=o}return l};a.TGeoPainter.prototype.testCameraPositionChange=function(){if(!this.options.select_in_view||this._draw_all_nodes){return}var d=a.GEO.CreateProjectionMatrix(this._camera);var e=a.GEO.CreateFrustum(d);if(!e.CheckBox(new c.Box3().setFromObject(this._toplevel))){this.startDrawGeometry()}};a.TGeoPainter.prototype.GetStackFullName=function(e){var d=this.GetItemName();if(!e||!this._clones){return d}var f=this._clones.ResolveStack(e).name;if(d){f=d+(f?("/"+f):"")}return f};a.TGeoPainter.prototype.addOrbitControls=function(){if(this._controls){return}var d=this;this._controls=a.Painter.CreateOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=function(e){var f=null;if(d.options.highlight){if(d._selected.mesh!==null){d._selected.mesh.material.color=d._selected.originalColor;if(d._selected.mesh.hightlightLineWidth){d._selected.mesh.material.linewidth=d._selected.mesh.hightlightLineWidth/3}if(d._selected.mesh.highlightMarkerSize){d._selected.mesh.material.size=d._selected.mesh.highlightMarkerSize/3}}if(e.length>0){d._selected.mesh=e[0].object;d._selected.originalColor=d._selected.mesh.material.color;d._selected.mesh.material.color=new c.Color(16755251);if(d._selected.mesh.hightlightLineWidth){d._selected.mesh.material.linewidth=d._selected.mesh.hightlightLineWidth}if(d._selected.mesh.highlightMarkerSize){d._selected.mesh.material.size=d._selected.mesh.highlightMarkerSize}d.Render3D(0);if(e[0].object.stack){f=d.GetStackFullName(e[0].object.stack)}else{if(e[0].object.geo_name){f=e[0].object.geo_name}}}}if(e.length===0&&d._selected.mesh!==null){d._selected.mesh.material.color=d._selected.originalColor;d.Render3D(0);d._selected.mesh=null}var h=[];if(d.options.update_browser){if(d.options.highlight){if(f!==null){h.push(f)}}else{for(var i=0;i<e.length;++i){var g=e[i].object;if(g.geo_name){h.push(g.geo_name)}else{if(g.stack){h.push(d.GetStackFullName(g.stack))}}}}d.ActiavteInBrowser(h)}return f};this._controls.ProcessMouseLeave=function(){if(d.options.update_browser){d.ActiavteInBrowser([])}};this._controls.ProcessDblClick=function(){if(d._last_manifest){d._last_manifest.wireframe=!d._last_manifest.wireframe;if(d._last_hidden){d._last_hidden.forEach(function(e){e.visible=true})}delete d._last_hidden;delete d._last_manifest;d.Render3D()}else{d.adjustCameraPosition()}}};a.TGeoPainter.prototype.addTransformControl=function(){if(this._tcontrols){return}if(!this.options._debug&&!this.options._grid){return}this._tcontrols=new c.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);var d=this;window.addEventListener("keydown",function(e){switch(e.keyCode){case 81:d._tcontrols.setSpace(d._tcontrols.space==="local"?"world":"local");break;case 17:d._tcontrols.setTranslationSnap(Math.ceil(d._overall_size)/50);d._tcontrols.setRotationSnap(c.Math.degToRad(15));break;case 84:d._tcontrols.setMode("translate");break;case 82:d._tcontrols.setMode("rotate");break;case 83:d._tcontrols.setMode("scale");break;case 187:case 107:d._tcontrols.setSize(d._tcontrols.size+0.1);break;case 189:case 109:d._tcontrols.setSize(Math.max(d._tcontrols.size-0.1,0.1));break}});window.addEventListener("keyup",function(e){switch(e.keyCode){case 17:d._tcontrols.setTranslationSnap(null);d._tcontrols.setRotationSnap(null);break}});this._tcontrols.addEventListener("change",function(){d.Render3D(0)})};a.TGeoPainter.prototype.createFlippedMesh=function(r,l,k){var i=new c.Vector3(1,1,-1);if(l.geomZ===undefined){if(l.geom.type=="BufferGeometry"){var q=l.geom.getAttribute("position").array,e=l.geom.getAttribute("normal").array,j=q.length,g,f=0,p=new Float32Array(j),h=new Float32Array(j);for(g=0;g<j;g+=3){p[g]=q[g+f];p[g+1]=q[g+1+f];p[g+2]=-q[g+2+f];h[g]=e[g+f];h[g+1]=e[g+1+f];h[g+2]=-e[g+2+f];f+=3;if(f===6){f=-3}}l.geomZ=new c.BufferGeometry();l.geomZ.addAttribute("position",new c.BufferAttribute(p,3));l.geomZ.addAttribute("normal",new c.BufferAttribute(h,3))}else{l.geomZ=l.geom.clone();l.geomZ.scale(i.x,i.y,i.z);var o,m;for(var g=0;g<l.geomZ.faces.length;++g){o=geom.faces[g];m=o.b;o.b=o.c;o.c=m}}}var s=new c.Mesh(l.geomZ,k);s.scale.copy(i);s.updateMatrix();return s};a.TGeoPainter.prototype.nextDrawAction=function(){if(!this._clones||(this.drawing_stage==0)){return false}if(this.drawing_stage==1){if(this.options.use_worker>0){if(!this._worker){this.startWorker();return 1}if(!this._worker_ready){return 1}}var p=this._clones.MarkVisisble(),u=null,o=null;if(this.options.select_in_view&&!this._first_drawing){u=a.GEO.CreateProjectionMatrix(this._camera);o=a.GEO.CreateFrustum(u);if(o.CheckBox(new c.Box3().setFromObject(this._toplevel))){u=null;o=null}}this._current_face_limit=this.options.maxlimit;this._current_nodes_limit=this.options.maxnodeslimit;if(u){this._current_face_limit*=1.25;this._current_nodes_limit*=1.25}var r=(p>10000)||(u&&(this._clones.ScanVisible()>100000));if(r&&a.source_dir.indexOf("file://")==0){console.log("disable worker for jsroot from file system");r=false}if(r&&!this._worker&&(this.options.use_worker>=0)){this.startWorker()}if(!r||!this._worker_ready){var A=this._clones.CollectVisibles(this._current_face_limit,o,this._current_nodes_limit);this._new_draw_nodes=A.lst;this._draw_all_nodes=A.complete;this.drawing_stage=3;return true}var l={collect:this._current_face_limit,collect_nodes:this._current_nodes_limit,visible:this._clones.GetVisibleFlags(),matrix:u?u.elements:null};this.submitToWorker(l);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==2){this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==3){this.drawing_log="Analyse visibles";if(this._draw_nodes){var m=this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(var t=0;t<m.length;++t){this._clones.CreateObject3D(m[t].stack,this._toplevel,"delete_mesh")}if(m.length>0){this.drawing_log="Delete "+m.length+" nodes"}}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return true}if(this.drawing_stage===4){this.drawing_log="Collect shapes";var s=this._clones.CollectShapes(this._draw_nodes);this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,s);this.drawing_stage=5;return true}if(this.drawing_stage===5){if(this.canSubmitToWorker()){var l={limit:this._current_face_limit,shapes:[]},v=0;for(var t=0;t<this._build_shapes.length;++t){var y=null,x=this._build_shapes[t];if(x.ready||x.geom){y={id:x.id,ready:true,nfaces:a.GEO.numGeometryFaces(x.geom),refcnt:x.refcnt}}else{y=a.clone(x,null,true);v++}l.shapes.push(y)}if(v>0){this.submitToWorker(l);this.drawing_log="Worker build shapes";this.drawing_stage=6;return 2}}this.drawing_stage=7}if(this.drawing_stage===6){return 2}if((this.drawing_stage===7)||(this.drawing_stage===8)){if(this.drawing_stage===7){var A=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500);if(A.done){this.drawing_stage=8}else{this.drawing_log="Creating: "+A.shapes+" / "+this._build_shapes.length+" shapes,  "+A.faces+" faces";if(A.notusedshapes<30){return true}}}var j=new Date().getTime(),q=true;for(var t=0;t<this._draw_nodes.length;++t){var g=this._draw_nodes[t];if(g.done){continue}var f=this._build_shapes[g.shapeid];if(!f.ready){if(this.drawing_stage===8){console.warn("shape marked as not ready when should")}q=false;continue}g.done=true;f.used=true;if(!f.geom||(f.nfaces===0)){this._clones.CreateObject3D(g.stack,this._toplevel,"delete_mesh");continue}var z=this._clones.CreateObject3D(g.stack,this._toplevel,this.options);var k=this._clones.origin[g.nodeid];var y=this._clones.nodes[g.nodeid];var h=a.GEO.getNodeProperties(y.kind,k,true);this._num_meshes++;this._num_faces+=f.nfaces;h.material.wireframe=this.options.wireframe;h.material.side=this.bothSides?c.DoubleSide:c.FrontSide;var e;if(z.matrixWorld.determinant()>-0.9){e=new c.Mesh(f.geom,h.material)}else{e=this.createFlippedMesh(z,f,h.material)}e.stack=g.stack;z.add(e);if(this.options._debug||this.options._full){var d=new c.WireframeHelper(e);d.material.color.set(h.fillcolor);d.material.linewidth=("fVolume" in k)?k.fVolume.fLineWidth:1;z.add(d)}if(this.options._bound||this.options._full){var w=new c.BoxHelper(e);z.add(w)}var i=new Date().getTime();if(i-j>500){q=false;break}}if(q){this.drawing_log="Building done";this.drawing_stage=0;return false}if(this.drawing_stage>7){this.drawing_log="Building meshes "+this._num_meshes+" / "+this._num_faces}return true}console.log("never come here");return false};a.TGeoPainter.prototype.SameMaterial=function(f,d){if((f===null)||(d===null)){return f===d}if(f.fVolume.fLineColor>=0){return(f.fVolume.fLineColor===d.fVolume.fLineColor)}var g=(f.fVolume.fMedium!==null)?f.fVolume.fMedium.fMaterial:null;var e=(d.fVolume.fMedium!==null)?d.fVolume.fMedium.fMaterial:null;if(g===e){return true}if((g===null)||(e===null)){return false}return(g.fFillStyle===e.fFillStyle)&&(g.fFillColor===e.fFillColor)};a.TGeoPainter.prototype.createScene=function(j,d,g,f){this._scene=new c.Scene();this._scene.fog=new c.Fog(16777215,1,10000);this._scene.overrideMaterial=new c.MeshLambertMaterial({color:7340287,transparent:true,opacity:0.2,depthTest:false});this._scene_width=d;this._scene_height=g;this._camera=new c.PerspectiveCamera(25,d/g,1,10000);this._camera.up=this.options._yup?new c.Vector3(0,1,0):new c.Vector3(0,0,1);this._scene.add(this._camera);this._selected={mesh:null,originalColor:null};this._overall_size=10;this._toplevel=new c.Object3D();this._scene.add(this._toplevel);this._renderer=j?new c.WebGLRenderer({antialias:true,logarithmicDepthBuffer:false,preserveDrawingBuffer:true}):new c.CanvasRenderer({antialias:true});this._renderer.setPixelRatio(f);this._renderer.setClearColor(16777215,1);this._renderer.setSize(d,g);this._renderer.localClippingEnabled=true;this._animating=false;this.clipIntersection=true;this.bothSides=false;this.enableX=this.enableY=this.enableZ=false;this.clipX=this.clipY=this.clipZ=0;this._clipPlanes=[new c.Plane(new c.Vector3(1,0,0),this.clipX),new c.Plane(new c.Vector3(0,this.options._yup?-1:1,0),this.clipY),new c.Plane(new c.Vector3(0,0,this.options._yup?1:-1),this.clipZ)];this._pointLight=new c.PointLight(15724527,1);this._camera.add(this._pointLight);this._pointLight.position.set(10,10,10);this._defaultAdvanced={aoClamp:0.7,lumInfluence:0.4,clipIntersection:true,depthTest:true};this._enableSSAO=this.options.ssao;if(j){var i=new c.RenderPass(this._scene,this._camera);this._depthMaterial=new c.MeshDepthMaterial({side:c.DoubleSide});this._depthMaterial.depthPacking=c.RGBADepthPacking;this._depthMaterial.blending=c.NoBlending;var e={minFilter:c.LinearFilter,magFilter:c.LinearFilter};this._depthRenderTarget=new c.WebGLRenderTarget(d,g,e);this._ssaoPass=new c.ShaderPass(c.SSAOShader);this._ssaoPass.renderToScreen=true;this._ssaoPass.uniforms.tDepth.value=this._depthRenderTarget.texture;this._ssaoPass.uniforms.size.value.set(d,g);this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far;this._ssaoPass.uniforms.onlyAO.value=false;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence;this._effectComposer=new c.EffectComposer(this._renderer);this._effectComposer.addPass(i);this._effectComposer.addPass(this._ssaoPass)}this._advceOptions={};this.resetAdvanced()};a.TGeoPainter.prototype.startDrawGeometry=function(d){if(!d&&(this.drawing_stage!==0)){this._draw_nodes_again=true;return}this._startm=new Date().getTime();this._last_render_tm=this._startm;this._last_render_meshes=0;this.drawing_stage=1;this.drawing_log="collect visible";this._num_meshes=0;this._num_faces=0;delete this._last_manifest;delete this._last_hidden;delete this._draw_nodes_again;this.continueDraw()};a.TGeoPainter.prototype.resetAdvanced=function(){if(this._webgl){this._advceOptions.aoClamp=this._defaultAdvanced.aoClamp;this._advceOptions.lumInfluence=this._defaultAdvanced.lumInfluence;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence}this._advceOptions.depthTest=this._defaultAdvanced.depthTest;this._advceOptions.clipIntersection=this._defaultAdvanced.clipIntersection;this.clipIntersection=this._defaultAdvanced.clipIntersection;var d=this;this._toplevel.traverse(function(e){if(e instanceof c.Mesh){e.material.depthTest=d._defaultAdvanced.depthTest}});this.Render3D(0)};a.TGeoPainter.prototype.updateMaterialSide=function(d,e){if((this.bothSides===d)&&!e){return}this._scene.traverse(function(f){if(f.hasOwnProperty("material")&&("emissive" in f.material)){f.material.side=d?c.DoubleSide:c.FrontSide;f.material.needsUpdate=true}});this.bothSides=d};a.TGeoPainter.prototype.updateClipping=function(e){this._clipPlanes[0].constant=this.clipX;this._clipPlanes[1].constant=-this.clipY;this._clipPlanes[2].constant=this.options._yup?-this.clipZ:this.clipZ;var d=this;this._scene.traverse(function(f){if(f instanceof c.Mesh){f.material.clipIntersection=d.clipIntersection;f.material.clippingPlanes=[];if(d.enableX){f.material.clippingPlanes.push(d._clipPlanes[0])}if(d.enableY){f.material.clippingPlanes.push(d._clipPlanes[1])}if(d.enableZ){f.material.clippingPlanes.push(d._clipPlanes[2])}}});this.updateMaterialSide(this.enableX||this.enableY||this.enableZ);if(!e){this.Render3D(0)}};a.TGeoPainter.prototype.adjustCameraPosition=function(j){if(!this._toplevel){return}var e=this.getExtrasContainer("get");if(e){this._toplevel.remove(e)}var h=new c.Box3().setFromObject(this._toplevel);if(e){this._toplevel.add(e)}var l=h.max.x-h.min.x,k=h.max.y-h.min.y,i=h.max.z-h.min.z,g=(h.max.x+h.min.x)/2,f=(h.max.y+h.min.y)/2,d=(h.max.z+h.min.z)/2;this._overall_size=2*Math.max(l,k,i);this._scene.fog.near=this._overall_size*2;this._camera.near=this._overall_size/350;this._scene.fog.far=this._overall_size*12;this._camera.far=this._overall_size*12;if(this._webgl){this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far}if(j){this.clipX=g;this.clipY=f;this.clipZ=d}this._camera.updateProjectionMatrix();if(this.options._yup){this._camera.position.set(g-2*Math.max(l,i),f+2*k,d-2*Math.max(l,i))}else{this._camera.position.set(g-2*Math.max(l,k),f-2*Math.max(l,k),d+2*i)}this._lookat=new c.Vector3(g,f,d);this._camera.lookAt(this._lookat);this._pointLight.position.set(l/5,k/5,i/5);if(this._controls){this._controls.target.copy(this._lookat);this._controls.update()}if(this.options.select_in_view){this.startDrawGeometry()}};a.TGeoPainter.prototype.focusOnItem=function(f){if(!f||!this._clones){return}var d=this._clones.FindStackByName(f);if(!d){return}var e=this._clones.ResolveStack(d,true);this.focusCamera(e,false)};a.TGeoPainter.prototype.focusCamera=function(n,w){var r=w===undefined?false:w;var l=new c.Box3();if(n===undefined){l.setFromObject(this._toplevel)}else{if(n instanceof c.Mesh){l.setFromObject(n)}else{var B=new c.Vector3().setFromMatrixPosition(n.matrix);var q=n.node;var o=new c.Vector3(q.fDX,q.fDY,q.fDZ).multiplyScalar(0.5);l.min=B.clone().sub(o);l.max=B.clone().add(o)}}var A=l.max.x-l.min.x,y=l.max.y-l.min.y,x=l.max.z-l.min.z,v=(l.max.x+l.min.x)/2,u=(l.max.y+l.min.y)/2,s=(l.max.z+l.min.z)/2;var D;if(this.options._yup){D=new c.Vector3(v-2*Math.max(A,x),u+2*y,s-2*Math.max(A,x))}else{D=new c.Vector3(v-2*Math.max(A,y),u-2*Math.max(A,y),s+2*x)}var C=new c.Vector3(v,u,s);var p=this._camera.position.distanceTo(C);var t=this._controls.target;var m=200;var j=0;var g=D.sub(this._camera.position).divideScalar(m);var k=C.sub(t).divideScalar(m);if(r){var h=new c.Box3().setFromObject(this._toplevel);this.clipX=this.enableX?this.clipX:h.min.x;this.clipY=this.enableY?this.clipY:h.min.y;this.clipZ=this.enableZ?this.clipZ:h.min.z;this.enableX=this.enableY=this.enableZ=true;var f=((l.max.x+l.min.x)/2-this.clipX)/m,e=((l.max.y+l.min.y)/2-this.clipY)/m,d=((l.max.z+l.min.z)/2-this.clipZ)/m;this.updateClipping()}var z=this;this._animating=true;function i(){if(z._animating===undefined){return}if(z._animating){requestAnimationFrame(i)}else{z.startDrawGeometry()}var E=-Math.cos((2*Math.PI*j)/m)+1;z._camera.position.add(g.clone().multiplyScalar(E));t.add(k.clone().multiplyScalar(E));z._lookat=t;z._camera.lookAt(z._lookat);z._camera.updateProjectionMatrix();if(r){z.clipX+=f*E;z.clipY+=e*E;z.clipZ+=d*E;z.updateClipping()}else{z.Render3D()}j++;z._animating=j<m}i()};a.TGeoPainter.prototype.autorotate=function(h){var f=(h===undefined)?2:h,d=this,g=new Date();function e(){if(!d._renderer||!d.options){return}var i=new Date();if(d.options.autoRotate){requestAnimationFrame(e)}if(d._controls){d._controls.autoRotate=d.options.autoRotate;d._controls.autoRotateSpeed=f*(i.getTime()-g.getTime())/16.6666;d._controls.update()}g=new Date();d.Render3D(0)}e()};a.TGeoPainter.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var d=new c.BoxHelper(this._toplevel);this._scene.add(d)}this._scene.add(new c.AxisHelper(2*this._overall_size));this._scene.add(new c.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};a.TGeoPainter.prototype.drawCount=function(l,h){var i="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+l+"<br/>Time to clone: "+h+"ms <br/>";this._clones.ScanVisible();var m={cnt:[],func:function(n){if(this.cnt[this.last]===undefined){this.cnt[this.last]=1}else{this.cnt[this.last]++}return true}};var e=new Date().getTime();var g=this._clones.ScanVisible(m);var d=new Date().getTime();i+="Total visible nodes: "+g+"<br/>";for(var j=0;j<m.cnt.length;++j){if(m.cnt[j]!==undefined){i+=("  lvl"+j+": "+m.cnt[j]+"<br/>")}}i+="Time to scan: "+(d-e)+"ms <br/>";i+="<br/><br/>Check timing for matrix calculations ...<br/>";var f=this.select_main().style("overflow","auto").html(i);var k=this;setTimeout(function(){m.domatrix=true;e=new Date().getTime();g=k._clones.ScanVisible(m);d=new Date().getTime();f.append("p").text("Time to scan with matrix: "+(d-e)+"ms")},100);return this.DrawingReady()};a.TGeoPainter.prototype.PerformDrop=function(e,f,d){if(this.drawExtras(e,f,true)){if(d){d._painter=this}this.Render3D(100)}return null};a.TGeoPainter.prototype.MouseOverHierarchy=function(e,i,f){if(!this.options){return}var d=this,g=f._obj,h=null;if(this.options._debug){console.log("Mouse over",e,i,(f._obj?f._obj._typename:"---"))}if(!f._obj||(f._obj._typename!=="TEveTrack"&&f._obj._typename!=="TEvePointSet")){return}d.getExtrasContainer().children.some(function(k,j){if(k.geo_object===g){h=k;return true}return false});if(h&&e){d._selected.mesh=h;d._selected.originalColor=h.material.color;d._selected.originalSize=h.material.size;d._selected.originalLineWidth=h.material.linewidth;d._selected.mesh.material.color=new c.Color(65280);d._selected.mesh.material.size*=2;d._selected.mesh.material.linewidth*=2}else{if(d._selected.mesh){if(d._selected.originalColor){d._selected.mesh.material.color=d._selected.originalColor}if(d._selected.originalSize){d._selected.mesh.material.size=d._selected.originalSize}if(d._selected.originalLineWidth){d._selected.mesh.material.linewidth=d._selected.originalLineWidth}}}d.Render3D(0)};a.TGeoPainter.prototype.addExtra=function(d,e){if(this._extraObjects===undefined){this._extraObjects=a.Create("TList")}if(this._extraObjects.arr.indexOf(d)>=0){return false}this._extraObjects.Add(d,e);delete d._hidden_via_menu;return true};a.TGeoPainter.prototype.ExtraObjectVisible=function(i,d){if(!this._extraObjects){return}var f=this._extraObjects.opt.indexOf(i);if(f<0){return}var g=this._extraObjects.arr[f];var e=g._hidden_via_menu?false:true;if(d){g._hidden_via_menu=e;e=!e;var h=null;this._toplevel.traverse(function(j){if(j.geo_object===g){h=j}});if(h){h.visible=e}else{if(e){this.drawExtras(g)}}if(h||e){this.Render3D()}}return e};a.TGeoPainter.prototype.drawExtras=function(g,j,h){if(!g||g._typename===undefined){return false}if(!h&&g._hidden_via_menu){return false}var f=false;if(g._typename==="TList"){if(!g.arr){return false}for(var i=0;i<g.arr.length;++i){var e=g.arr[i];var d=(j===undefined)?g.opt[i]:(j+"/["+i+"]");if(this.drawExtras(e,d,h)){f=true}}}else{if(g._typename==="TEveTrack"){if(h&&!this.addExtra(g,j)){return false}f=this.drawTrack(g,j)}else{if(g._typename==="TEvePointSet"){if(h&&!this.addExtra(g,j)){return false}f=this.drawHit(g,j)}}}return f};a.TGeoPainter.prototype.getExtrasContainer=function(f){if(!this._toplevel){return null}var d=null;for(var g=0;g<this._toplevel.children.length;++g){var e=this._toplevel.children[g];if(e._extras){d=e;break}}if(f==="delete"){if(d){this._toplevel.remove(d)}a.Painter.DisposeThreejsObject(d);return null}if((f!=="get")&&!d){d=new c.Object3D();d._extras=true;this._toplevel.add(d)}return d};a.TGeoPainter.prototype.drawTrack=function(f,i){if(!f){return false}if(f.fN<=0){return false}var m=f.fLineWidth;var d=a.Painter.root_colors[f.fLineColor];if(d==undefined){d="rgb(255,0,255)"}if(a.browser.isWin){m=1}var e=new Float32Array((f.fN-1)*6),j=0;for(var h=0;h<f.fN-1;++h){e[j]=f.fP[h*3];e[j+1]=f.fP[h*3+1];e[j+2]=f.fP[h*3+2];e[j+3]=f.fP[h*3+3];e[j+4]=f.fP[h*3+4];e[j+5]=f.fP[h*3+5];j+=6}var l=new c.BufferGeometry();l.addAttribute("position",new c.BufferAttribute(e,3));var g=new c.LineBasicMaterial({color:d,linewidth:m});var n=new c.LineSegments(l,g);n.geo_name=i;n.geo_object=f;if(!a.browser.isWin){n.hightlightLineWidth=m*3}this.getExtrasContainer().add(n);return true};a.TGeoPainter.prototype.drawHit=function(E,t){if(!E){return false}if(E.fN<=0){return false}var w=25*E.fMarkerSize;var n=a.Painter.root_colors[E.fMarkerColor];var h=this._webgl,u=E.fN-1,o=1,F=w*0.3,e=a.Painter.Box_Indexes,v=a.Painter.Box_Normals,m=a.Painter.Box_Vertices,g=0,l,j;if(h){l=new Float32Array(u*3);j=null}else{if(u>1000){o=Math.floor(u/500);if(o<2){o=2}}l=new Float32Array(e.length*3*Math.floor(u/o));j=new Float32Array(e.length*3*Math.floor(u/o))}for(var C=0;C<u;C+=o){var r=E.fP[C*3],q=E.fP[C*3+1],p=E.fP[C*3+2];if(h){l[g]=r;l[g+1]=q;l[g+2]=p;g+=3;continue}for(var B=0,f=-3;B<e.length;++B){var D=m[e[B]];l[g]=r+(D.x-0.5)*F;l[g+1]=q+(D.y-0.5)*F;l[g+2]=p+(D.z-0.5)*F;if(B%6===0){f+=3}j[g]=v[f];j[g+1]=v[f+1];j[g+2]=v[f+2];g+=3}}var A=new c.BufferGeometry(),d;A.addAttribute("position",new c.BufferAttribute(l,3));if(j){A.addAttribute("normal",new c.BufferAttribute(j,3))}if(h){var s=new c.PointsMaterial({size:w,color:n});d=new c.Points(A,s);d.highlightMarkerSize=w*3}else{var s=new c.MeshBasicMaterial({color:n,shading:c.SmoothShading});d=new c.Mesh(A,s)}d.geo_name=t;d.geo_object=E;this.getExtrasContainer().add(d);return true};a.TGeoPainter.prototype.FindNodeWithVolume=function(d,h,g,j,l){var f=false,k=null;if(!g){g=this.GetObject();if(!g&&(a.GEO.NodeKind(g)!==0)){return null}j=this.is_geo_manager?g.fName:"";f=true;l=[]}else{if(j.length>0){j+="/"}j+=g.fName}if(!g.fVolume||g.fVolume._searched){return null}if(d.test(g.fVolume.fName)){k=h({node:g,item:j});if(k){return k}}g.fVolume._searched=true;l.push(g.fVolume);if(g.fVolume.fNodes){for(var e=0;e<g.fVolume.fNodes.arr.length;++e){k=this.FindNodeWithVolume(d,h,g.fVolume.fNodes.arr[e],j,l);if(k){break}}}if(f){for(var e=0,i=l.length;e<i;++e){delete l[e]._searched}}return k};a.TGeoPainter.prototype.SetRootDefaultColors=function(){var h={kWhite:0,kBlack:1,kGray:920,kRed:632,kGreen:416,kBlue:600,kYellow:400,kMagenta:616,kCyan:432,kOrange:800,kSpring:820,kTeal:840,kAzure:860,kViolet:880,kPink:900};var d=110,f=[];for(var g=0;g<d;g++){f.push(h.kGray)}f[3]=h.kYellow-10;f[4]=f[5]=h.kGreen-10;f[6]=f[7]=h.kBlue-7;f[8]=f[9]=h.kMagenta-3;f[10]=f[11]=h.kRed-10;f[12]=h.kGray+1;f[13]=h.kBlue-10;f[14]=h.kOrange+7;f[16]=h.kYellow+1;f[20]=h.kYellow-10;f[24]=f[25]=f[26]=h.kBlue-8;f[29]=h.kOrange+9;f[79]=h.kOrange-2;var e={test:function(){return true}};this.FindNodeWithVolume(e,function(i){var k=i.node.fVolume;var l=k.fMedium;if(!l){return null}var j=l.fMaterial;var m=Math.round(j.fZ);k.fLineColor=f[m];if(j.fDensity<0.1){j.fFillStyle=3000+60}})};a.TGeoPainter.prototype.checkScript=function(j,g){var d=this,i=this.GetObject(),e="";if(this.is_geo_manager){e=i.fName}if(!j||(j.length<3)||(a.GEO.NodeKind(i)!==0)){return a.CallBack(g,i,e)}var f={GetVolume:function(l){var m=new RegExp("^"+l+"$");var k=d.FindNodeWithVolume(m,function(n){return n});if(!k){console.log("Did not found "+l+" volume")}return{found:k,fVolume:k?k.node.fVolume:null,InvisibleAll:function(n){a.GEO.InvisibleAll.call(this.fVolume,n)},Draw:function(){if(!this.found||!this.fVolume){return}i=this.found.node;e=this.found.item;console.log("Select volume for drawing",this.fVolume.fName,e)},SetTransparency:function(n){if(this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial){this.fVolume.fMedium.fMaterial.fFillStyle=3000+n}},SetLineColor:function(n){if(this.fVolume){this.fVolume.fLineColor=n}}}},DefaultColors:function(){d.SetRootDefaultColors()},SetMaxVisNodes:function(k){console.log("Automatic visible depth for "+k+" nodes");if(k>0){d.options.maxnodeslimit=k}}};a.progress("Loading macro "+j);var h=a.NewHttpRequest(j,"text",function(l){if(!l||(l.length==0)){return a.CallBack(g,i,e)}var k=l.split("\n");m(0);function m(r){var s=new Date().getTime();while(r<k.length){var n=k[r++].trim();if(n.indexOf("//")==0){continue}if(n.indexOf("gGeoManager")<0){continue}n=n.replace("->GetVolume",".GetVolume");n=n.replace("->InvisibleAll",".InvisibleAll");n=n.replace("->SetMaxVisNodes",".SetMaxVisNodes");n=n.replace("->DefaultColors",".DefaultColors");n=n.replace("->Draw",".Draw");n=n.replace("->SetTransparency",".SetTransparency");n=n.replace("->SetLineColor",".SetLineColor");if(n.indexOf("->")>=0){continue}try{var q=new Function("gGeoManager",n);q(f)}catch(p){console.error("Problem by processing "+n)}var o=new Date().getTime();if(o-s>300){a.progress("exec "+n);return setTimeout(m.bind(this,r),1)}}a.CallBack(g,i,e)}});h.send(null)};a.TGeoPainter.prototype.prepareObjectDraw=function(i,g){var e=new Date().getTime();this._clones=new a.GEO.ClonedNodes(i);this._clones.name_prefix=g;var h=this._clones.MarkVisisble(true);if(h<=0){h=this._clones.MarkVisisble(false)}else{h=this._clones.MarkVisisble(true,true)}var d=new Date().getTime();console.log("Creating clones",this._clones.nodes.length,"takes",d-e,"uniquevis",h);if(this.options._count){return this.drawCount(h,d-e)}this.options.maxlimit=(this._webgl?200000:100000)*this.options.more;this._first_drawing=true;if(this.options.use_worker>0){this.startWorker()}var f=this.size_for_3d();this.createScene(this._webgl,f.width,f.height,window.devicePixelRatio);this.add_3d_canvas(f,this._renderer.domElement);this.AccessTopPainter(true);this.CreateToolbar();this.startDrawGeometry(true)};a.TGeoPainter.prototype.DrawGeometry=function(d,e){if(typeof d!=="string"){d=""}this._webgl=a.Painter.TestWebGL();this.options=this.decodeOptions(d);if(!("_yup" in this.options)){this.options._yup=this.svg_canvas().empty()}this.checkScript(this.options.script_name,this.prepareObjectDraw.bind(this));return this};a.TGeoPainter.prototype.continueDraw=function(){if(this.drawing_stage===0){return}var e=new Date().getTime(),d=this._first_drawing?1000:200,f=e;while(true){var g=this.nextDrawAction();if(!g){break}f=new Date().getTime();if(f-this._startm>100000){this.drawing_stage=0;break}if((g===true)&&(f-e<d)){continue}if((f-e>d)||(g===1)||(g===2)){a.progress(this.drawing_log);if(this._first_drawing&&this._webgl&&(this._num_meshes-this._last_render_meshes>100)&&(f-this._last_render_tm>2.5*d)){this.adjustCameraPosition();this.Render3D(-1);this._last_render_tm=new Date().getTime();this._last_render_meshes=this._num_meshes}if(g!==2){setTimeout(this.continueDraw.bind(this),(g===1)?100:1)}return}}var h=f-this._startm;if(this._first_drawing){a.console("Create tm = "+h+" meshes "+this._num_meshes+" faces "+this._num_faces)}if(h>300){a.progress("Rendering geometry");return setTimeout(this.completeDraw.bind(this,true),10)}this.completeDraw(true)};a.TGeoPainter.prototype.Render3D=function(g,f){if(!this._renderer){console.warn("renderer object not exists - check code");return}if(g===undefined){g=5}if(g<=0){if("render_tmout" in this){clearTimeout(this.render_tmout)}var e=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this._camera,this._toplevel)}if(this._webgl&&this._enableSSAO){this._scene.overrideMaterial=this._depthMaterial;this._renderer.render(this._scene,this._camera,this._depthRenderTarget,true);this._scene.overrideMaterial=null;this._effectComposer.render()}else{this._renderer.render(this._scene,this._camera)}var d=new Date();this.last_render_tm=d.getTime()-e.getTime();delete this.render_tmout;if((this.first_render_tm===0)&&f){this.first_render_tm=this.last_render_tm;a.console("First render tm = "+this.first_render_tm)}return}if(!this.render_tmout){this.render_tmout=setTimeout(this.Render3D.bind(this,0,f),g)}};a.TGeoPainter.prototype.startWorker=function(){if(this._worker){return}this._worker_ready=false;this._worker_jobs=0;var d=this;this._worker=new Worker(a.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(f){if(typeof f.data!=="object"){return}if("log" in f.data){return a.console("geo: "+f.data.log)}if("progress" in f.data){return a.progress(f.data.progress)}f.data.tm3=new Date().getTime();if("init" in f.data){d._worker_ready=true;return a.console("Worker ready: "+(f.data.tm3-f.data.tm0))}d.processWorkerReply(f.data)};this._worker.postMessage({init:true,browser:a.browser,tm0:new Date().getTime(),clones:this._clones.nodes,sortmap:this._clones.sortmap})};a.TGeoPainter.prototype.canSubmitToWorker=function(d){if(!this._worker){return false}return this._worker_ready&&((this._worker_jobs==0)||d)};a.TGeoPainter.prototype.submitToWorker=function(d){if(!this._worker){return false}this._worker_jobs++;d.tm0=new Date().getTime();this._worker.postMessage(d)};a.TGeoPainter.prototype.processWorkerReply=function(f){this._worker_jobs--;if("collect" in f){this._new_draw_nodes=f.new_nodes;this._draw_all_nodes=f.complete;this.drawing_stage=3;return this.continueDraw()}if("shapes" in f){for(var g=0;g<f.shapes.length;++g){var e=f.shapes[g],d=this._build_shapes[g];if(e.buf_pos&&e.buf_norm){if(e.buf_pos.length===0){d.geom=null}else{if(e.buf_pos.length!==e.buf_norm.length){console.error("item.buf_pos",e.buf_pos.length,"item.buf_norm",e.buf_norm.length);d.geom=null}else{d.geom=new c.BufferGeometry();d.geom.addAttribute("position",new c.BufferAttribute(e.buf_pos,3));d.geom.addAttribute("normal",new c.BufferAttribute(e.buf_norm,3))}}d.ready=true;d.nfaces=e.nfaces}}f.tm4=new Date().getTime();this.drawing_stage=7;return this.continueDraw()}};a.TGeoPainter.prototype.testGeomChanges=function(){this.startDrawGeometry()};a.TGeoPainter.prototype.toggleAxisDraw=function(e){if(this.TestAxisVisibility!==undefined){if(e){return}this.TestAxisVisibility(null,this._toplevel)}else{var d=a.Create("TNamed");d._typename="TAxis3D";d._main=this;a.draw(this.divid,d)}};a.TGeoPainter.prototype.completeDraw=function(d){var e=false;if(!this.options){console.warn("options object does not exist in completeDraw - something went wrong");return}if(this._first_drawing){this.adjustCameraPosition(true);this._first_drawing=false;e=true;if(this._webgl){this.enableX=this.options.clipx;this.enableY=this.options.clipy;this.enableZ=this.options.clipz;this.updateClipping(true)}}if(this.options.transparancy!==1){this.changeGlobalTransparancy(this.options.transparancy,true)}this.completeScene();if(this.options._axis){this.options._axis=false;this.toggleAxisDraw()}this._scene.overrideMaterial=null;this.getExtrasContainer("delete");this.drawExtras(this._extraObjects);this.Render3D(0,true);if(d){a.progress()}this.addOrbitControls();this.addTransformControl();this.showControlOptions(this.options.show_controls);if(e){if(this.options.highlight===false){this.options.highlight=(this.first_render_tm<1000)}if(this.options.autoRotate){this.autorotate(2.5)}this.DrawingReady()}if(this._draw_nodes_again){this.startDrawGeometry()}};a.TGeoPainter.prototype.Cleanup=function(e){if(!e){this.AccessTopPainter(false);this.helpText();a.Painter.DisposeThreejsObject(this._scene);if(this._tcontrols){this._tcontrols.dispose()}if(this._controls){this._controls.Cleanup()}if(this._context_menu){this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,false)}if(this._datgui){this._datgui.destroy()}var d=this.GetObject();if(d){delete d._painter}if(this._worker){this._worker.terminate()}a.TObjectPainter.prototype.Cleanup.call(this);delete this.options;delete this._animating}if(this._renderer){if(this._renderer.dispose){this._renderer.dispose()}if(this._renderer.context){delete this._renderer.context}}delete this._scene;this._scene_width=0;this._scene_height=0;this._renderer=null;this._toplevel=null;this._camera=null;if(this._clones){this._clones.Cleanup(this._draw_nodes,this._build_shapes)}delete this._clones;delete this._draw_nodes;delete this._build_shapes;delete this._new_draw_nodes;this.first_render_tm=0;this.last_render_tm=2000;this.drawing_stage=0;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};a.TGeoPainter.prototype.helpText=function(d){a.progress(d)};a.TGeoPainter.prototype.CheckResize=function(d){var e=this.pad_painter();if(e){if(!e.CheckCanvasResize(d)){return false}}var f=this.size_for_3d();if((this._scene_width===f.width)&&(this._scene_height===f.height)){return false}if((f.width<10)||(f.height<10)){return}this._scene_width=f.width;this._scene_height=f.height;this._camera.aspect=this._scene_width/this._scene_height;this._camera.updateProjectionMatrix();this._renderer.setSize(this._scene_width,this._scene_height);this.Render3D();return true};a.TGeoPainter.prototype.ownedByTransformControls=function(e){var d=e.parent;while(d&&!(d instanceof c.TransformControls)){d=d.parent}return(d&&(d instanceof c.TransformControls))};a.TGeoPainter.prototype.accessObjectWireFrame=function(e,d){if(!e.hasOwnProperty("material")||(e instanceof c.GridHelper)){return}if(this.ownedByTransformControls(e)){return}if((d!==undefined)&&e.stack){e.material.wireframe=d}return e.material.wireframe};a.TGeoPainter.prototype.changeWireFrame=function(f,e){var d=this;f.traverse(function(g){d.accessObjectWireFrame(g,e)});this.Render3D()};a.Painter.drawGeoObject=function(h,f,e){if(f===null){return null}a.GEO.GradPerSegm=a.gStyle.GeoGradPerSegm;a.GEO.CompressComp=a.gStyle.GeoCompressComp;var d=null,g=false;if(("fShapeBits" in f)&&("fShapeId" in f)){d=f;f=null}else{if((f._typename==="TGeoVolumeAssembly")||(f._typename==="TGeoVolume")){d=f.fShape}else{if(f._typename==="TEveGeoShapeExtract"){d=f.fShape}else{if(f._typename==="TGeoManager"){f=f.fMasterVolume;a.GEO.SetBit(f,a.GEO.BITS.kVisThis,false);d=f.fShape;g=true}else{if("fVolume" in f){if(f.fVolume){d=f.fVolume.fShape}}else{f=null}}}}}if(e&&e.indexOf("comp")==0&&d&&(d._typename=="TGeoCompositeShape")&&d.fNode){e=e.substr(4);f=a.GEO.buildCompositeVolume(d)}if(!f&&d){f=a.extend(a.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:true})}if(f){a.extend(this,new a.TGeoPainter(f,g));this.SetDivId(h,5);return this.DrawGeometry(e,h)}return this.DrawingReady()};a.Painter.drawGeometry=a.Painter.drawGeoObject;a.Painter.drawAxis3D=function(g,f,e){var d=new a.TObjectPainter(f);if(!("_main" in f)){d.SetDivId(g)}d.Draw3DAxis=function(){var h=this.main_painter();if((h===null)&&("_main" in this.GetObject())){h=this.GetObject()._main}if((h===null)||(h._toplevel===undefined)){return console.warn("no geo object found for 3D axis drawing")}var i=new c.Box3().setFromObject(h._toplevel);this.xmin=i.min.x;this.xmax=i.max.x;this.ymin=i.min.y;this.ymax=i.max.y;this.zmin=i.min.z;this.zmax=i.max.z;this.size_xy3d=this.size_z3d=0;this.DrawXYZ=a.Painter.HPainter_DrawXYZ;this.DrawXYZ(h._toplevel);h.adjustCameraPosition();h.TestAxisVisibility=a.Painter.HPainter_TestAxisVisibility;h.Render3D()};d.Draw3DAxis();return d.DrawingReady()};a.GEO.buildCompositeVolume=function(f,h){var g=a.Create("TGeoVolume");if(h&&(f._typename!=="TGeoCompositeShape")){g.fName=h;a.GEO.SetBit(g,a.GEO.BITS.kVisThis,true);g.fLineColor=(h=="Left"?2:3);g.fShape=f;return g}a.GEO.SetBit(g,a.GEO.BITS.kVisDaughters,true);g._geoh=true;g.fName="";var e=a.Create("TGeoNodeMatrix");e.fName="Left";e.fMatrix=f.fNode.fLeftMat;e.fVolume=a.GEO.buildCompositeVolume(f.fNode.fLeft,"Left");var d=a.Create("TGeoNodeMatrix");d.fName="Right";d.fMatrix=f.fNode.fRightMat;d.fVolume=a.GEO.buildCompositeVolume(f.fNode.fRight,"Right");g.fNodes=a.Create("TList");g.fNodes.Add(e);g.fNodes.Add(d);return g};a.GEO.provideVisStyle=function(f){if(f._typename==="TEveGeoShapeExtract"){return f.fRnrSelf?" geovis_this":""}var e=!a.GEO.TestBit(f,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(f,a.GEO.BITS.kVisThis);var d=a.GEO.TestBit(f,a.GEO.BITS.kVisDaughters)||a.GEO.TestBit(f,a.GEO.BITS.kVisOneLevel);if(d&&(!f.fNodes||(f.fNodes.arr.length===0))){d=false}if(e&&d){return" geovis_all"}if(e){return" geovis_this"}if(d){return" geovis_daughters"}return""};a.GEO.getBrowserItem=function(d,f,e){if(d._geoobj){d._geoobj._geoh=true}a.CallBack(e,d,d._geoobj)};a.GEO.createItem=function(i,k,e){var g={_kind:"ROOT."+k._typename,_name:e?e:k.fName,_title:k.fTitle,_parent:i,_geoobj:k,_get:a.GEO.getBrowserItem};var h,d,j,f=false;if(k._typename=="TGeoMaterial"){g._icon="img_geomaterial"}else{if(k._typename=="TGeoMedium"){g._icon="img_geomedium"}else{if(k._typename=="TGeoMixture"){g._icon="img_geomixture"}else{if((k._typename.indexOf("TGeoNode")===0)&&k.fVolume){g._title="node:"+k._typename;if(k.fTitle.length>0){g._title+=" "+k.fTitle}h=k.fVolume}else{if(k._typename.indexOf("TGeoVolume")===0){h=k}else{if(k._typename=="TEveGeoShapeExtract"){f=true;d=k.fShape;j=k.fElements?k.fElements.arr:null}else{if((k.fShapeBits!==undefined)&&(k.fShapeId!==undefined)){d=k}}}}}}}if(h){d=h.fShape;j=h.fNodes?h.fNodes.arr:null}if(h||d||j){if(h){g._volume=h}if(j){g._more=true;g._expand=a.GEO.expandObject}else{if(d&&(d._typename==="TGeoCompositeShape")&&d.fNode){g._more=true;g._shape=d;g._expand=function(l,m){a.GEO.createItem(l,l._shape.fNode.fLeft,"Left");a.GEO.createItem(l,l._shape.fNode.fRight,"Right");return true}}}if(!g._title&&(k._typename!="TGeoVolume")){g._title=k._typename}if(d){if(g._title==""){g._title=d._typename}g._icon=a.GEO.getShapeIcon(d)}else{g._icon=g._more?"img_geocombi":"img_geobbox"}if(h){g._icon+=a.GEO.provideVisStyle(h)}else{if(f){g._icon+=a.GEO.provideVisStyle(k)}}g._menu=a.GEO.provideMenu;g._icon_click=a.GEO.browserIconClick}if(!i._childs){i._childs=[]}i._childs.push(g);return g};a.GEO.createList=function(f,d,e,h){if((d==null)||!("arr" in d)||(d.arr.length==0)){return}var g={_name:e,_kind:"ROOT.TList",_title:h,_more:true,_geoobj:d,_parent:f};g._get=function(i,k,j){if("_geoobj" in i){return a.CallBack(j,i,i._geoobj)}a.CallBack(j,i,null)};g._expand=function(j,i){if("fVolume" in i){i=i.fVolume.fNodes}if(!("arr" in i)){return false}j._childs=[];for(var k in i.arr){a.GEO.createItem(j,i.arr[k])}return true};if(!f._childs){f._childs=[]}f._childs.push(g)};a.GEO.provideMenu=function(d,l,e){if(!l._geoobj){return false}var h=l._geoobj,f=l._volume,g=(h._typename==="TEveGeoShapeExtract");if(!f&&!g){return false}d.add("separator");function m(q,p,o){if(!p){p={visible:0,hidden:0}}if(!o){if(p.assign!==undefined){q.fRnrSelf=p.assign}else{if(q.fRnrSelf){p.vis++}else{p.hidden++}}}if(q.fElements){for(var r=0;r<q.fElements.arr.length;++r){m(q.fElements.arr[r],p,false)}}return p}function i(n){if(n==="self"){h.fRnrSelf=!h.fRnrSelf;l._icon=l._icon.split(" ")[0]+a.GEO.provideVisStyle(h);e.UpdateTreeNode(l)}else{m(h,{assign:(n==="true")},true);e.ForEach(function(o){if(o._geoobj&&o._icon){o._icon=l._icon.split(" ")[0]+a.GEO.provideVisStyle(o._geoobj);e.UpdateTreeNode(o)}},l)}a.GEO.findItemWithPainter(l,"testGeomChanges")}function k(n){a.GEO.ToggleBit(f,n);var o=l._icon.split(" ")[0]+a.GEO.provideVisStyle(f);e.ForEach(function(p){if(l._volume===p._volume){p._icon=o;e.UpdateTreeNode(p)}});e.UpdateTreeNode(l);a.GEO.findItemWithPainter(l,"testGeomChanges")}if((l._geoobj._typename.indexOf("TGeoNode")===0)&&a.GEO.findItemWithPainter(l)){d.add("Focus",function(){var o=a.GEO.findItemWithPainter(l);if(!o){return}var n=e.itemFullName(l,o);if(o._painter&&typeof o._painter.focusOnItem=="function"){o._painter.focusOnItem(n)}})}if(g){d.addchk(h.fRnrSelf,"Visible","self",i);var j=m(h,undefined,true);if(j.hidden+j.visible>0){d.addchk((j.hidden==0),"Daughters",(j.hidden!=0)?"true":"false",i)}}else{d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisNone),"Invisible",a.GEO.BITS.kVisNone,k);d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisThis),"Visible",a.GEO.BITS.kVisThis,k);d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisDaughters),"Daughters",a.GEO.BITS.kVisDaughters,k);d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisOneLevel),"1lvl daughters",a.GEO.BITS.kVisOneLevel,k)}return true};a.GEO.findItemWithPainter=function(e,d){while(e){if(e._painter&&e._painter._camera){if(d&&typeof e._painter[d]=="function"){e._painter[d]()}return e}e=e._parent}return null};a.GEO.updateBrowserIcons=function(e,d){if(!e||!d){return}d.ForEach(function(f){if((e===f._volume)||(e===f._geoobj)){f._icon=f._icon.split(" ")[0]+a.GEO.provideVisStyle(e);d.UpdateTreeNode(f)}})};a.GEO.browserIconClick=function(e,g){if(e._volume){if(e._more&&e._volume.fNodes&&(e._volume.fNodes.arr.length>0)){a.GEO.ToggleBit(e._volume,a.GEO.BITS.kVisDaughters)}else{a.GEO.ToggleBit(e._volume,a.GEO.BITS.kVisThis)}a.GEO.updateBrowserIcons(e._volume,g);a.GEO.findItemWithPainter(e,"testGeomChanges");return false}if(e._geoobj&&e._geoobj._typename=="TEveGeoShapeExtract"){e._geoobj.fRnrSelf=!e._geoobj.fRnrSelf;a.GEO.updateBrowserIcons(e._geoobj,g);a.GEO.findItemWithPainter(e,"testGeomChanges");return false}var f=a.GEO.findItemWithPainter(e);if(!f){return false}var d=f._painter.ExtraObjectVisible(g.itemFullName(e),true);return(d!==undefined)?true:false};a.GEO.getShapeIcon=function(d){switch(d._typename){case"TGeoArb8":return"img_geoarb8";break;case"TGeoCone":return"img_geocone";break;case"TGeoConeSeg":return"img_geoconeseg";break;case"TGeoCompositeShape":return"img_geocomposite";break;case"TGeoTube":return"img_geotube";break;case"TGeoTubeSeg":return"img_geotubeseg";break;case"TGeoPara":return"img_geopara";break;case"TGeoParaboloid":return"img_geoparab";break;case"TGeoPcon":return"img_geopcon";break;case"TGeoPgon":return"img_geopgon";break;case"TGeoShapeAssembly":return"img_geoassembly";break;case"TGeoSphere":return"img_geosphere";break;case"TGeoTorus":return"img_geotorus";break;case"TGeoTrd1":return"img_geotrd1";break;case"TGeoTrd2":return"img_geotrd2";break;case"TGeoXtru":return"img_geoxtru";break;case"TGeoTrap":return"img_geotrap";break;case"TGeoGtra":return"img_geogtra";break;case"TGeoEltu":return"img_geoeltu";break;case"TGeoHype":return"img_geohype";break;case"TGeoCtub":return"img_geoctub";break}return"img_geotube"};a.GEO.getBrowserIcon=function(d,g){var e="";if(d._kind=="ROOT.TEveTrack"){e="img_evetrack"}else{if(d._kind=="ROOT.TEvePointSet"){e="img_evepoints"}}if(e.length>0){var f=a.GEO.findItemWithPainter(d);if(f){if(f._painter.ExtraObjectVisible(g.itemFullName(d))){e+=" geovis_this"}}}return e};a.GEO.expandObject=function(n,j){if(!n||!j){return false}var k=(j._typename.indexOf("TGeoNode")===0),e=(j._typename.indexOf("TGeoVolume")===0),f=(j._typename==="TGeoManager"),g=(j._typename==="TEveGeoShapeExtract");if(!k&&!e&&!f&&!g){return false}if(n._childs){return true}if(f){a.GEO.createList(n,j.fMaterials,"Materials","list of materials");a.GEO.createList(n,j.fMedia,"Media","list of media");a.GEO.createList(n,j.fTracks,"fTracks","list of tracks");a.GEO.SetBit(j.fMasterVolume,a.GEO.BITS.kVisThis,false);a.GEO.createItem(n,j.fMasterVolume);return true}var l,d,m;if(g){d=j.fElements?j.fElements.arr:null;m=j.fShape}else{l=(k?j.fVolume:j);d=l&&l.fNodes?l.fNodes.arr:null;m=l?l.fShape:null}if(!d&&m&&(m._typename==="TGeoCompositeShape")&&m.fNode){if(!n._childs){a.GEO.createItem(n,m.fNode.fLeft,"Left");a.GEO.createItem(n,m.fNode.fRight,"Right")}return true}if(!d){return false}for(var h=0;h<d.length;++h){a.GEO.createItem(n,d[h])}return true};a.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:a.Painter.drawGeoObject,expand:a.GEO.expandObject,opt:";more;all;count"});a.addDrawFunc({name:"TAxis3D",func:a.Painter.drawAxis3D});a.addDrawFunc({name:"TEvePointSet",icon_get:a.GEO.getBrowserIcon,icon_click:a.GEO.browserIconClick});a.addDrawFunc({name:"TEveTrack",icon_get:a.GEO.getBrowserIcon,icon_click:a.GEO.browserIconClick});return a.Painter}));