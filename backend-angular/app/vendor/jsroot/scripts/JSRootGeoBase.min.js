(function(a){if(typeof define==="function"&&define.amd){define(["JSRootCore","threejs","ThreeCSG"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoBase.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoBase.js")}if(typeof ThreeBSP=="undefined"){throw new Error("ThreeBSP is not defined","JSRootGeoBase.js")}a(JSROOT,THREE,ThreeBSP)}}(function(a,b,c){a.GEO={GradPerSegm:6,CompressComp:true};a.GEO.BITS={kVisOverride:a.BIT(0),kVisNone:a.BIT(1),kVisThis:a.BIT(2),kVisDaughters:a.BIT(3),kVisOneLevel:a.BIT(4),kVisStreamed:a.BIT(5),kVisTouched:a.BIT(6),kVisOnScreen:a.BIT(7),kVisContainers:a.BIT(12),kVisOnly:a.BIT(13),kVisBranch:a.BIT(14),kVisRaytrace:a.BIT(15)};a.GEO.TestBit=function(e,g){var d=e.fGeoAtt;return d===undefined?false:((d&g)!==0)};a.GEO.SetBit=function(d,g,e){if(d.fGeoAtt===undefined){return}d.fGeoAtt=e?(d.fGeoAtt|g):(d.fGeoAtt&~g)};a.GEO.ToggleBit=function(d,e){if(d.fGeoAtt!==undefined){d.fGeoAtt=d.fGeoAtt^(e&16777215)}};a.GEO.InvisibleAll=function(d){if(d===undefined){d=true}a.GEO.SetBit(this,a.GEO.BITS.kVisThis,!d);a.GEO.SetBit(this,a.GEO.BITS.kVisDaughters,!d);a.GEO.SetBit(this,a.GEO.BITS.kVisOneLevel,false);if(this.fNodes){for(var f=0;f<this.fNodes.arr.length;++f){var e=this.fNodes.arr[f].fVolume;a.GEO.SetBit(e,a.GEO.BITS.kVisThis,!d)}}};a.GEO.warn=function(d){if(a.GEO._warn_msgs===undefined){a.GEO._warn_msgs={}}if(a.GEO._warn_msgs[d]!==undefined){return}a.GEO._warn_msgs[d]=true;console.warn(d)};a.GEO.NodeKind=function(d){if((d===undefined)||(d===null)||(typeof d!=="object")){return -1}return("fShape" in d)&&("fTrans" in d)?1:0};a.GEO.getNodeProperties=function(i,h,g){if(i===1){var d={name:h.fName,nname:h.fName,shape:h.fShape,material:null,chlds:null};if(h.fElements!==null){d.chlds=h.fElements.arr}if(g){var l=false,k=1;if(h.fRGBA[3]<1){l=true;k=h.fRGBA[3]}d.fillcolor=new b.Color(h.fRGBA[0],h.fRGBA[1],h.fRGBA[2]);d.material=new b.MeshLambertMaterial({transparent:l,opacity:k,wireframe:false,color:d.fillcolor,side:b.FrontSide,vertexColors:b.NoColors,overdraw:0});d.material.alwaysTransparent=l;d.material.inherentOpacity=k}return d}var j=h.fVolume;var d={name:j.fName,nname:h.fName,volume:h.fVolume,shape:j.fShape,material:null,chlds:null};if(h.fVolume.fNodes!==null){d.chlds=h.fVolume.fNodes.arr}if(g){var l=false,k=1;if((j.fFillColor>1)&&(j.fLineColor==1)){d.fillcolor=a.Painter.root_colors[j.fFillColor]}else{if(j.fLineColor>=0){d.fillcolor=a.Painter.root_colors[j.fLineColor]}}if(j.fMedium&&j.fMedium.fMaterial){var e=j.fMedium.fMaterial.fFillStyle;var f=(e<3000||e>3100)?0:e-3000;if(f>0){l=true;k=(100-f)/100}if(d.fillcolor===undefined){d.fillcolor=a.Painter.root_colors[j.fMedium.fMaterial.fFillColor]}}if(d.fillcolor===undefined){d.fillcolor="lightgrey"}d.material=new b.MeshLambertMaterial({transparent:l,opacity:k,wireframe:false,color:d.fillcolor,side:b.FrontSide,vertexColors:b.NoColors,overdraw:0});d.material.alwaysTransparent=l;d.material.inherentOpacity=k}return d};a.GEO.GeometryCreator=function(d){this.nfaces=d;this.indx=0;this.pos=new Float32Array(d*9);this.norm=new Float32Array(d*9);return this};a.GEO.GeometryCreator.prototype.AddFace3=function(f,n,i,e,m,h,d,k,g){var j=this.indx,l=this.pos;l[j]=f;l[j+1]=n;l[j+2]=i;l[j+3]=e;l[j+4]=m;l[j+5]=h;l[j+6]=d;l[j+7]=k;l[j+8]=g;this.last4=false;this.indx=j+9};a.GEO.GeometryCreator.prototype.StartPolygon=function(){};a.GEO.GeometryCreator.prototype.StopPolygon=function(){};a.GEO.GeometryCreator.prototype.AddFace4=function(f,q,j,e,p,i,d,n,h,r,l,g,m){var k=this.indx,o=this.pos;if(m!==1){o[k]=f;o[k+1]=q;o[k+2]=j;o[k+3]=e;o[k+4]=p;o[k+5]=i;o[k+6]=d;o[k+7]=n;o[k+8]=h;k+=9}if(m!==2){o[k]=f;o[k+1]=q;o[k+2]=j;o[k+3]=d;o[k+4]=n;o[k+5]=h;o[k+6]=r;o[k+7]=l;o[k+8]=g;k+=9}this.last4=(k!==this.indx+9);this.indx=k};a.GEO.GeometryCreator.prototype.SetNormal4=function(e,o,i,r,m,h,q,l,g,p,k,f,n){if(this.last4&&n){return console.error("missmatch between AddFace4 and SetNormal4 calls")}var j=this.indx-(this.last4?18:9),d=this.norm;if(n!==1){d[j]=e;d[j+1]=o;d[j+2]=i;d[j+3]=r;d[j+4]=m;d[j+5]=h;d[j+6]=q;d[j+7]=l;d[j+8]=g;j+=9}if(n!==2){d[j]=e;d[j+1]=o;d[j+2]=i;d[j+3]=q;d[j+4]=l;d[j+5]=g;d[j+6]=p;d[j+7]=k;d[j+8]=f}};a.GEO.GeometryCreator.prototype.RecalcZ=function(f){var g=this.pos,e=this.indx,d=e-(this.last4?18:9);while(d<e){g[d+2]=f(g[d],g[d+1],g[d+2]);d+=3}};a.GEO.GetNormal=function(g,p,m,e,o,l,d,n,k){var i=new b.Vector3(g,p,m),h=new b.Vector3(e,o,l),f=new b.Vector3(d,n,k),j=new b.Vector3(),q=new b.Vector3();j.subVectors(f,h);q.subVectors(i,h);j.cross(q);return j};a.GEO.GeometryCreator.prototype.CalcNormal=function(){var e=this.indx,d=this.norm;if(!this.cb){this.pA=new b.Vector3();this.pB=new b.Vector3();this.pC=new b.Vector3();this.cb=new b.Vector3();this.ab=new b.Vector3()}this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};a.GEO.GeometryCreator.prototype.SetNormal=function(d,h,g){var f=this.indx-9,e=this.norm;e[f]=e[f+3]=e[f+6]=d;e[f+1]=e[f+4]=e[f+7]=h;e[f+2]=e[f+5]=e[f+8]=g;if(this.last4){f-=9;e[f]=e[f+3]=e[f+6]=d;e[f+1]=e[f+4]=e[f+7]=h;e[f+2]=e[f+5]=e[f+8]=g}};a.GEO.GeometryCreator.prototype.SetNormal_12_34=function(e,g,i,f,j,l,k){if(k===undefined){k=0}var h=this.indx-((k>0)?9:18),d=this.norm;if(k!==1){d[h]=e;d[h+1]=g;d[h+2]=i;d[h+3]=e;d[h+4]=g;d[h+5]=i;d[h+6]=f;d[h+7]=j;d[h+8]=l;h+=9}if(k!==2){d[h]=e;d[h+1]=g;d[h+2]=i;d[h+3]=f;d[h+4]=j;d[h+5]=l;d[h+6]=f;d[h+7]=j;d[h+8]=l;h+=9}};a.GEO.GeometryCreator.prototype.Create=function(){if(this.nfaces!==this.indx/9){console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces")}var d=new b.BufferGeometry();d.addAttribute("position",new b.BufferAttribute(this.pos,3));d.addAttribute("normal",new b.BufferAttribute(this.norm,3));return d};a.GEO.PolygonsCreator=function(){this.polygons=[]};a.GEO.PolygonsCreator.prototype.StartPolygon=function(d){this.multi=1;this.mnormal=d};a.GEO.PolygonsCreator.prototype.StopPolygon=function(){if(!this.multi){return}this.multi=0;console.error("Polygon should be already closed at this moment")};a.GEO.PolygonsCreator.prototype.AddFace3=function(f,l,i,e,k,h,d,j,g){this.AddFace4(f,l,i,e,k,h,d,j,g,d,j,g,2)};a.GEO.PolygonsCreator.prototype.AddFace4=function(t,g,o,s,f,l,r,e,k,q,d,j,n){if(n===undefined){n=0}this.v1=new c.Vertex(t,g,o,0,0,0);this.v2=(n===1)?null:new c.Vertex(s,f,l,0,0,0);this.v3=new c.Vertex(r,e,k,0,0,0);this.v4=(n===2)?null:new c.Vertex(q,d,j,0,0,0);this.reduce=n;if(this.multi){if(n!==2){console.error("polygon not supported for not-reduced faces")}var m;if(this.multi++===1){m=new c.Polygon;m.vertices.push(this.mnormal?this.v2:this.v3);this.polygons.push(m)}else{m=this.polygons[this.polygons.length-1];var i=this.mnormal?m.vertices[m.vertices.length-1]:m.vertices[0],u=this.mnormal?this.v2:this.v3;if(u.diff(i)>1e-12){console.error("vertex missmatch when building polygon")}}var h=this.mnormal?m.vertices[0]:m.vertices[m.vertices.length-1],p=this.mnormal?this.v3:this.v2;if(p.diff(h)<1e-12){this.multi=0}else{if(this.mnormal){m.vertices.push(this.v3)}else{m.vertices.unshift(this.v2)}}return}var m=new c.Polygon;switch(n){case 0:m.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:m.vertices.push(this.v1,this.v3,this.v4);break;case 2:m.vertices.push(this.v1,this.v2,this.v3);break}this.polygons.push(m)};a.GEO.PolygonsCreator.prototype.SetNormal4=function(d,m,h,p,k,g,o,j,f,n,i,e,l){this.v1.setnormal(d,m,h);if(this.v2){this.v2.setnormal(p,k,g)}this.v3.setnormal(o,j,f);if(this.v4){this.v4.setnormal(n,i,e)}};a.GEO.PolygonsCreator.prototype.SetNormal_12_34=function(g,e,j,i,f,d,h){this.v1.setnormal(g,e,j);if(this.v2){this.v2.setnormal(g,e,j)}this.v3.setnormal(i,f,d);if(this.v4){this.v4.setnormal(i,f,d)}};a.GEO.PolygonsCreator.prototype.CalcNormal=function(){if(!this.cb){this.pA=new b.Vector3();this.pB=new b.Vector3();this.pC=new b.Vector3();this.cb=new b.Vector3();this.ab=new b.Vector3()}this.pA.set(this.v1.x,this.v1.y,this.v1.z);if(this.reduce!==1){this.pB.set(this.v2.x,this.v2.y,this.v2.z);this.pC.set(this.v3.x,this.v3.y,this.v3.z)}else{this.pB.set(this.v3.x,this.v3.y,this.v3.z);this.pC.set(this.v4.x,this.v4.y,this.v4.z)}this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};a.GEO.PolygonsCreator.prototype.SetNormal=function(d,f,e){this.v1.setnormal(d,f,e);if(this.v2){this.v2.setnormal(d,f,e)}this.v3.setnormal(d,f,e);if(this.v4){this.v4.setnormal(d,f,e)}};a.GEO.PolygonsCreator.prototype.RecalcZ=function(d){this.v1.z=d(this.v1.x,this.v1.y,this.v1.z);if(this.v2){this.v2.z=d(this.v2.x,this.v2.y,this.v2.z)}this.v3.z=d(this.v3.x,this.v3.y,this.v3.z);if(this.v4){this.v4.z=d(this.v4.x,this.v4.y,this.v4.z)}};a.GEO.PolygonsCreator.prototype.Create=function(){return{polygons:this.polygons}};a.GEO.createCube=function(e){var g=new b.Geometry();g.vertices.push(new b.Vector3(e.fDX,e.fDY,e.fDZ));g.vertices.push(new b.Vector3(e.fDX,e.fDY,-e.fDZ));g.vertices.push(new b.Vector3(e.fDX,-e.fDY,e.fDZ));g.vertices.push(new b.Vector3(e.fDX,-e.fDY,-e.fDZ));g.vertices.push(new b.Vector3(-e.fDX,e.fDY,-e.fDZ));g.vertices.push(new b.Vector3(-e.fDX,e.fDY,e.fDZ));g.vertices.push(new b.Vector3(-e.fDX,-e.fDY,-e.fDZ));g.vertices.push(new b.Vector3(-e.fDX,-e.fDY,e.fDZ));var j=[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4];var h=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1];var d=new b.Color();var f=null;for(var k=0;k<j.length;k+=3){if(k%6===0){f=new b.Vector3(h[k/2],h[k/2+1],h[k/2+2])}var i=new b.Face3(j[k],j[k+1],j[k+2],f,d,0);g.faces.push(i)}return g};a.GEO.createCubeBuffer=function(g,i){if(i<0){return 12}var f=g.fDX,e=g.fDY,d=g.fDZ;var h=i?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(12);h.AddFace4(f,e,d,f,-e,d,f,-e,-d,f,e,-d);h.SetNormal(1,0,0);h.AddFace4(-f,e,-d,-f,-e,-d,-f,-e,d,-f,e,d);h.SetNormal(-1,0,0);h.AddFace4(-f,e,-d,-f,e,d,f,e,d,f,e,-d);h.SetNormal(0,1,0);h.AddFace4(-f,-e,d,-f,-e,-d,f,-e,-d,f,-e,d);h.SetNormal(0,-1,0);h.AddFace4(-f,e,d,-f,-e,d,f,-e,d,f,e,d);h.SetNormal(0,0,1);h.AddFace4(f,e,-d,f,-e,-d,-f,-e,-d,-f,e,-d);h.SetNormal(0,0,-1);return h.Create()};a.GEO.createPara=function(j){var e=j.fTxy,d=j.fTxz,m=j.fTyz;var l=[-j.fZ*d-e*j.fY-j.fX,-j.fY-j.fZ*m,-j.fZ,-j.fZ*d+e*j.fY-j.fX,j.fY-j.fZ*m,-j.fZ,-j.fZ*d+e*j.fY+j.fX,j.fY-j.fZ*m,-j.fZ,-j.fZ*d-e*j.fY+j.fX,-j.fY-j.fZ*m,-j.fZ,j.fZ*d-e*j.fY-j.fX,-j.fY+j.fZ*m,j.fZ,j.fZ*d+e*j.fY-j.fX,j.fY+j.fZ*m,j.fZ,j.fZ*d+e*j.fY+j.fX,j.fY+j.fZ*m,j.fZ,j.fZ*d-e*j.fY+j.fX,-j.fY+j.fZ*m,j.fZ];var f=[4,6,5,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var k=new b.Geometry();for(var h=0;h<l.length;h+=3){k.vertices.push(new b.Vector3(l[h],l[h+1],l[h+2]))}var g=new b.Color();for(var h=0;h<f.length;h+=3){k.faces.push(new b.Face3(f[h],f[h+1],f[h+2],null,g,0))}k.computeFaceNormals();return k};a.GEO.create8edgesBuffer=function(l,k){var i=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];var f=(k>0)?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(12);for(var e=0;e<i.length;e+=4){var j=i[e]*3,h=i[e+1]*3,g=i[e+2]*3,d=i[e+3]*3;f.AddFace4(l[j],l[j+1],l[j+2],l[h],l[h+1],l[h+2],l[g],l[g+1],l[g+2],l[d],l[d+1],l[d+2]);if(e===0){f.SetNormal(0,0,1)}else{if(e===20){f.SetNormal(0,0,-1)}else{f.CalcNormal()}}}return f.Create()};a.GEO.createParaBuffer=function(e,i){if(i<0){return 12}var g=e.fTxy,f=e.fTxz,h=e.fTyz;var d=[-e.fZ*f-g*e.fY-e.fX,-e.fY-e.fZ*h,-e.fZ,-e.fZ*f+g*e.fY-e.fX,e.fY-e.fZ*h,-e.fZ,-e.fZ*f+g*e.fY+e.fX,e.fY-e.fZ*h,-e.fZ,-e.fZ*f-g*e.fY+e.fX,-e.fY-e.fZ*h,-e.fZ,e.fZ*f-g*e.fY-e.fX,-e.fY+e.fZ*h,e.fZ,e.fZ*f+g*e.fY-e.fX,e.fY+e.fZ*h,e.fZ,e.fZ*f+g*e.fY+e.fX,e.fY+e.fZ*h,e.fZ,e.fZ*f-g*e.fY+e.fX,-e.fY+e.fZ*h,e.fZ];return a.GEO.create8edgesBuffer(d,i)};a.GEO.createTrapezoid=function(f){var j,h;if(f._typename=="TGeoTrd1"){j=h=f.fDY}else{j=f.fDy1;h=f.fDy2}var d=[-f.fDx1,j,-f.fDZ,f.fDx1,j,-f.fDZ,f.fDx1,-j,-f.fDZ,-f.fDx1,-j,-f.fDZ,-f.fDx2,h,f.fDZ,f.fDx2,h,f.fDZ,f.fDx2,-h,f.fDZ,-f.fDx2,-h,f.fDZ];var l=[4,6,5,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var k=new b.Geometry();for(var g=0;g<24;g+=3){k.vertices.push(new b.Vector3(d[g],d[g+1],d[g+2]))}var e=new b.Color();for(var g=0;g<36;g+=3){k.faces.push(new b.Face3(l[g],l[g+1],l[g+2],null,e,0))}k.computeFaceNormals();return k};a.GEO.createTrapezoidBuffer=function(e,h){if(h<0){return 12}var g,f;if(e._typename=="TGeoTrd1"){g=f=e.fDY}else{g=e.fDy1;f=e.fDy2}var d=[-e.fDx1,g,-e.fDZ,e.fDx1,g,-e.fDZ,e.fDx1,-g,-e.fDZ,-e.fDx1,-g,-e.fDZ,-e.fDx2,f,e.fDZ,e.fDx2,f,e.fDZ,e.fDx2,-f,e.fDZ,-e.fDx2,-f,e.fDZ];return a.GEO.create8edgesBuffer(d,h)};a.GEO.createArb8=function(m){var l=[m.fXY[0][0],m.fXY[0][1],-m.fDZ,m.fXY[1][0],m.fXY[1][1],-m.fDZ,m.fXY[2][0],m.fXY[2][1],-m.fDZ,m.fXY[3][0],m.fXY[3][1],-m.fDZ,m.fXY[4][0],m.fXY[4][1],m.fDZ,m.fXY[5][0],m.fXY[5][1],m.fDZ,m.fXY[6][0],m.fXY[6][1],m.fDZ,m.fXY[7][0],m.fXY[7][1],m.fDZ];var g=[4,6,5,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];for(var e=3;e<l.length;e+=3){if((l[e-3]===l[e])&&(l[e-2]===l[e+1])&&(l[e-1]===l[e+2])){for(var h=0;h<g.length;++h){if(g[h]===e/3){g[h]=e/3-1}}}}var d=[];var p=[0,0,0,0,0,0,0,0];for(var h=0;h<g.length;h+=3){var v=g[h]*100+g[h+1]*10+g[h+2],u=g[h+1]*100+g[h+2]*10+g[h],t=g[h+2]*100+g[h]*10+g[h+1];if((g[h]==g[h+1])||(g[h]==g[h+2])||(g[h+1]==g[h+2])||(d.indexOf(v)>=0)||(d.indexOf(u)>=0)||(d.indexOf(t)>=0)){g[h]=g[h+1]=g[h+2]=-1}else{d.push(v,u,t);p[g[h]]++;p[g[h+1]]++;p[g[h+2]]++}}var r=new b.Geometry();for(var j=0;j<8;++j){if(p[j]>0){p[j]=r.vertices.length;r.vertices.push(new b.Vector3(l[j*3],l[j*3+1],l[j*3+2]))}else{p[j]=-1}}var f=new b.Color();for(var j=0;j<36;j+=3){if(g[j]<0){continue}var s=p[g[j]],q=p[g[j+1]],o=p[g[j+2]];r.faces.push(new b.Face3(s,q,o,null,f,0))}r.computeFaceNormals();return r};a.GEO.createArb8Buffer=function(g,m){if(m<0){return 12}var l=[g.fXY[0][0],g.fXY[0][1],-g.fDZ,g.fXY[1][0],g.fXY[1][1],-g.fDZ,g.fXY[2][0],g.fXY[2][1],-g.fDZ,g.fXY[3][0],g.fXY[3][1],-g.fDZ,g.fXY[4][0],g.fXY[4][1],g.fDZ,g.fXY[5][0],g.fXY[5][1],g.fDZ,g.fXY[6][0],g.fXY[6][1],g.fDZ,g.fXY[7][0],g.fXY[7][1],g.fDZ];var h=[4,7,6,6,5,4,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];for(var i=0;i<l.length;i+=l.length/2){for(var p=i;p<i+l.length/2-3;p+=3){for(var o=p+3;o<i+l.length/2;o+=3){if((l[p]===l[o])&&(l[p+1]===l[o+1])&&(l[p+2]===l[o+2])){for(var A=0;A<h.length;++A){if(h[A]===o/3){h[A]=p/3}}}}}}var C=[];var B=0;for(var A=0;A<h.length;A+=3){var f=h[A]*100+h[A+1]*10+h[A+2],e=h[A+1]*100+h[A+2]*10+h[A],d=h[A+2]*100+h[A]*10+h[A+1];if((h[A]==h[A+1])||(h[A]==h[A+2])||(h[A+1]==h[A+2])||(C.indexOf(f)>=0)||(C.indexOf(e)>=0)||(C.indexOf(d)>=0)){h[A]=h[A+1]=h[A+2]=-1}else{C.push(f,e,d);B++}}var q=m?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(B);for(var x=0;x<h.length;x+=6){var z=h[x]*3,y=h[x+1]*3,w=h[x+2]*3,v=h[x+3]*3,u=h[x+4]*3,t=h[x+5]*3,j=null;if((z>=0)&&(v>=0)&&m){if(x===0){j=new b.Vector3(0,0,1)}else{if(x===30){j=new b.Vector3(0,0,-1)}else{var s=a.GEO.GetNormal(l[z],l[z+1],l[z+2],l[y],l[y+1],l[y+2],l[w],l[w+1],l[w+2]);s.normalize();var r=a.GEO.GetNormal(l[v],l[v+1],l[v+2],l[u],l[u+1],l[u+2],l[t],l[t+1],l[t+2]);r.normalize();if(s.distanceToSquared(r)<1e-12){j=s}}}}if(j!==null){q.AddFace4(l[z],l[z+1],l[z+2],l[y],l[y+1],l[y+2],l[w],l[w+1],l[w+2],l[u],l[u+1],l[u+2]);q.SetNormal(j.x,j.y,j.z)}else{if(z>=0){q.AddFace3(l[z],l[z+1],l[z+2],l[y],l[y+1],l[y+2],l[w],l[w+1],l[w+2]);q.CalcNormal()}if(v>=0){q.AddFace3(l[v],l[v+1],l[v+2],l[u],l[u+1],l[u+2],l[t],l[t+1],l[t+2]);q.CalcNormal()}}}return q.Create()};a.GEO.createSphere=function(f,p){var A=f.fRmax,o=f.fRmin,t=f.fPhi1+180,x=f.fPhi2-f.fPhi1,h=f.fTheta1,u=f.fTheta2-f.fTheta1,g=f.fNseg,s=f.fNz;var d=(o<=0);while(t>=360){t-=360}if(p>0){var e=(d?2:4)*g*s/p;if(e>1){g=Math.round(g/Math.sqrt(e));s=Math.round(s/Math.sqrt(e))}}var m=new b.SphereGeometry(A,g,s,t*Math.PI/180,x*Math.PI/180,h*Math.PI/180,u*Math.PI/180);m.applyMatrix(new b.Matrix4().makeRotationX(Math.PI/2));var l=new b.Geometry();var C=new b.Color();for(var w=0;w<m.vertices.length;++w){l.vertices.push(m.vertices[w])}for(var w=0;w<m.faces.length;++w){var q=m.faces[w];l.faces.push(new b.Face3(q.a,q.b,q.c,null,C,0))}var F=l.vertices.length;if(d){if((u===180)&&(x===360)){l.computeFaceNormals();return l}l.vertices.push(new b.Vector3(0,0,0))}else{var B=o/A;for(var w=0;w<m.vertices.length;++w){var r=m.vertices[w];l.vertices.push(new b.Vector3(B*r.x,B*r.y,B*r.z))}for(var w=0;w<m.faces.length;++w){var q=m.faces[w];l.faces.push(new b.Face3(F+q.b,F+q.a,F+q.c,null,C,0))}}if(u!==180){for(var E=0;E<g;++E){if(d){l.faces.push(new b.Face3(E+0,E+1,F,null,C,0))}else{l.faces.push(new b.Face3(E+0,E+1,E+F,null,C,0));l.faces.push(new b.Face3(E+1,E+F+1,E+F,null,C,0))}}var G=m.vertices.length-g-1;for(var E=G;E<G+g;++E){if(d){l.faces.push(new b.Face3(E+0,E+1,F,null,C,0))}else{l.faces.push(new b.Face3(E+1,E+0,E+F,null,C,0));l.faces.push(new b.Face3(E+F+1,E+1,E+F,null,C,0))}}}if(x!==360){for(var D=0;D<s;D++){var z=D*(g+1);var y=(D+1)*(g+1);if(d){l.faces.push(new b.Face3(z,y,F,null,C,0))}else{l.faces.push(new b.Face3(y,z,z+F,null,C,0));l.faces.push(new b.Face3(y+F,y,z+F,null,C,0))}}for(var D=0;D<s;D++){var z=(D+1)*(g+1)-1;var y=(D+2)*(g+1)-1;if(d){l.faces.push(new b.Face3(z,y,F,null,C,0))}else{l.faces.push(new b.Face3(z,y,z+F,null,C,0));l.faces.push(new b.Face3(y,y+F,z+F,null,C,0))}}}l.computeFaceNormals();return l};a.GEO.createSphereBuffer=function(m,v){var D=[m.fRmax,m.fRmin],t=m.fPhi1,P=m.fPhi2-m.fPhi1,L=m.fTheta1,q=m.fTheta2-m.fTheta1,B=m.fNseg,N=m.fNz;var G=(D[1]<=0);if(v>0){var f=(G?2:4)*B*N/v;if(f>1){B=Math.max(4,Math.floor(B/Math.sqrt(f)));N=Math.max(4,Math.floor(N/Math.sqrt(f)))}}var u=B*N*2,A=B*2,h=B*2,y=P===360?0:N*(G?2:4),F=1e-10;if(G){h=A=B}if(v<0){return u*(G?1:2)+A+h+y}var O=new Float32Array(B+1),e=new Float32Array(B+1),M=new Float32Array(N+1),d=new Float32Array(N+1);for(var I=0;I<=N;++I){var l=(L+q/N*I)*Math.PI/180;M[I]=Math.sin(l);d[I]=Math.cos(l)}for(var I=0;I<=B;++I){var Q=(t+P/B*I)*Math.PI/180;O[I]=Math.sin(Q);e[I]=Math.cos(Q)}if(Math.abs(M[0])<=F){u-=B;A=0}if(Math.abs(M[N])<=F){u-=B;h=0}var p=u*(G?1:2)+A+h+y;var o=v?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(p);for(var i=0;i<2;++i){if((i===1)&&G){break}var E=D[i],C=(i===0)?1:-1,J=1-i,H=1-J;for(var K=0;K<N;++K){var x=K+J,w=K+H;var j=0;if(Math.abs(M[x])<=F){j=1}else{if(Math.abs(M[w])<=F){j=2}}for(var I=0;I<B;++I){o.AddFace4(E*M[x]*e[I],E*M[x]*O[I],E*d[x],E*M[x]*e[I+1],E*M[x]*O[I+1],E*d[x],E*M[w]*e[I+1],E*M[w]*O[I+1],E*d[w],E*M[w]*e[I],E*M[w]*O[I],E*d[w],j);o.SetNormal4(C*M[x]*e[I],C*M[x]*O[I],C*d[x],C*M[x]*e[I+1],C*M[x]*O[I+1],C*d[x],C*M[w]*e[I+1],C*M[w]*O[I+1],C*d[w],C*M[w]*e[I],C*M[w]*O[I],C*d[w],j)}}}for(var i=0;i<=N;i+=N){if(Math.abs(M[i])>=F){var g=M[i],z=d[i],J=(i===0)?0:1,H=1-J;for(var I=0;I<B;++I){o.AddFace4(D[1]*g*e[I+J],D[1]*g*O[I+J],D[1]*z,D[0]*g*e[I+J],D[0]*g*O[I+J],D[0]*z,D[0]*g*e[I+H],D[0]*g*O[I+H],D[0]*z,D[1]*g*e[I+H],D[1]*g*O[I+H],D[1]*z,G?2:0);o.CalcNormal()}}}if(P<360){for(var i=0;i<=B;i+=B){var g=O[i],z=e[i],J=(i===0)?1:0,H=1-J;for(var K=0;K<N;++K){o.AddFace4(D[1]*M[K+J]*z,D[1]*M[K+J]*g,D[1]*d[K+J],D[0]*M[K+J]*z,D[0]*M[K+J]*g,D[0]*d[K+J],D[0]*M[K+H]*z,D[0]*M[K+H]*g,D[0]*d[K+H],D[1]*M[K+H]*z,D[1]*M[K+H]*g,D[1]*d[K+H],G?2:0);o.CalcNormal()}}}return o.Create()};a.GEO.createTube=function(f){var h,B,g,A;if((f._typename=="TGeoCone")||(f._typename=="TGeoConeSeg")){h=f.fRmax2;B=f.fRmin2;g=f.fRmax1;A=f.fRmin1}else{h=g=f.fRmax;B=A=f.fRmin}var m=(B>0)||(A>0);if(m){if(B<=0){B=1e-7;a.GEO.warn("zero inner radius1 in tube - not yet supported")}if(A<=0){A=1e-7;a.GEO.warn("zero inner radius1 in tube - not yet supported")}}var l=0,r=360;if((f._typename=="TGeoConeSeg")||(f._typename=="TGeoTubeSeg")||(f._typename=="TGeoCtub")){l=f.fPhi1;r=f.fPhi2-f.fPhi1}var u=Math.round(r/a.GEO.GradPerSegm);if(u<4){u=4}var j=(r<360)?1:0;var q=u+j;var C=l*Math.PI/180,e=r/u*Math.PI/180;var k=new Float32Array(q),p=new Float32Array(q);for(var z=0;z<q;++z){p[z]=Math.cos(C+z*e);k[z]=Math.sin(C+z*e)}var o=new b.Geometry();if(m){for(var z=0;z<q;++z){o.vertices.push(new b.Vector3(B*p[z],B*k[z],f.fDZ))}for(var z=0;z<q;++z){o.vertices.push(new b.Vector3(A*p[z],A*k[z],-f.fDZ))}}else{o.vertices.push(new b.Vector3(0,0,f.fDZ));o.vertices.push(new b.Vector3(0,0,-f.fDZ))}var x=o.vertices.length;for(var z=0;z<q;++z){o.vertices.push(new b.Vector3(h*p[z],h*k[z],f.fDZ))}for(var z=0;z<q;++z){o.vertices.push(new b.Vector3(g*p[z],g*k[z],-f.fDZ))}if(f._typename=="TGeoCtub"){for(var s=0;s<o.vertices.length;++s){var y=o.vertices[s];if(y.z<0){y.z=-f.fDz-(y.x*f.fNlow[0]+y.y*f.fNlow[1])/f.fNlow[2]}else{y.z=f.fDz-(y.x*f.fNhigh[0]+y.y*f.fNhigh[1])/f.fNhigh[2]}}}var v=new b.Color();if(m){for(var z=0;z<u;++z){var d=(j===1)?(z+1):(z+1)%u;o.faces.push(new b.Face3(q+z,z,d,null,v,0));o.faces.push(new b.Face3(q+z,d,q+d,null,v,0))}}for(var z=0;z<u;++z){var d=(j===1)?(z+1):(z+1)%u;o.faces.push(new b.Face3(x+z,x+q+z,x+d,null,v,0));o.faces.push(new b.Face3(x+q+z,x+q+d,x+d,null,v,0))}for(var w=0;w<u;++w){var t=(j===1)?(w+1):(w+1)%u;if(m){o.faces.push(new b.Face3(w,w+x,t,null,v,0));o.faces.push(new b.Face3(w+x,t+x,t,null,v,0))}else{o.faces.push(new b.Face3(0,w+x,t+x,null,v,0))}}for(var w=0;w<u;++w){var t=(j===1)?(w+1):(w+1)%u;if(m){o.faces.push(new b.Face3(q+w+x,q+w,q+t,null,v,0));o.faces.push(new b.Face3(q+w+x,q+t,q+t+x,null,v,0))}else{o.faces.push(new b.Face3(q+w+x,1,q+t+x,null,v,0))}}if(j===1){if(m){o.faces.push(new b.Face3(0,q,x+q,null,v,0));o.faces.push(new b.Face3(0,x+q,x,null,v,0))}else{o.faces.push(new b.Face3(0,1,x+q,null,v,0));o.faces.push(new b.Face3(0,x+q,x,null,v,0))}if(m){o.faces.push(new b.Face3(u,x+2*u+1,2*u+1,null,v,0));o.faces.push(new b.Face3(u,x+u,x+2*u+1,null,v,0))}else{o.faces.push(new b.Face3(0,x+2*u+1,1,null,v,0));o.faces.push(new b.Face3(0,x+u,x+2*u+1,null,v,0))}}o.computeFaceNormals();return o};a.GEO.createTubeBuffer=function(h,p){var e,f;if((h._typename=="TGeoCone")||(h._typename=="TGeoConeSeg")){e=[h.fRmax2,h.fRmax1];f=[h.fRmin2,h.fRmin1]}else{e=[h.fRmax,h.fRmax];f=[h.fRmin,h.fRmin]}var n=(f[0]>0)||(f[1]>0);var l=0,s=360;if((h._typename=="TGeoConeSeg")||(h._typename=="TGeoTubeSeg")||(h._typename=="TGeoCtub")){l=h.fPhi1;s=h.fPhi2-h.fPhi1}var t=Math.max(4,Math.round(s/a.GEO.GradPerSegm));var u=t*(((e[0]<=0)||(e[1]<=0))?1:2);if(n){u+=t*(((f[0]<=0)||(f[1]<=0))?1:2)}if(e[0]>0){u+=t*((f[0]>0)?2:1)}if(e[1]>0){u+=t*((f[1]>0)?2:1)}if(s<360){u+=((e[0]>f[0])?2:0)+((e[1]>f[1])?2:0)}if(p<0){return u}var z=l*Math.PI/180,d=s/t*Math.PI/180,k=new Float32Array(t+1),o=new Float32Array(t+1);for(var v=0;v<=t;++v){o[v]=Math.cos(z+v*d);k[v]=Math.sin(z+v*d)}var q=p?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(u);var g;if(h._typename=="TGeoCtub"){g=function(D,F,E){var C=(E<0)?h.fNlow:h.fNhigh;return((E<0)?-h.fDz:h.fDz)-(D*C[0]+F*C[1])/C[2]}}for(var i=0;i<2;++i){if((i===1)&&!n){break}var m=(i===0)?e:f,B=i,A=1-i,j=1,x=0;if(m[0]!==m[1]){var w=Math.atan2((m[1]-m[0]),2*h.fDZ);j=Math.cos(w);x=Math.sin(w)}if(i===1){j*=-1;x*=-1}var r=0;if(m[0]<=0){r=2}else{if(m[1]<=0){r=1}}for(var v=0;v<t;++v){q.AddFace4(m[0]*o[v+B],m[0]*k[v+B],h.fDZ,m[1]*o[v+B],m[1]*k[v+B],-h.fDZ,m[1]*o[v+A],m[1]*k[v+A],-h.fDZ,m[0]*o[v+A],m[0]*k[v+A],h.fDZ,r);if(g){q.RecalcZ(g)}q.SetNormal_12_34(j*o[v+B],j*k[v+B],x,j*o[v+A],j*k[v+A],x,r)}}for(var i=0;i<2;++i){if(e[i]<=0){continue}var B=i,A=1-i,y=(i==0)?1:-1,r=(f[i]<=0)?2:0;if((r==2)&&(s===360)&&!g){q.StartPolygon(i===0)}for(var v=0;v<t;++v){q.AddFace4(f[i]*o[v+B],f[i]*k[v+B],y*h.fDZ,e[i]*o[v+B],e[i]*k[v+B],y*h.fDZ,e[i]*o[v+A],e[i]*k[v+A],y*h.fDZ,f[i]*o[v+A],f[i]*k[v+A],y*h.fDZ,r);if(g){q.RecalcZ(g);q.CalcNormal()}else{q.SetNormal(0,0,y)}}q.StopPolygon()}if(s<360){q.AddFace4(f[1]*o[0],f[1]*k[0],-h.fDZ,e[1]*o[0],e[1]*k[0],-h.fDZ,e[0]*o[0],e[0]*k[0],h.fDZ,f[0]*o[0],f[0]*k[0],h.fDZ,(e[0]===f[0])?2:((f[1]===e[1])?1:0));if(g){q.RecalcZ(g)}q.CalcNormal();q.AddFace4(f[0]*o[t],f[0]*k[t],h.fDZ,e[0]*o[t],e[0]*k[t],h.fDZ,e[1]*o[t],e[1]*k[t],-h.fDZ,f[1]*o[t],f[1]*k[t],-h.fDZ,(e[0]===f[0])?1:((f[1]===e[1])?2:0));if(g){q.RecalcZ(g)}q.CalcNormal()}return q.Create()};a.GEO.createEltu=function(i){var k=new b.Geometry();var e=Math.round(360/a.GEO.GradPerSegm);var l=new Float32Array(e),j=new Float32Array(e);for(var g=0;g<e;++g){var h=g/e*2*Math.PI;l[g]=i.fRmin*Math.cos(h);j[g]=i.fRmax*Math.sin(h)}for(var g=0;g<e;++g){k.vertices.push(new b.Vector3(l[g],j[g],-i.fDZ))}k.vertices.push(new b.Vector3(0,0,-i.fDZ));for(var g=0;g<e;++g){k.vertices.push(new b.Vector3(l[g],j[g],+i.fDZ))}k.vertices.push(new b.Vector3(0,0,i.fDZ));var f=new b.Color();for(var g=0;g<e;++g){var m=(g+1)%e;k.faces.push(new b.Face3(g+e+1,g,m,null,f,0));k.faces.push(new b.Face3(g+e+1,m,m+e+1,null,f,0))}for(var g=0;g<e;++g){k.faces.push(new b.Face3(g,e,(g+1)%e,null,f,0))}var d=e+1;for(var g=0;g<e;++g){k.faces.push(new b.Face3(d+g,d+(g+1)%e,d+e,null,f,0))}k.computeFaceNormals();return k};a.GEO.createEltuBuffer=function(l,r){var i=Math.max(4,Math.round(360/a.GEO.GradPerSegm));if(r<0){return i*4}var s=new Float32Array(i+1),q=new Float32Array(i+1);for(var j=0;j<=i;++j){var k=j/i*2*Math.PI;s[j]=l.fRmin*Math.cos(k);q[j]=l.fRmax*Math.sin(k)}var h=r?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(i*4);var e=1,p=0,t=1,n=0;for(var j=0;j<i;++j){h.AddFace4(s[j],q[j],+l.fDZ,s[j],q[j],-l.fDZ,s[j+1],q[j+1],-l.fDZ,s[j+1],q[j+1],l.fDZ);e=t;p=n;t=s[j+1]*l.fRmax/l.fRmin;n=q[j+1]*l.fRmin/l.fRmax;var o=Math.sqrt(t*t+n*n);t=t/o;n=n/o;h.SetNormal_12_34(e,p,0,t,n,0)}for(var m=0;m<2;++m){var g=(m===0)?1:-1,f=m,d=1-m;for(var j=0;j<i;++j){h.AddFace3(0,0,g*l.fDZ,s[j+f],q[j+f],g*l.fDZ,s[j+d],q[j+d],g*l.fDZ);h.SetNormal(0,0,g)}}return h.Create()};a.GEO.createTorus=function(e,l){var g=e.fR,A=e.fRmin,z=e.fRmax,k=e.fDphi-e.fPhi1,t=e.fPhi1,f=30,o=Math.max(8,Math.round(k/a.GEO.GradPerSegm)),h=A>0,x=(k!==360);if(l<0){return(h?4:2)*(f+1)*o}if(l>0){var d=(h?4:2)*(f+1)*o/l;if(d>1){f=Math.round(f/Math.sqrt(d));o=Math.round(o/Math.sqrt(d))}}var i=new b.Geometry();var u=new b.Color();var y=new b.TorusGeometry(g,z,f,o,k*Math.PI/180);y.applyMatrix(new b.Matrix4().makeRotationZ(t*Math.PI/180));for(var q=0;q<y.vertices.length;++q){i.vertices.push(y.vertices[q])}for(var q=0;q<y.faces.length;++q){var m=y.faces[q];i.faces.push(new b.Face3(m.a,m.b,m.c,null,u,0))}var w=i.vertices.length;if(h){var p=new b.TorusGeometry(g,A,f,o,k*Math.PI/180);p.applyMatrix(new b.Matrix4().makeRotationZ(t*Math.PI/180));for(var q=0;q<p.vertices.length;++q){i.vertices.push(p.vertices[q])}for(var q=0;q<p.faces.length;++q){var m=p.faces[q];i.faces.push(new b.Face3(w+m.a,w+m.c,w+m.b,null,u,0))}}else{if(x){i.vertices.push(new b.Vector3(g*Math.cos(t*Math.PI/180),g*Math.sin(t*Math.PI/180),0));i.vertices.push(new b.Vector3(g*Math.cos((t+k)*Math.PI/180),g*Math.sin((t+k)*Math.PI/180),0))}}if(k!==360){for(var v=0;v<f;v++){var s=v*(o+1);var r=(v+1)*(o+1);if(h){i.faces.push(new b.Face3(r,s+w,s,null,u,0));i.faces.push(new b.Face3(r,r+w,s+w,null,u,0))}else{i.faces.push(new b.Face3(w,s,r,null,u,0))}}for(var v=0;v<f;v++){var s=(v+1)*(o+1)-1;var r=(v+2)*(o+1)-1;if(h){i.faces.push(new b.Face3(r,s,s+w,null,u,0));i.faces.push(new b.Face3(r,s+w,r+w,null,u,0))}else{i.faces.push(new b.Face3(w+1,r,s,null,u,0))}}}i.computeFaceNormals();return i};a.GEO.createTorusBuffer=function(h,s){var m=h.fR,j=Math.max(6,Math.round(360/a.GEO.GradPerSegm)),x=Math.max(8,Math.round(h.fDphi/a.GEO.GradPerSegm));var H=(h.fRmin>0?4:2)*j*(x+(h.fDphi!==360?1:0));if(s<0){return H}if((s>0)&&(H>s)){j=Math.floor(j/Math.sqrt(H/s));x=Math.floor(x/Math.sqrt(H/s));H=(h.fRmin>0?4:2)*j*(x+(h.fDphi!==360?1:0))}var K=new Float32Array(j+1),A=new Float32Array(j+1),I=new Float32Array(x+1),z=new Float32Array(x+1);for(var E=0;E<=j;++E){K[E]=Math.sin(E/j*2*Math.PI);A[E]=Math.cos(E/j*2*Math.PI)}for(var C=0;C<=x;++C){var J=(h.fPhi1+h.fDphi*C/x)/180*Math.PI;I[C]=Math.sin(J);z[C]=Math.cos(J)}var v=s?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(H);var g=new b.Vector3(),f=new b.Vector3(),e=new b.Vector3(),d=new b.Vector3(),u=new b.Vector3(),r=new b.Vector3(),q=new b.Vector3(),p=new b.Vector3(),o=new b.Vector3(),l=new b.Vector3();for(var i=0;i<2;++i){if((i>0)&&(h.fRmin<=0)){break}var k=(i>0)?h.fRmin:h.fRmax,N=1-i,L=1-N,M=i>0?-1:1;for(var C=0;C<x;++C){var y=C+N,w=C+L;o.x=m*z[y];o.y=m*I[y];l.x=m*z[w];l.y=m*I[w];for(var E=0;E<j;++E){g.x=(m+k*A[E])*z[y];g.y=(m+k*A[E])*I[y];g.z=k*K[E];f.x=(m+k*A[E+1])*z[y];f.y=(m+k*A[E+1])*I[y];f.z=k*K[E+1];e.x=(m+k*A[E+1])*z[w];e.y=(m+k*A[E+1])*I[w];e.z=k*K[E+1];d.x=(m+k*A[E])*z[w];d.y=(m+k*A[E])*I[w];d.z=k*K[E];v.AddFace4(g.x,g.y,g.z,f.x,f.y,f.z,e.x,e.y,e.z,d.x,d.y,d.z);u.subVectors(g,o).normalize();r.subVectors(f,o).normalize();q.subVectors(e,l).normalize();p.subVectors(d,l).normalize();v.SetNormal4(M*u.x,M*u.y,M*u.z,M*r.x,M*r.y,M*r.z,M*q.x,M*q.y,M*q.z,M*p.x,M*p.y,M*p.z)}}}if(h.fDphi!==360){for(var C=0;C<=x;C+=x){var D=h.fRmax,B=h.fRmin,N=(C>0)?0:1,L=1-N,F=(h.fRmin)>0?0:1,G=C>0?1:-1;for(var E=0;E<j;++E){v.AddFace4((m+D*A[E+N])*z[C],(m+D*A[E+N])*I[C],D*K[E+N],(m+B*A[E+N])*z[C],(m+B*A[E+N])*I[C],B*K[E+N],(m+B*A[E+L])*z[C],(m+B*A[E+L])*I[C],B*K[E+L],(m+D*A[E+L])*z[C],(m+D*A[E+L])*I[C],D*K[E+L],F);v.SetNormal(-G*I[C],G*z[C],0)}}}return v.Create()};a.GEO.createPolygon=function(k){var p=k.fPhi1,w=k.fDphi;var x=60;if(k._typename=="TGeoPgon"){x=k.fNedges}else{x=Math.round(w/a.GEO.GradPerSegm);if(x<4){x=4}}var r=new b.Geometry();var y=new b.Color();var q=false;for(var O=0;O<k.fNz;++O){if(k.fRmin[O]>0){q=true}}var M=p*Math.PI/180,h=w/x*Math.PI/180;var n=new Float32Array(x+1),s=new Float32Array(x+1);for(var B=0;B<=x;++B){s[B]=Math.cos(M+B*h);n[B]=Math.sin(M+B*h)}var J=[[],[]],v=null,m=null;var P=x;if(w!==360){v=[];m=[];P+=1}var L,K,I,F,E;for(var l=0;l<2;++l){var u=(l===0)?"fRmax":"fRmin";var t=r.vertices.length;for(var O=0;O<k.fNz;++O){J[l][O]=r.vertices.length;var o=k.fZ[O],N=k[u][O];if((O>0)&&(O<k.fNz-1)){if(((k.fZ[O-1]===o)&&(k[u][O-1]===N))||((k[u][O+1]===N)&&(k[u][O-1]===N))){J[l][O]=J[l][O-1];continue}}if(N<=0){N=0.000001}var A=r.vertices.length;if((l===0)||q){for(var B=0;B<P;++B){r.vertices.push(new b.Vector3(N*s[B],N*n[B],o))}}else{r.vertices.push(new b.Vector3(0,0,o))}if(v!==null){if(l===0){v.push(new b.Vector2(N,o));m.push(A)}else{if(N<k.fRmax[O]){v.unshift(new b.Vector2(N,o));m.unshift(A)}}}if((O>0)&&((l===0)||q)){for(var B=0;B<x;++B){var g=(B+1)%P;r.faces.push(new b.Face3(t+B,(l===0)?(t+g):(A+B),A+g,null,y,0));r.faces.push(new b.Face3(t+B,A+g,(l===0)?(A+B):t+g,null,y,0))}}t=A}}for(var O=0;O<k.fNz;O+=(k.fNz-1)){if(k.fRmin[O]>=k.fRmax[O]){continue}var D=J[1][O],H=J[0][O];for(var B=0;B<x;++B){var g=(B+1)%P;if(q){r.faces.push(new b.Face3(H+B,(O===0)?(D+B):(H+g),D+g,null,y,0));r.faces.push(new b.Face3(H+B,D+g,(O===0)?(H+g):(D+B),null,y,0))}else{if(O==0){r.faces.push(new b.Face3(H+B,D,H+g,null,y,0))}else{r.faces.push(new b.Face3(H+g,D,H+B,null,y,0))}}}}if(v!==null){var j=[];if(v.length===k.fNz*2){for(var O=k.fNz-1;O>0;--O){if(k.fZ[O]===k.fZ[O-1]){continue}var G=2*k.fNz-1-O;j.push([G,O-1,O]);j.push([G,G+1,O-1])}}else{j=b.ShapeUtils.triangulateShape(v,[])}for(var z=0;z<j.length;++z){var C=j[z];r.faces.push(new b.Face3(m[C[0]],m[C[1]],m[C[2]],null,y,0))}for(var z=0;z<j.length;++z){var C=j[z];r.faces.push(new b.Face3(m[C[0]]+x,m[C[2]]+x,m[C[1]]+x,null,y,0))}}r.computeFaceNormals();return r};a.GEO.createPolygonBuffer=function(t,x){var M=t.fPhi1,w=t.fDphi,L=60;if(t._typename=="TGeoPgon"){L=t.fNedges}else{L=Math.max(5,Math.round(w/a.GEO.GradPerSegm))}var o=new Int16Array(2*t.fNz),O=0,y=false;for(var e=0;e<t.fNz;++e){if(t.fRmin[e]>0){y=true}}if(x<0){return(y?4:2)*L*(t.fNz-1)}var j=(w===360)?null:[];for(var r=0;r<2;++r){var h=(r===0)?"fRmax":"fRmin";for(var e=0;e<t.fNz;++e){var C=t.fZ[e],f=t[h][e];o[e*2+r]=0;if((e>0)&&(e<t.fNz-1)){if(((t.fZ[e-1]===C)&&(t[h][e-1]===f))||((t[h][e+1]===f)&&(t[h][e-1]===f))){continue}}if((e>0)&&((r===0)||y)){o[e*2+r]=1;O++}if(j!==null){if(r===0){j.push(new b.Vector2(f,C))}else{if(f<t.fRmax[e]){j.unshift(new b.Vector2(f,C))}}}}}var v=O*L*2;if(t.fRmin[0]!==t.fRmax[0]){v+=L*(y?2:1)}if(t.fRmin[t.fNz-1]!==t.fRmax[t.fNz-1]){v+=L*(y?2:1)}var K=null;if(j!==null){if(j.length===t.fNz*2){K=[];for(var e=t.fNz-1;e>0;--e){if(t.fZ[e]===t.fZ[e-1]){continue}var E=2*t.fNz-1-e;K.push([E,e-1,e]);K.push([E,E+1,e-1])}}else{K=b.ShapeUtils.triangulateShape(j,[])}v+=K.length*2}var i=M*Math.PI/180,d=w/L*Math.PI/180;var l=new Float32Array(L+1),g=new Float32Array(L+1);for(var z=0;z<=L;++z){g[z]=Math.cos(i+z*d);l[z]=Math.sin(i+z*d)}var u=x?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(v);for(var r=0;r<2;++r){var h=(r===0)?"fRmax":"fRmin",B=t.fZ[0],p=t[h][0],J=1-r,I=r;for(var e=0;e<t.fNz;++e){if(o[e*2+r]===0){continue}var A=t.fZ[e],m=t[h][e],G=1,F=0;if((m!==p)){var s=Math.atan2((m-p),(A-B));G=Math.cos(s);F=Math.sin(s)}if(r>0){G*=-1;F*=-1}for(var z=0;z<L;++z){u.AddFace4(p*g[z+J],p*l[z+J],B,m*g[z+J],m*l[z+J],A,m*g[z+I],m*l[z+I],A,p*g[z+I],p*l[z+I],B);u.SetNormal_12_34(G*g[z+J],G*l[z+J],F,G*g[z+I],G*l[z+I],F)}B=A;p=m}}for(var e=0;e<t.fNz;e+=(t.fNz-1)){var D=t.fRmin[e],k=t.fRmax[e];if(D===k){continue}var C=t.fZ[e],J=(e===0)?1:0,I=1-J,q=(e===0)?-1:1;if(!y&&!K){u.StartPolygon(e>0)}for(var z=0;z<L;++z){u.AddFace4(D*g[z+J],D*l[z+J],C,k*g[z+J],k*l[z+J],C,k*g[z+I],k*l[z+I],C,D*g[z+I],D*l[z+I],C,y?0:2);u.SetNormal(0,0,q)}u.StopPolygon()}if(K){for(var z=0;z<=L;z+=L){var J=(z===0)?1:2,I=3-J;for(var H=0;H<K.length;++H){var Q=j[K[H][0]],P=j[K[H][J]],N=j[K[H][I]];u.AddFace3(Q.x*g[z],Q.x*l[z],Q.y,P.x*g[z],P.x*l[z],P.y,N.x*g[z],N.x*l[z],N.y);u.CalcNormal()}}}return u.Create()};a.GEO.createXtru=function(m,q){if(q<0){return 2*m.fNz*m.fNvert}var p=new b.Geometry(),n=new b.Color(),g=0,r=0;for(var l=0;l<m.fNz;++l){var d=m.fZ[l],f=m.fScale[l];g=r;r=p.vertices.length;for(var k=0;k<m.fNvert;++k){p.vertices.push(new b.Vector3(f*m.fX[k],f*m.fY[k],d))}if(l>0){for(var k=0;k<m.fNvert;++k){var o=(k+1)%m.fNvert;p.faces.push(new b.Face3(g+k,r+k,r+o,null,n,0));p.faces.push(new b.Face3(g+k,r+o,g+o,null,n,0))}}}var h=[];for(var k=0;k<m.fNvert;++k){h.push(new b.Vector2(m.fX[k],m.fY[k]))}var e=b.ShapeUtils.triangulateShape(h,[]);for(var j=0;j<e.length;++j){face=e[j];p.faces.push(new b.Face3(face[1],face[0],face[2],null,n,0));p.faces.push(new b.Face3(face[0]+r,face[1]+r,face[2]+r,null,n,0))}p.computeFaceNormals();return p};a.GEO.createXtruBuffer=function(d,h){var o=(d.fNz-1)*d.fNvert*2;if(h<0){return o+d.fNvert*3}var p=[];for(var t=0;t<d.fNvert;++t){p.push(new b.Vector2(d.fX[t],d.fY[t]))}var e=b.ShapeUtils.triangulateShape(p,[]);if(e.length<p.length-2){a.GEO.warn("Problem with XTRU shape "+d.fName+" with "+p.length+" vertices");e=[]}else{o+=e.length*2}var k=h?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(o);for(var x=0;x<d.fNz-1;++x){var m=d.fZ[x],s=d.fScale[x],l=d.fZ[x+1],r=d.fScale[x+1];for(var g=0;g<d.fNvert;++g){var f=(g+1)%d.fNvert;k.AddFace4(s*d.fX[g],s*d.fY[g],m,r*d.fX[g],r*d.fY[g],l,r*d.fX[f],r*d.fY[f],l,s*d.fX[f],s*d.fY[f],m);k.CalcNormal()}}for(x=0;x<=d.fNz-1;x+=(d.fNz-1)){var j=d.fZ[x],y=d.fScale[x];for(var q=0;q<e.length;++q){var i=e[q],w=p[i[0]],v=p[i[(x===0)?2:1]],u=p[i[(x===0)?1:2]];k.AddFace3(y*w.x,y*w.y,j,y*v.x,y*v.y,j,y*u.x,y*u.y,j);k.SetNormal(0,0,x===0?-1:1)}}return k.Create()};a.GEO.createParaboloid=function(g,o){var u=Math.round(360/6),q=30;if(o>0){var f=2*(u+1)*(q+1)/o;if(f>1){u=Math.round(u/Math.sqrt(f));q=Math.round(q/Math.sqrt(f))}}var h=new Float32Array(u),n=new Float32Array(u);for(var x=0;x<u;++x){n[x]=Math.cos(x/u*2*Math.PI);h[x]=Math.sin(x/u*2*Math.PI)}var m=new b.Geometry();var k=new b.Color();var y=-g.fDZ,A=g.fDZ,t=g.fRlo,v=g.fRhi;if(g.fA>=0){if(g.fB>y){y=g.fB}}else{if(g.fB<A){A=g.fB}}var r=Math.atan2(y,t),s=Math.atan2(A,v);var p=0,j=0;for(var B=0;B<=q+1;++B){var i=A,l=0;if((B===q+1)&&(j===0)){break}switch(B){case 0:i=y;l=t;break;case q:i=A;l=v;break;case q+1:i=A;l=0;break;default:var e=Math.tan(r+(s-r)*B/q);var z=e*e-4*g.fA*g.fB;l=0.5*(e+Math.sqrt(z))/g.fA;if(l<0.000001){l=0}i=l*e}var w=m.vertices.length;if(l===0){m.vertices.push(new b.Vector3(0,0,i))}else{for(var x=0;x<u;++x){m.vertices.push(new b.Vector3(l*n[x],l*h[x],i))}}if(B>0){for(var x=0;x<u;++x){var d=(x+1)%u;if(j===0){m.faces.push(new b.Face3(p,w+d,w+x,null,k,0))}else{if(l==0){m.faces.push(new b.Face3(p+x,p+d,w,null,k,0))}else{m.faces.push(new b.Face3(p+x,w+d,w+x,null,k,0));m.faces.push(new b.Face3(p+x,p+d,w+d,null,k,0))}}}}j=l;p=w}m.computeFaceNormals();return m};a.GEO.createParaboloidBuffer=function(f,n){var v=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),p=30;if(n>0){var e=2*v*(p+1)/n;if(e>1){v=Math.max(5,Math.floor(v/Math.sqrt(e)));p=Math.max(5,Math.floor(p/Math.sqrt(e)))}}var B=-f.fDZ,D=f.fDZ,u=f.fRlo,w=f.fRhi;if(f.fA>=0){if(f.fB>B){B=f.fB}}else{if(f.fB<D){D=f.fB}}var q=Math.atan2(B,u),s=Math.atan2(D,w);var y=(p+1)*v*2;if(u===0){y-=v*2}if(w===0){y-=v*2}if(n<0){return y}var h=new Float32Array(v+1),m=new Float32Array(v+1);for(var z=0;z<=v;++z){m[z]=Math.cos(z/v*2*Math.PI);h[z]=Math.sin(z/v*2*Math.PI)}var o=n?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(y);var r=B,x=0,l=0,k=-1;for(var E=0;E<=p+1;++E){var i=0,j=0,g=0,A=-1;if((E===0)&&(u===0)){continue}if((E===p+1)&&(x===0)){break}switch(E){case 0:i=B;j=u;break;case p:i=D;j=w;break;case p+1:i=D;j=0;break;default:var d=Math.tan(q+(s-q)*E/p);var C=d*d-4*f.fA*f.fB;j=0.5*(d+Math.sqrt(C))/f.fA;if(j<0.000001){j=0}i=j*d}g=f.fA*j;A=(f.fA>0)?-1:1;var t=0;if(x===0){t=1}else{if(j===0){t=2}}for(var z=0;z<v;++z){o.AddFace4(j*m[z],j*h[z],i,x*m[z],x*h[z],r,x*m[z+1],x*h[z+1],r,j*m[z+1],j*h[z+1],i,t);if((t===0)||((E===1)&&(u===0))||((E===p+1)&&(w===0))){o.SetNormal4(g*m[z],g*h[z],A,l*m[z],l*h[z],k,l*m[z+1],l*h[z+1],k,g*m[z+1],g*h[z+1],A,t)}else{o.SetNormal(0,0,(E<p)?-1:1)}}r=i;x=j;l=g;k=A}return o.Create()};a.GEO.createHype=function(f,o){if((f.fTin===0)&&(f.fTout===0)){return a.GEO.createTubeBuffer(f,o)}var r=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),q=30;if(o<0){return((f.fRmin<=0)?2:4)*(r+1)*(q+2)}if(o>0){var e=((f.fRmin<=0)?2:4)*(r+1)*(q+2)/o;if(e>1){r=Math.round(r/Math.sqrt(e));q=Math.round(q/Math.sqrt(e))}}var h=new Float32Array(r),m=new Float32Array(r);for(var u=0;u<r;++u){m[u]=Math.cos(u/r*2*Math.PI);h[u]=Math.sin(u/r*2*Math.PI)}var l=new b.Geometry();var i=new b.Color();var n=[[],[]];for(var g=0;g<2;++g){if((g===0)&&(f.fRmin<=0)){n[g][0]=l.vertices.length;l.vertices.push(new b.Vector3(0,0,-f.fDz));n[g][q]=l.vertices.length;l.vertices.push(new b.Vector3(0,0,f.fDz));continue}var p=0;var t=(g===0)?f.fRmin:f.fRmax;var x=(g===0)?f.fTinsq:f.fToutsq;for(var y=0;y<=q;++y){var j=-f.fDz+y/q*2*f.fDz;var k=Math.sqrt(t*t+x*j*j);var s=l.vertices.length;n[g][y]=s;for(var u=0;u<r;++u){l.vertices.push(new b.Vector3(k*m[u],k*h[u],j))}if(y>0){for(var u=0;u<r;++u){var d=(u+1)%r;l.faces.push(new b.Face3(p+u,(g===0)?(s+u):(p+d),s+d,null,i,0));l.faces.push(new b.Face3(p+u,s+d,(g===0)?(p+d):(s+u),null,i,0))}}p=s}}for(var y=0;y<=q;y+=q){var v=n[0][y],w=n[1][y];for(var u=0;u<r;++u){var d=(u+1)%r;if(f.fRmin<=0){l.faces.push(new b.Face3(v,w+(y===0?d:u),w+(y===0?u:d),null,i,0))}else{l.faces.push(new b.Face3(v+u,(y===0)?(v+d):(w+u),w+d,null,i,0));l.faces.push(new b.Face3(v+u,w+d,(y===0)?(w+u):(v+d),null,i,0))}}}l.computeFaceNormals();return l};a.GEO.createHypeBuffer=function(d,h){if((d.fTin===0)&&(d.fTout===0)){return a.GEO.createTubeBuffer(d,h)}var o=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),m=30;var s=o*(m+1)*((d.fRmin>0)?4:2);if(h<0){return s}if((h>0)&&(h>s)){o=Math.max(4,Math.floor(o/Math.sqrt(s/h)));m=Math.max(4,Math.floor(m/Math.sqrt(s/h)));s=o*(m+1)*((d.fRmin>0)?4:2)}var f=new Float32Array(o+1),g=new Float32Array(o+1);for(var t=0;t<=o;++t){g[t]=Math.cos(t/o*2*Math.PI);f[t]=Math.sin(t/o*2*Math.PI)}var j=h?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(s);for(var e=0;e<2;++e){if((e>0)&&(d.fRmin<=0)){break}var r=(e>0)?d.fRmin:d.fRmax,u=(e>0)?d.fTinsq:d.fToutsq,x=1-e,w=1-x;for(var v=0;v<m;++v){var l=-d.fDz+v/m*2*d.fDz,k=-d.fDz+(v+1)/m*2*d.fDz,q=Math.sqrt(r*r+u*l*l),p=Math.sqrt(r*r+u*k*k);for(var t=0;t<o;++t){j.AddFace4(q*g[t+x],q*f[t+x],l,p*g[t+x],p*f[t+x],k,p*g[t+w],p*f[t+w],k,q*g[t+w],q*f[t+w],l);j.CalcNormal()}}}for(var v=0;v<2;++v){var i=(v===0)?d.fDz:-d.fDz,q=Math.sqrt(d.fRmax*d.fRmax+d.fToutsq*i*i),p=(d.fRmin>0)?Math.sqrt(d.fRmin*d.fRmin+d.fTinsq*i*i):0,n=(d.fRmin>0)?0:1,x=1-v,w=1-x;for(var t=0;t<o;++t){j.AddFace4(q*g[t+x],q*f[t+x],i,p*g[t+x],p*f[t+x],i,p*g[t+w],p*f[t+w],i,q*g[t+w],q*f[t+w],i,n);j.SetNormal(0,0,(v===0)?1:-1)}}return j.Create()};a.GEO.createMatrix=function(e){if(e===null){return null}var g=null,d=null;if(e._typename=="TGeoTranslation"){g=e.fTranslation}else{if(e._typename=="TGeoRotation"){d=e.fRotationMatrix}else{if(e._typename=="TGeoCombiTrans"){g=e.fTranslation;if(e.fRotation!==null){d=e.fRotation.fRotationMatrix}}else{if(e._typename!=="TGeoIdentity"){}}}}if((g===null)&&(d===null)){return null}var f=new b.Matrix4();if(d!==null){f.set(d[0],d[1],d[2],0,d[3],d[4],d[5],0,d[6],d[7],d[8],0,0,0,0,1)}if(g!==null){f.setPosition(new b.Vector3(g[0],g[1],g[2]))}return f};a.GEO.getNodeMatrix=function(f,e){var j=null;if(f===1){j=new b.Matrix4();if(e.fTrans!==null){j.set(e.fTrans[0],e.fTrans[4],e.fTrans[8],0,e.fTrans[1],e.fTrans[5],e.fTrans[9],0,e.fTrans[2],e.fTrans[6],e.fTrans[10],0,0,0,0,1);j.setPosition({x:e.fTrans[12],y:e.fTrans[13],z:e.fTrans[14]})}}else{if(("fMatrix" in e)&&(e.fMatrix!==null)){j=a.GEO.createMatrix(e.fMatrix)}else{if((e._typename=="TGeoNodeOffset")&&(e.fFinder!==null)){var i=a.BIT(14);if((e.fFinder.fBits&i)!==0){a.GEO.warn("Unsupported reflected pattern "+e.fFinder._typename)}switch(e.fFinder._typename){case"TGeoPatternX":case"TGeoPatternY":case"TGeoPatternZ":case"TGeoPatternParaX":case"TGeoPatternParaY":case"TGeoPatternParaZ":var g=e.fFinder.fStart+(e.fIndex+0.5)*e.fFinder.fStep;j=new b.Matrix4();switch(e.fFinder._typename.charAt(e.fFinder._typename.length-1)){case"X":j.setPosition(new b.Vector3(g,0,0));break;case"Y":j.setPosition(new b.Vector3(0,g,0));break;case"Z":j.setPosition(new b.Vector3(0,0,g));break}break;case"TGeoPatternCylPhi":var h=(Math.PI/180)*(e.fFinder.fStart+(e.fIndex+0.5)*e.fFinder.fStep);var d=Math.cos(h),l=Math.sin(h);j=new b.Matrix4();j.set(d,-l,0,0,l,d,0,0,0,0,1,0,0,0,0,1);break;case"TGeoPatternCylR":j=new b.Matrix4();break;case"TGeoPatternTrapZ":var k=e.fFinder.fStart+(e.fIndex+0.5)*e.fFinder.fStep;j=new b.Matrix4();j.setPosition(new b.Vector3(e.fFinder.fTxz*k,e.fFinder.fTyz*k,k));break;break;default:a.GEO.warn("Unsupported pattern type "+e.fFinder._typename);break}}}}return j};a.GEO.createComposite=function(h,j){if(j<0){return a.GEO.createGeometry(h.fNode.fLeft,-1)+a.GEO.createGeometry(h.fNode.fRight,-1)}var k,i,g,f,e=false,d=a.GEO.createMatrix(h.fNode.fLeftMat),l=a.GEO.createMatrix(h.fNode.fRightMat);if(j===0){j=(a.browser&&a.browser.isIE)?7000:10000}else{e=true}if(d&&(d.determinant()<-0.9)){a.GEO.warn("Axis reflection in composite shape - not supported")}if(l&&(l.determinant()<-0.9)){a.GEO.warn("Axis reflections in composite shape - not supported")}k=a.GEO.createGeometry(h.fNode.fLeft,j/2);i=a.GEO.createGeometry(h.fNode.fRight,j/2);if(k instanceof b.Geometry){k.computeVertexNormals()}g=new c.Geometry(k,d,a.GEO.CompressComp?0:undefined);if(i instanceof b.Geometry){i.computeVertexNormals()}f=new c.Geometry(i,l,g.maxid);g.maxid=f.maxid;switch(h.fNode._typename){case"TGeoIntersection":g.direct_intersect(f);break;case"TGeoUnion":g.direct_union(f);break;case"TGeoSubtraction":g.direct_subtract(f);break;default:a.GEO.warn("unsupported bool operation "+h.fNode._typename+", use first geom")}if(a.GEO.numGeometryFaces(g)===0){a.GEO.warn("Zero faces in comp shape left: "+h.fNode.fLeft._typename+" "+a.GEO.numGeometryFaces(k)+" faces right: "+h.fNode.fRight._typename+" "+a.GEO.numGeometryFaces(i)+" faces  use first");g=new c.Geometry(k,d)}return e?{polygons:g.toPolygons()}:g.toBufferGeometry()};a.GEO.createGeometry=function(g,f){if(f===undefined){f=0}try{switch(g._typename){case"TGeoBBox":return a.GEO.createCubeBuffer(g,f);case"TGeoPara":return a.GEO.createParaBuffer(g,f);case"TGeoTrd1":case"TGeoTrd2":return a.GEO.createTrapezoidBuffer(g,f);case"TGeoArb8":case"TGeoTrap":case"TGeoGtra":return a.GEO.createArb8Buffer(g,f);case"TGeoSphere":return a.GEO.createSphereBuffer(g,f);case"TGeoCone":case"TGeoConeSeg":case"TGeoTube":case"TGeoTubeSeg":case"TGeoCtub":return a.GEO.createTubeBuffer(g,f);case"TGeoEltu":return a.GEO.createEltuBuffer(g,f);case"TGeoTorus":return a.GEO.createTorusBuffer(g,f);case"TGeoPcon":case"TGeoPgon":return a.GEO.createPolygonBuffer(g,f);case"TGeoXtru":return a.GEO.createXtruBuffer(g,f);case"TGeoParaboloid":return a.GEO.createParaboloidBuffer(g,f);case"TGeoHype":return a.GEO.createHypeBuffer(g,f);case"TGeoCompositeShape":return a.GEO.createComposite(g,f);case"TGeoShapeAssembly":break}}catch(h){var d="";if(h.stack!==undefined){d=h.stack.split("\n")[0];if(d.indexOf(h.message)>=0){d=h.stack.split("\n")[1]}else{d=" at: "+d}}a.GEO.warn(g._typename+" err: "+h.message+d)}return f<0?0:null};a.GEO.CreateProjectionMatrix=function(e){var d=new b.Matrix4();e.updateMatrixWorld();e.matrixWorldInverse.getInverse(e.matrixWorld);d.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);return d};a.GEO.CreateFrustum=function(e){if(!e){return null}if(e instanceof b.PerspectiveCamera){e=a.GEO.CreateProjectionMatrix(e)}var d=new b.Frustum();d.setFromMatrix(e);d.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);d.test=new b.Vector3(0,0,0);d.CheckShape=function(j,h){var l=this.test,f=this.corners.length,g=this.corners,k;for(k=0;k<f;k+=3){l.x=g[k]*h.fDX;l.y=g[k+1]*h.fDY;l.z=g[k+2]*h.fDZ;if(this.containsPoint(l.applyMatrix4(j))){return true}}return false};d.CheckBox=function(g){var h=this.test,f=0;h.set(g.min.x,g.min.y,g.min.z);if(this.containsPoint(h)){f++}h.set(g.min.x,g.min.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.min.x,g.max.y,g.min.z);if(this.containsPoint(h)){f++}h.set(g.min.x,g.max.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.max.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.min.y,g.max.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.max.y,g.min.z);if(this.containsPoint(h)){f++}h.set(g.max.x,g.max.y,g.max.z);if(this.containsPoint(h)){f++}return f>5};return d};a.GEO.VisibleByCamera=function(j,g,f){var k=new b.Frustum();var d=new b.Matrix4();j.updateMatrixWorld();j.matrixWorldInverse.getInverse(j.matrixWorld);d.multiplyMatrices(j.projectionMatrix,j.matrixWorldInverse);k.setFromMatrix(d);var e=[new b.Vector3(f.fDX/2,f.fDY/2,f.fDZ/2),new b.Vector3(f.fDX/2,f.fDY/2,-f.fDZ/2),new b.Vector3(f.fDX/2,-f.fDY/2,f.fDZ/2),new b.Vector3(f.fDX/2,-f.fDY/2,-f.fDZ/2),new b.Vector3(-f.fDX/2,f.fDY/2,f.fDZ/2),new b.Vector3(-f.fDX/2,f.fDY/2,-f.fDZ/2),new b.Vector3(-f.fDX/2,-f.fDY/2,f.fDZ/2),new b.Vector3(-f.fDX/2,-f.fDY/2,-f.fDZ/2)];for(var h=0;h<e.length;h++){if(k.containsPoint(e[h].applyMatrix4(g))){return true}}return false};a.GEO.numGeometryFaces=function(e){if(!e){return 0}if(e instanceof c.Geometry){return e.tree.numPolygons()}if(e.type=="BufferGeometry"){var d=e.getAttribute("position");return d?d.count/3:0}if(e&&e.polygons){return e.polygons.length}return e.faces.length};a.GEO.numGeometryVertices=function(e){if(!e){return 0}if(e instanceof c.Geometry){return e.tree.numPolygons()*3}if(e.type=="BufferGeometry"){var d=e.getAttribute("position");return d?d.count:0}if(e&&e.polygons){return e.polygons.length*4}return e.vertices.length};a.GEO.ClonedNodes=function(e,d){this.toplevel=true;this.name_prefix="";if(e){if(e._geoh){this.toplevel=false}this.CreateClones(e)}else{if(d){this.nodes=d}}};a.GEO.ClonedNodes.prototype.GetNodeShape=function(d){if(!this.origin||!this.nodes){return null}var e=this.origin[d],f=this.nodes[d];if(!e||!f){return null}if(f.kind===0){if(e.fVolume){return e.fVolume.fShape}}else{return e.fShape}return null};a.GEO.ClonedNodes.prototype.Cleanup=function(d,e){if(d){for(var f=0;f<d.length;++f){delete d[f].stack;d[f]=undefined}}if(e){for(var f=0;f<e.length;++f){delete e[f].geom;e[f]=undefined}}if(this.nodes){for(var f=0;f<this.nodes.length;++f){delete this.nodes[f].chlds}}delete this.nodes;delete this.origin;delete this.sortmap};a.GEO.ClonedNodes.prototype.CreateClones=function(j,d,g){if(!d){this.origin=[];d=1;g=a.GEO.NodeKind(j)}if((g<0)||!j||("_refid" in j)){return}j._refid=this.origin.length;this.origin.push(j);var s=null;if(g===0){s=(j.fVolume&&j.fVolume.fNodes)?j.fVolume.fNodes.arr:null}else{s=j.fElements?j.fElements.arr:null}if(s!==null){for(var l=0;l<s.length;++l){this.CreateClones(s[l],d+1,g)}}if(d>1){return}this.nodes=[];var r=[];for(var e=0;e<this.origin.length;++e){var j=this.origin[e];var f={id:e,kind:g,vol:0,nfaces:0,numvischld:1,idshift:0};this.nodes.push(f);r.push(f)}for(var e=0;e<this.origin.length;++e){var j=this.origin[e],p=this.nodes[e];var s=null,m=null;if(g===1){m=j.fShape;if(j.fElements){s=j.fElements.arr}}else{if(j.fVolume){m=j.fVolume.fShape;if(j.fVolume.fNodes){s=j.fVolume.fNodes.arr}}}var q=a.GEO.getNodeMatrix(g,j);if(q){p.matrix=q.elements;if(p.matrix[0]===1){var o=true;for(var h=1;(h<p.matrix.length)&&o;++h){o=(p.matrix[h]===((h===5)||(h===10)||(h===15)?1:0))}if(o){delete p.matrix}}}if(m){p.fDX=m.fDX;p.fDY=m.fDY;p.fDZ=m.fDZ;p.vol=m.fDX*m.fDY*m.fDZ;if(m._nfaces===undefined){m._nfaces=a.GEO.createGeometry(m,-1)}p.nfaces=m._nfaces;if(p.nfaces<=0){p.vol=0}}if(!s){continue}p.chlds=new Int32Array(s.length);for(var h=0;h<s.length;++h){p.chlds[h]=s[h]._refid}}for(var e=0;e<this.origin.length;++e){delete this.origin[e]._refid}r.sort(function(k,i){return i.vol-k.vol});this.sortmap=new Int32Array(this.nodes.length);for(var e=0;e<this.nodes.length;++e){this.sortmap[e]=r[e].id}};a.GEO.ClonedNodes.prototype.MarkVisisble=function(k,f,h){if(!this.nodes){return 0}var d=0,e=h&&(h.length===this.nodes.length);if(!e&&!this.origin){return 0}for(var j=0;j<this.nodes.length;++j){var i=this.nodes[j];i.vis=false;i.numvischld=1;i.idshift=0;delete i.depth;if(e){i.vis=h[j].vis;if(h[j].depth!==undefined){i.depth=h[j].depth}if(i.vis){d++}continue}var g=this.origin[j];if(i.kind===0){if(g.fVolume){if(k){i.vis=a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisOnScreen);if(f){a.GEO.SetBit(g.fVolume,a.GEO.BITS.kVisNone,false);a.GEO.SetBit(g.fVolume,a.GEO.BITS.kVisThis,i.vis);a.GEO.SetBit(g.fVolume,a.GEO.BITS.kVisDaughters,true)}}else{i.vis=!a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisThis);if(!a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisDaughters)){i.depth=a.GEO.TestBit(g.fVolume,a.GEO.BITS.kVisOneLevel)?1:0}}}}else{i.vis=g.fRnrSelf;if((j===0)&&(this.nodes.length===1)){i.vis=true}}if((i.vol<=0)||(i.nfaces<=0)){i.vis=false}if(i.vis){d++}}return d};a.GEO.ClonedNodes.prototype.GetVisibleFlags=function(){var d=[];for(var f=0;f<this.nodes.length;++f){var e={vis:this.nodes[f].vis};if("depth" in this.nodes[f]){e.depth=this.nodes[f].depth}d.push(e)}return d};a.GEO.ClonedNodes.prototype.ScanVisible=function(d,l){if(!this.nodes){return 0}if(l===undefined){l=99999;if(!d){d={}}d.stack=new Int32Array(100);d.nodeid=0;d.counter=0;d.last=0;d.CopyStack=function(i){var m={nodeid:this.nodeid,seqid:this.counter,stack:new Int32Array(this.last)};if(i){m.factor=i}for(var o=0;o<this.last;++o){m.stack[o]=this.stack[o+1]}return m};if(d.domatrix){d.matrices=[];d.mpool=[new b.Matrix4()];d.getmatrix=function(){return this.matrices[this.last]}}}var h=0,k=this.nodes[d.nodeid];if(d.domatrix){if(!d.mpool[d.last+1]){d.mpool[d.last+1]=new b.Matrix4()}var g=(d.last>0)?d.matrices[d.last-1]:new b.Matrix4();if(k.matrix){d.matrices[d.last]=d.mpool[d.last].fromArray(g.elements);d.matrices[d.last].multiply(d.mpool[d.last+1].fromArray(k.matrix))}else{d.matrices[d.last]=g}}if(k.vis&&(l>=0)){if(!d.func||d.func(k)){h++}}d.counter++;if((k.depth!==undefined)&&(l>k.depth)){l=k.depth}if(d.last>d.stack.length-2){throw"stack capacity is not enough "+d.stack.length}if(k.chlds&&(k.numvischld>0)){var f=d.counter,j=0;d.last++;for(var e=0;e<k.chlds.length;++e){d.nodeid=k.chlds[e];d.stack[d.last]=e;j+=this.ScanVisible(d,l-1)}d.last--;h+=j;if(j===0){k.numvischld=0;k.idshift=d.counter-f}}else{d.counter+=k.idshift}if(d.last===0){delete d.last;delete d.stack;delete d.CopyStack;delete d.counter;delete d.matrices;delete d.mpool;delete d.getmatrix}return h};a.GEO.ClonedNodes.prototype.ResolveStack=function(d,f){var g={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};if(f){g.matrix=new b.Matrix4();if(g.node.matrix){g.matrix.fromArray(g.node.matrix)}}if(this.origin){g.obj=this.origin[0]}if(d){for(var e=0;e<d.length;++e){g.id=g.node.chlds[d[e]];g.node=this.nodes[g.id];if(this.origin){g.obj=this.origin[g.id];if(g.obj.fName!==""){if(g.name.length>0){g.name+="/"}g.name+=g.obj.fName}}if(f&&g.node.matrix){g.matrix.multiply(new b.Matrix4().fromArray(g.node.matrix))}}}return g};a.GEO.ClonedNodes.prototype.FindStackByName=function(o){if(!this.origin){return null}var j=o.split("/"),h=0,m=[],l=this.origin[0];if(!l||(l.fName!==j[0])){return null}for(var e=1;e<j.length;++e){var f=this.nodes[h];if(!f.chlds){return null}for(var g=0;g<f.chlds.length;++g){var d=f.chlds[g];var i=this.origin[d];if(i&&(i.fName===j[e])){m.push(g);h=d;break}}if(m.length===e-1){return null}}return m};a.GEO.ClonedNodes.prototype.CreateObject3D=function(l,m,r){var f=this.nodes[0],p=m,d=(typeof r=="object")||(r==="force");for(var k=0;k<=l.length;++k){var g=(k>0)?l[k-1]:0;if(k>0){f=this.nodes[f.chlds[g]]}var j=undefined;if(p.children){for(var h=0;h<p.children.length;++h){if(p.children[h].nchld===g){j=p.children[h];break}}}if(j){p=j;continue}if(!d){return null}j=new b.Object3D();if(f.matrix){j.matrix.fromArray(f.matrix);j.matrix.decompose(j.position,j.quaternion,j.scale)}j.nchld=g;p.add(j);if((k==0)&&(typeof r=="object")&&r.scale){if((r.scale.x<0)||(r.scale.y<0)||(r.scale.z<0)){j.scale.copy(r.scale);j.updateMatrix()}}j.updateMatrixWorld();p=j}if((r==="mesh")||(r==="delete_mesh")){var q=null;if(p){for(var e=0;(e<p.children.length)&&!q;++e){var o=p.children[e];if((o.type==="Mesh")&&(o.nchld===undefined)){q=o}}}if((r==="mesh")||!q){return q}while(q&&(q!==m)){p=q.parent;p.remove(q);q=(p.children.length==0)?p:null}return null}return p};a.GEO.ClonedNodes.prototype.GetVolumeBoundary=function(h,l,k){if(!this.sortmap){console.error("sorting map not exisits");return{min:0,max:1}}var d,j,g=0,i=0;for(var f=0;(f<this.sortmap.length)&&(g<k)&&(i<l);++f){var e=this.sortmap[f];if(h[e]===0){continue}j=this.nodes[e];if(!d){d=j}g+=h[e];i+=h[e]*j.nfaces}if(!j){console.error("no volumes selected");return{min:0,max:1}}return{min:j.vol,max:d.vol}};a.GEO.ClonedNodes.prototype.CollectVisibles=function(l,m,j){if(!j){j=l/100}var p={facecnt:0,viscnt:new Int32Array(this.nodes.length),func:function(n){this.facecnt+=n.nfaces;this.viscnt[n.id]++;return true}};for(var g=0;g<p.viscnt.length;++g){p.viscnt[g]=0}var k=this.ScanVisible(p),q=0,d=0,o=-1,i=10;if(p.facecnt>l){var h=l*(m?0.8:1),f=j*(m?0.8:1);var e=this.GetVolumeBoundary(p.viscnt,h,f);q=e.min;d=e.max;if(m){p.domatrix=true;p.frustum=m;p.totalcam=0;p.func=function(n){if(n.vol<=q){if(this.frustum.CheckShape(this.getmatrix(),n)){this.viscnt[n.id]++;this.totalcam+=n.nfaces}}return true};for(var g=0;g<p.viscnt.length;++g){p.viscnt[g]=0}this.ScanVisible(p);if(p.totalcam>l*0.2){o=this.GetVolumeBoundary(p.viscnt,l*0.2,j*0.2).min}else{o=0}i=d/((o>0)?(o>0):q)}}p.items=[];p.func=function(n){if(n.vol>q){this.items.push(this.CopyStack())}else{if((o>=0)&&(n.vol>o)){if(this.frustum.CheckShape(this.getmatrix(),n)){this.items.push(this.CopyStack(i))}}}return true};this.ScanVisible(p);return{lst:p.items,complete:q===0}};a.GEO.ClonedNodes.prototype.MergeVisibles=function(h,g){var e=0,d=[];for(var f=0;(f<h.length)&&(e<g.length);++f){while((e<g.length)&&(g[e].seqid<h[f].seqid)){d.push(g[e++])}if((e<g.length)&&(g[e].seqid===h[f].seqid)){if(g[e].done){h[f].done=true}e++}}while(e<g.length){d.push(g[e++])}return d};a.GEO.ClonedNodes.prototype.CollectShapes=function(d){var e=[];for(var g=0;g<d.length;++g){var j=d[g];var f=this.GetNodeShape(j.nodeid);if(!f){continue}if(f._id===undefined){f._id=e.length;e.push({id:f._id,shape:f,vol:this.nodes[j.nodeid].vol,refcnt:1,factor:1,ready:false})}else{e[f._id].refcnt++}j.shape=e[f._id];if(j.factor&&(j.factor>j.shape.factor)){j.shape.factor=j.factor}}e.sort(function(l,i){return i.vol*i.factor-l.vol*l.factor});for(var k=0;k<e.length;++k){var h=e[k];h.id=k;delete h.shape._id}for(var g=0;g<d.length;++g){var j=d[g];j.shapeid=j.shape.id;delete j.shape}return e};a.GEO.ClonedNodes.prototype.MergeShapesLists=function(e,f){if(!e){return f}for(var g=0;g<e.length;++g){var d=e[g];d.shape._geom=d.geom;delete d.geom;if(d.geomZ!==undefined){d.shape._geomZ=d.geomZ;delete d.geomZ}}for(var g=0;g<f.length;++g){var d=f[g];if(d.shape._geom!==undefined){d.geom=d.shape._geom;delete d.shape._geom}if(d.shape._geomZ!==undefined){d.geomZ=d.shape._geomZ;delete d.shape._geomZ}}for(var g=0;g<e.length;++g){var d=e[g];delete d.shape._geom;delete d.shape._geomZ}return f};a.GEO.ClonedNodes.prototype.BuildShapes=function(i,h,k){var g=0,e=new Date().getTime(),j={done:false,shapes:0,faces:0,notusedshapes:0};for(var f=0;f<i.length;++f){var l=i[f];if(j.done){l.ready=true;continue}if(!l.ready){if(l.geom===undefined){l.geom=a.GEO.createGeometry(l.shape);if(l.geom){g++}}l.nfaces=a.GEO.numGeometryFaces(l.geom);l.ready=true}j.shapes++;if(!l.used){j.notusedshapes++}j.faces+=l.nfaces*l.refcnt;if(j.faces>=h){j.done=true}else{if((g>0.01*i.length)&&(k!==undefined)){var d=new Date().getTime();if(d-e>k){return j}}}}j.done=true;return j};return a}));